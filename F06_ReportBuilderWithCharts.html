<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OneGov FIT Market - React with Advanced JSON Architecture</title>
    
    <!-- React 18 CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- EXACT CSS FROM ORIGINAL F17_CarouselApp.html -->
    <style>
        :root {
            --dark-blue: #0a2240;
            --blue: #144673;
            --light-blue: #3a6ea5;
            --orange: #f47920;
            --bg-light: #f4f6f7;
            --text-light: #ffffff;
            --text-dark: #333333;
            --shadow: 0 2px 8px rgba(0,0,0,0.12);
            --border-radius: 8px;
            --green: #22c55e;
            --red: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-dark);
            min-height: 100vh;
            font-size: 16px;
        }
        
        /* Navigation Styles */
        .navbar {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blue) 100%);
            color: var(--text-light);
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            width: 100%;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--orange) 0%, #ff8c42 100%);
            color: #ffffff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(244, 121, 32, 0.3);
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
        }

        .brand-tagline {
            font-size: 0.9rem;
            color: #8bb5d1;
            font-weight: 300;
        }

        .nav-items {
            display: flex;
            gap: 0.5rem;
        }

        .nav-item {
            background: none;
            border: none;
            color: #ffffff;
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .nav-item.active {
            background-color: var(--orange);
            box-shadow: 0 2px 6px rgba(244, 121, 32, 0.3);
        }

        /* Main Content */
        .main-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }


        /* KPI Carousel Styles - EXACT MATCH */
        .kpi-carousel-wrapper {
            position: relative;
            margin-bottom: 32px;
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .kpi-carousel {
            position: relative;
            overflow: hidden;
            width: 100%;
            padding: 40px 20px;
        }

        .kpi-container {
            display: flex;
            transition: transform 0.5s ease-in-out;
            gap: 20px;
            will-change: transform;
        }

        .kpi-slide {
            flex: 0 0 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            justify-content: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .kpi-card {
            background: white;
            padding: 20px 20px 40px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            height: 200px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--orange), #ff6b35);
            opacity: 0.1;
            border-radius: 0 0 0 60px;
        }

        .kpi-card:hover {
            border-color: var(--orange);
            box-shadow: 0 4px 8px rgba(244, 121, 32, 0.2);
        }

        .kpi-title {
            font-size: 0.9rem;
            color: var(--blue);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .kpi-value {
            font-size: 2.1rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .kpi-chart {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 6px;
            margin-top: 8px;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            min-height: 120px;
        }

        /* Chart specific styles matching original */
        .tier-distribution-chart, .contract-distribution-chart, .top-vendors-chart, .fiscal-year-chart, .reseller-chart, .discount-chart, .kpi-chart-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 8px;
        }

        .tier-row, .contract-row, .vendor-row, .fy-row, .reseller-row, .discount-row, .chart-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
        }

        .tier-label, .contract-label, .vendor-label, .fy-label, .reseller-label, .discount-label {
            font-weight: 600;
            color: var(--blue);
            width: 45px;
            text-align: right;
            font-size: 0.8rem;
        }

        .vendor-label, .reseller-label, .discount-label {
            width: 55px;
            font-size: 0.75rem;
        }

        .fy-label {
            width: 35px;
            font-size: 0.75rem;
        }

        .tier-bar-container, .contract-bar-container, .vendor-bar-container, .fy-bar-container, .reseller-bar-container, .discount-bar-container {
            flex: 1;
            height: 18px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .tier-bar, .contract-bar, .vendor-bar, .fy-bar, .reseller-bar, .discount-bar {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px;
            border-radius: 3px;
            transition: width 0.3s ease;
            background: linear-gradient(135deg, var(--orange), #ff6b35);
        }

        .tier-count, .contract-value, .vendor-value, .fy-value, .reseller-value, .discount-value {
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .mini-chart {
            display: flex;
            align-items: end;
            height: 32px;
            gap: 2px;
            margin-bottom: 8px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, var(--dark-blue), var(--light-blue));
            border-radius: 2px 2px 0 0;
            min-height: 4px;
            opacity: 0.8;
        }

        .chart-label {
            font-size: 0.7rem;
            color: var(--blue);
            opacity: 0.8;
        }

        /* Entity Grid - EXACT MATCH */
        .entity-grid-container {
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
            padding: 20px;
            margin-top: 32px;
            scrollbar-width: thin;
            scrollbar-color: var(--orange) #f1f1f1;
        }

        .entity-grid-container::-webkit-scrollbar {
            width: 8px;
        }

        .entity-grid-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .entity-grid-container::-webkit-scrollbar-thumb {
            background: var(--orange);
            border-radius: 4px;
        }

        .entity-grid-container::-webkit-scrollbar-thumb:hover {
            background: #e56a0b;
        }

        .entity-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            max-width: 100%;
        }
        
        .entity-card {
            background: white;
            border-radius: 6px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
            height: 480px;
            position: relative;
            width: 100%;
            cursor: pointer;
        }
        
        .entity-card.onegov {
            border: 2px solid var(--orange);
            box-shadow: 0 0 15px rgba(244, 121, 32, 0.3);
        }
        
        .entity-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .entity-header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blue) 100%);
            color: white;
            padding: 6px 8px;
            position: relative;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-left-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }
        
        .entity-type-symbol {
            min-width: 50px;
            height: 18px;
            background: var(--orange);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
            padding: 0 4px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .entity-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: 0.2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            text-align: center;
            color: var(--orange);
        }
        
        .entity-tier-badge {
            background: var(--orange);
            color: white;
            padding: 2px 5px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.2px;
            flex-shrink: 0;
        }

        .entity-card-body {
            padding: 6px;
            height: 460px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .obligated-amount {
            background: #f8f9fa;
            padding: 4px 6px;
            border-radius: 3px;
            text-align: center;
        }

        .amount-label {
            font-size: 0.8rem;
            color: var(--blue);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            margin-bottom: 1px;
        }

        .amount-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark-blue);
        }

        /* KPI Navigation */
        .kpi-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .kpi-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--blue);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .kpi-nav-btn:hover {
            background: var(--dark-blue);
            transform: scale(1.05);
        }

        .kpi-nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .kpi-indicators {
            display: flex;
            gap: 8px;
        }

        .kpi-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }

        .kpi-indicator.active {
            background: var(--orange);
            transform: scale(1.3);
        }

        /* Chart Styles - Clean and simple */
        .chart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .chart-item:last-child {
            border-bottom: none;
        }

        .chart-item:hover {
            background: #f9f9f9;
            border-radius: 3px;
            padding-left: 4px;
        }

        .chart-label {
            font-weight: 500;
            color: #444;
            flex: 1;
            margin-right: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.65rem;
        }

        .chart-value {
            font-weight: 600;
            color: var(--orange);
            font-size: 0.65rem;
        }

        .chart-agencies {
            color: #777;
            font-size: 0.6rem;
            margin-left: 4px;
        }

        .vendor-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            padding: 2px 0;
        }

        .vendor-label {
            width: 120px;
            font-size: 0.7rem;
            color: var(--text-dark);
            text-align: left;
            margin-right: 8px;
        }

        .vendor-bar-container {
            flex: 1;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-right: 6px;
            position: relative;
        }

        .vendor-bar {
            height: 100%;
            border-radius: 4px;
        }

        .vendor-value {
            font-size: 0.65rem;
            color: var(--orange);
            font-weight: 600;
            min-width: 45px;
            text-align: right;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            margin: 2rem 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">Loading OneGov FIT Market...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // ===== COMPREHENSIVE JSON ARCHITECTURE FOR REUSABILITY =====
        
        const JSONProcessor = {
            // Universal column processors - work across ALL sheets (OEM/Vendor/Agency)
            
            // Column A: Entity Identifier (DUNS/UEI/Agency Code)
            processColumnA_Identifier: (entities) => {
                return entities.map(entity => ({
                    id: entity.duns || entity.uei || entity.agencyCode || entity.id,
                    name: entity.name,
                    type: entity.type || 'unknown'
                }));
            },

            // Column D: Obligations JSON - Universal processor
            processColumnD_Obligations: (entities) => {
                const result = {
                    totalObligations: 0,
                    fiscalYearTotals: {},
                    entitySummaries: [],
                    averagePerEntity: 0
                };

                entities.forEach(entity => {
                    const json = JSONProcessor.extractJSON(entity, 'obligations');
                    if (!json) return;

                    // Extract total obligations
                    const total = json.total_obligated || 0;
                    result.totalObligations += total;

                    // Extract fiscal year data
                    if (json.fiscal_year_obligations) {
                        Object.entries(json.fiscal_year_obligations).forEach(([year, amount]) => {
                            result.fiscalYearTotals[year] = (result.fiscalYearTotals[year] || 0) + amount;
                        });
                    }

                    // Entity summary
                    result.entitySummaries.push({
                        name: entity.name,
                        total,
                        fiscalYears: json.fiscal_year_obligations || {}
                    });
                });

                result.averagePerEntity = result.totalObligations / entities.length;
                return result;
            },

            // Column E: Small Business JSON - Universal processor
            processColumnE_SmallBusiness: (entities) => {
                const result = {
                    totalSmallBusiness: 0,
                    totalOther: 0,
                    smallBusinessPercentage: 0,
                    breakdown: {},
                    entityBreakdown: []
                };

                entities.forEach(entity => {
                    const json = JSONProcessor.extractJSON(entity, 'smallBusiness');
                    if (!json) return;

                    Object.entries(json).forEach(([type, data]) => {
                        const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                        
                        if (type.toLowerCase().includes('small')) {
                            result.totalSmallBusiness += amount;
                            result.breakdown[type] = (result.breakdown[type] || 0) + amount;
                        } else {
                            result.totalOther += amount;
                            result.breakdown[type] = (result.breakdown[type] || 0) + amount;
                        }
                    });

                    result.entityBreakdown.push({
                        name: entity.name,
                        smallBusiness: json
                    });
                });

                const total = result.totalSmallBusiness + result.totalOther;
                result.smallBusinessPercentage = total > 0 ? (result.totalSmallBusiness / total * 100) : 0;
                return result;
            },

            // Column F: SUM Tier JSON - Universal processor
            processColumnF_SumTier: (entities) => {
                const result = {
                    tierDistribution: {},
                    totalEntities: entities.length,
                    tierBreakdown: [],
                    tierTotals: {}
                };

                entities.forEach(entity => {
                    const json = JSONProcessor.extractJSON(entity, 'sumTier', ['oneGovTier']);
                    if (!json) return;

                    // Handle different tier structures
                    const tierData = json.tier_details || json.summary?.tier_distribution || json;

                    Object.entries(tierData).forEach(([tier, data]) => {
                        const value = typeof data === 'object' ? data.total || 0 : data || 0;
                        result.tierTotals[tier] = (result.tierTotals[tier] || 0) + value;
                        result.tierDistribution[tier] = (result.tierDistribution[tier] || 0) + 1;
                    });

                    result.tierBreakdown.push({
                        name: entity.name,
                        tier: entity.tier,
                        tierData: json
                    });
                });

                return result;
            },

            // Column H: Contract Vehicle JSON - Universal processor  
            processColumnH_ContractVehicle: (entities) => {
                const result = {
                    vehicles: {},
                    totalContracts: 0,
                    vehicleBreakdown: [],
                    topVehicles: []
                };

                entities.forEach(entity => {
                    const json = JSONProcessor.extractJSON(entity, 'contractVehicle');
                    if (!json) return;

                    Object.entries(json).forEach(([vehicle, data]) => {
                        const value = typeof data === 'object' ? data.total || 0 : data || 0;
                        result.vehicles[vehicle] = (result.vehicles[vehicle] || 0) + value;
                        result.totalContracts += value;
                    });

                    result.vehicleBreakdown.push({
                        name: entity.name,
                        vehicles: json
                    });
                });

                result.topVehicles = Object.entries(result.vehicles)
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                return result;
            },

            // Column I: Funding Department JSON - Universal processor
            processColumnI_FundingDepartment: (entities) => {
                const result = {
                    departments: {},
                    totalFunding: 0,
                    departmentBreakdown: [],
                    topDepartments: []
                };

                entities.forEach(entity => {
                    const json = JSONProcessor.extractJSON(entity, 'fundingDepartment');
                    if (!json) return;

                    Object.entries(json).forEach(([dept, data]) => {
                        const value = typeof data === 'object' ? data.total || data.obligations || 0 : data || 0;
                        result.departments[dept] = (result.departments[dept] || 0) + value;
                        result.totalFunding += value;
                    });
                });

                result.topDepartments = Object.entries(result.departments)
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                return result;
            },

            // Column K: Reference PIID JSON - Universal processor
            processColumnK_RefPiid: (entities) => {
                const result = {
                    refPiids: {},
                    totalValue: 0,
                    piidBreakdown: [],
                    topRefPiids: [],
                    agencyUsage: {}
                };

                entities.forEach(entity => {
                    const json = JSONProcessor.extractJSON(entity, 'topRefPiid', ['topPIIDs', 'contractVehicle']);
                    if (!json?.top_10_reference_piids) return;

                    json.top_10_reference_piids.forEach(piid => {
                        if (!piid.reference_piid || !piid.dollars_obligated) return;
                        
                        const key = piid.reference_piid;
                        if (!result.refPiids[key]) {
                            result.refPiids[key] = { 
                                value: 0, 
                                agencies: 0, 
                                percentage: 0,
                                entities: []
                            };
                        }
                        result.refPiids[key].value += piid.dollars_obligated;
                        result.refPiids[key].agencies += piid.agencies_using || 0;
                        result.refPiids[key].percentage = piid.percentage_of_total || '';
                        result.refPiids[key].entities.push(entity.name);
                        result.totalValue += piid.dollars_obligated;
                    });
                });

                result.topRefPiids = Object.entries(result.refPiids)
                    .map(([name, data]) => ({ name, ...data }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                return result;
            },

            // Column L: Individual PIID JSON - Universal processor
            processColumnL_IndividualPiid: (entities) => {
                const result = {
                    piids: {},
                    totalValue: 0,
                    piidBreakdown: [],
                    topPiids: []
                };

                entities.forEach(entity => {
                    const json = JSONProcessor.extractJSON(entity, 'topPiid', ['contractVehicle', 'topContracts']);
                    
                    let piidArray = json?.top_10_piids || json?.top_10_reference_piids;
                    if (!piidArray) return;

                    piidArray.forEach(piid => {
                        const key = piid.piid || piid.reference_piid;
                        if (!key || !piid.dollars_obligated) return;
                        
                        if (!result.piids[key]) {
                            result.piids[key] = { 
                                value: 0, 
                                agencies: 0, 
                                percentage: 0,
                                entities: []
                            };
                        }
                        result.piids[key].value += piid.dollars_obligated;
                        result.piids[key].agencies += piid.agencies_using || 0;
                        result.piids[key].percentage = piid.percentage_of_total || '';
                        result.piids[key].entities.push(entity.name);
                        result.totalValue += piid.dollars_obligated;
                    });
                });

                result.topPiids = Object.entries(result.piids)
                    .map(([name, data]) => ({ name, ...data }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                return result;
            },

            // Column O: AI Product JSON - Universal processor
            processColumnO_AiProduct: (entities) => {
                const result = {
                    products: {},
                    totalValue: 0,
                    productBreakdown: [],
                    topProducts: [],
                    fiscalYearBreakdown: {}
                };

                entities.forEach(entity => {
                    const json = JSONProcessor.extractJSON(entity, 'aiProduct', ['aiProducts', 'aiCategory']);
                    if (!json?.fiscal_year_summaries) return;

                    Object.entries(json.fiscal_year_summaries).forEach(([year, yearData]) => {
                        if (!yearData.product_summaries) return;
                        
                        if (!result.fiscalYearBreakdown[year]) {
                            result.fiscalYearBreakdown[year] = {};
                        }

                        Object.entries(yearData.product_summaries).forEach(([productName, data]) => {
                            const value = data.total_obligations || 0;
                            
                            if (!result.products[productName]) {
                                result.products[productName] = { 
                                    value: 0,
                                    entities: [],
                                    fiscalYears: {}
                                };
                            }
                            result.products[productName].value += value;
                            result.products[productName].entities.push(entity.name);
                            result.products[productName].fiscalYears[year] = 
                                (result.products[productName].fiscalYears[year] || 0) + value;
                            result.totalValue += value;

                            result.fiscalYearBreakdown[year][productName] = 
                                (result.fiscalYearBreakdown[year][productName] || 0) + value;
                        });
                    });
                });

                result.topProducts = Object.entries(result.products)
                    .map(([name, data]) => ({ name, ...data }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                return result;
            },

            // Column V: Funding Agency JSON - Universal processor
            processColumnV_FundingAgency: (entities) => {
                const result = {
                    agencies: {},
                    totalFunding: 0,
                    agencyBreakdown: [],
                    topAgencies: []
                };

                entities.forEach(entity => {
                    const json = JSONProcessor.extractJSON(entity, 'fundingAgency');
                    if (!json) return;

                    // Check if it's the nested structure
                    const agencyData = json.top_10_agency_summaries || json;

                    Object.entries(agencyData).forEach(([agencyName, data]) => {
                        if (typeof data === 'object') {
                            const value = data.total || data.obligations || 0;
                            result.agencies[agencyName] = (result.agencies[agencyName] || 0) + value;
                            result.totalFunding += value;
                        }
                    });
                });

                result.topAgencies = Object.entries(result.agencies)
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);

                return result;
            },

            // Helper function for JSON extraction
            extractJSON: (entity, primaryField, fallbackFields = []) => {
                const fields = [primaryField, ...fallbackFields];
                
                for (const field of fields) {
                    const data = entity[field];
                    if (!data) continue;
                    
                    try {
                        return typeof data === 'string' ? JSON.parse(data) : data;
                    } catch (e) {
                        console.warn(`Invalid JSON in ${field} for ${entity.name}:`, e);
                    }
                }
                return null;
            }
        };

        // ===== EXACT CHART FUNCTIONS FROM F17_CarouselApp.html =====
        
        const createRefPiidChart = (refPiidData) => {
            if (!refPiidData || Object.keys(refPiidData).length === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No Ref PIID data available</div></div>';
            }
            
            // Convert to array and sort by value
            const piids = [];
            for (const piid in refPiidData) {
                if (refPiidData.hasOwnProperty(piid) && refPiidData[piid].value > 0) {
                    piids.push({
                        piid: piid,
                        value: refPiidData[piid].value,
                        agencies: refPiidData[piid].agencies,
                        percentage: refPiidData[piid].percentage
                    });
                }
            }
            
            // Sort by value descending and take top 5
            piids.sort((a, b) => b.value - a.value);
            piids.splice(5);
            
            if (piids.length === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No valid Ref PIID data</div></div>';
            }
            
            let html = '<div class="kpi-chart" style="padding: 6px;">';
            const maxValue = piids[0].value; // Highest value for scaling
            
            for (let i = 0; i < piids.length; i++) {
                const item = piids[i];
                const width = (item.value / maxValue * 85); // Scale to 85% max width
                
                html += '<div style="display: flex; align-items: center; margin: 2px 0; height: 14px;">';
                
                // Full PIID on left (up to 15 chars for Reference PIIDs)
                const displayPiid = item.piid.length > 15 ? item.piid.substring(0, 15) : item.piid;
                html += '<span style="font-size: 0.65rem; color: var(--blue); width: 95px; text-align: left; font-weight: 600; overflow: hidden; white-space: nowrap;">' + displayPiid + '</span>';
                
                // Smaller bar container with reduced max width
                html += '<div style="flex: 1; height: 8px; background: #f0f0f0; border-radius: 4px; margin: 0 4px; overflow: hidden; max-width: 45px;">';
                html += '<div style="width: ' + width + '%; height: 100%; background: linear-gradient(90deg, var(--orange), #ff8c42); border-radius: 4px;"></div>';
                html += '</div>';
                
                // Value and agencies pushed more to the right
                html += '<div style="display: flex; flex-direction: column; align-items: flex-end; width: 65px; margin-left: 8px;">';
                html += '<span style="font-size: 0.65rem; color: var(--text-dark); font-weight: 600; line-height: 1;">' + formatCurrencyShort(item.value) + '</span>';
                html += '<span style="font-size: 0.6rem; color: var(--blue); line-height: 1;">' + item.agencies + ' agency</span>';
                html += '</div>';
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        };

        const createPiidChart = (piidData) => {
            if (!piidData || Object.keys(piidData).length === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No PIID data available</div></div>';
            }
            
            // Convert to array and sort by value
            const piids = [];
            for (const piid in piidData) {
                if (piidData.hasOwnProperty(piid) && piidData[piid].value > 0) {
                    piids.push({
                        piid: piid,
                        value: piidData[piid].value,
                        agencies: piidData[piid].agencies,
                        percentage: piidData[piid].percentage
                    });
                }
            }
            
            // Sort by value descending and take top 5
            piids.sort((a, b) => b.value - a.value);
            piids.splice(5);
            
            if (piids.length === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No valid PIID data</div></div>';
            }
            
            let html = '<div class="kpi-chart" style="padding: 6px;">';
            const maxValue = piids[0].value; // Highest value for scaling
            
            for (let i = 0; i < piids.length; i++) {
                const item = piids[i];
                const width = (item.value / maxValue * 85); // Scale to 85% max width
                
                html += '<div style="display: flex; align-items: center; margin: 2px 0; height: 14px;">';
                
                // Full PIID on left (up to 15 chars for PIIDs)
                const displayPiid = item.piid.length > 15 ? item.piid.substring(0, 15) : item.piid;
                html += '<span style="font-size: 0.55rem; color: var(--blue); width: 95px; text-align: left; font-weight: 600; overflow: hidden; white-space: nowrap;">' + displayPiid + '</span>';
                
                // Smaller BLUE bar container with reduced max width
                html += '<div style="flex: 1; height: 8px; background: #f0f0f0; border-radius: 4px; margin: 0 4px; overflow: hidden; max-width: 45px;">';
                html += '<div style="width: ' + width + '%; height: 100%; background: linear-gradient(90deg, #3a6ea5, #87ceeb); border-radius: 4px;"></div>';
                html += '</div>';
                
                // Value and agencies pushed more to the right
                html += '<div style="display: flex; flex-direction: column; align-items: flex-end; width: 65px; margin-left: 8px;">';
                html += '<span style="font-size: 0.65rem; color: var(--text-dark); font-weight: 600; line-height: 1;">' + formatCurrencyShort(item.value) + '</span>';
                html += '<span style="font-size: 0.6rem; color: var(--blue); line-height: 1;">' + item.agencies + ' agency</span>';
                html += '</div>';
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        };

        const createTierChart = (tierData) => {
            if (!tierData || Object.keys(tierData).length === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No tier data available</div></div>';
            }
            
            // Convert to array and sort by value
            const tiers = [];
            let total = 0;
            for (const tierName in tierData) {
                const value = tierData[tierName] || 0;
                const cleanName = cleanLabel(tierName);
                tiers.push({name: cleanName, value: value});
                total += value;
            }
            tiers.sort((a, b) => b.value - a.value);
            
            // Take top 4 tiers to match the 4 colors
            tiers.splice(4);
            
            if (total === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No tier values found</div></div>';
            }
            
            let html = '<div class="tier-pie-chart" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 4px;">';
            
            // Create colors array with specific color for Open Market
            const colors = ['#f47920', '#22c55e', '#87ceeb', '#1e3a8a'];  // Orange, Green, Light Blue, Dark Navy
            
            // Override specific colors for known types
            const getColorForSegment = (name, index) => {
                
                // For Category Obligations data (Cloud, Services, Hardware, etc.)
                if (['Cloud', 'Services', 'Hardware', 'Software', 'Network', 'Support', 'Other'].includes(name)) {
                    const categoryColors = [
                        '#3b82f6',  // Blue for Cloud
                        '#10b981',  // Green for Services
                        '#f59e0b',  // Amber for Hardware
                        '#8b5cf6',  // Purple for Software
                        '#ef4444',  // Red for Network
                        '#06b6d4',  // Cyan for Support
                        '#6b7280'   // Gray for Other
                    ];
                    const categoryIndex = ['Cloud', 'Services', 'Hardware', 'Software', 'Network', 'Support', 'Other'].indexOf(name);
                    return categoryColors[categoryIndex] || categoryColors[6];
                }
                
                // For Sum Type charts (containing "Open Market"), use dark navy for Open Market
                if (name.includes('Open Market')) {
                    return '#144673';  // Dark Navy Blue for Open Market
                }
                // For Sum Type data, check if we have sum type categories and use dark navy instead of light blue
                if (name.includes('IDIQ') || name.includes('Definite') || name.includes('Indefinite')) {
                    // This is likely Sum Type data, use dark navy instead of light blue for the 3rd color
                    const sumTypeColors = ['#f47920', '#22c55e', '#144673', '#1e3a8a'];  // Replace light blue with dark navy
                    const defaultColor = sumTypeColors[index % sumTypeColors.length];
                    return defaultColor;
                }
                const defaultColor = colors[index % colors.length];
                return defaultColor;
            };
            
            // Calculate pie segments
            const segments = [];
            let currentDegree = 0;
            
            for (let i = 0; i < tiers.length; i++) {
                const percentage = (tiers[i].value / total * 100);
                const degrees = (tiers[i].value / total * 360);
                segments.push({
                    name: tiers[i].name,
                    value: tiers[i].value,
                    percentage: percentage,
                    startDeg: currentDegree,
                    endDeg: currentDegree + degrees,
                    color: getColorForSegment(tiers[i].name, i)
                });
                currentDegree += degrees;
            }
            
            // Create conic gradient
            const gradientParts = [];
            for (let i = 0; i < segments.length; i++) {
                const seg = segments[i];
                gradientParts.push(seg.color + ' ' + seg.startDeg + 'deg ' + seg.endDeg + 'deg');
            }
            
            // Pie chart - same size as small business chart
            html += '<div style="width: 90px; height: 90px; border-radius: 50%; background: conic-gradient(' + gradientParts.join(', ') + '); border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.15);"></div>';
            
            // Legend with dollar amounts - bigger text like small business chart
            html += '<div style="display: flex; flex-direction: column; gap: 8px;">';
            for (let i = 0; i < segments.length; i++) {
                const seg = segments[i];
                html += '<div style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem;">';
                html += '<div style="width: 12px; height: 12px; background: ' + seg.color + '; border-radius: 2px;"></div>';
                html += '<span style="font-weight: 600;">' + seg.name + ' ' + formatCurrencyShort(seg.value) + ' (' + seg.percentage.toFixed(1) + '%)</span>';
                html += '</div>';
            }
            html += '</div>';
            
            html += '</div>';
            return html;
        };

        const createFunnelChart = (categoryData) => {
            if (!categoryData || Object.keys(categoryData).length === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No category data available</div></div>';
            }

            // Convert to array and sort by value (highest to lowest)
            const categories = [];
            let total = 0;
            for (const categoryName in categoryData) {
                const value = categoryData[categoryName] || 0;
                categories.push({name: categoryName, value: value});
                total += value;
            }
            categories.sort((a, b) => b.value - a.value);

            if (total === 0 || categories.length === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No valid category data</div></div>';
            }

            // Category colors - 7 distinct colors for the 7 groups
            const categoryColors = {
                'Cloud': '#87ceeb',      // Light Blue
                'Services': '#f47920',   // Orange
                'Hardware': '#22c55e',   // Green
                'Software': '#3a6ea5',   // Light Blue
                'Network': '#ef4444',    // Red
                'Support': '#9333ea',    // Purple
                'Other': '#6b7280'       // Gray
            };

            const maxValue = categories[0].value;
            const maxHeight = 120;

            let html = '<div class="kpi-chart" style="padding: 8px; min-height: 140px;">';
            
            // Main container with chart on left, legend on right
            html += '<div style="display: flex; gap: 12px; align-items: center;">';
            
            // Funnel container (upside down triangle)
            html += '<div style="display: flex; flex-direction: column; align-items: center; gap: 1px; height: ' + maxHeight + 'px; flex: 1;">';
            
            categories.forEach((category, index) => {
                const percentage = ((category.value / total) * 100).toFixed(1);
                const widthPercent = ((category.value / maxValue) * 100); // Width based on value proportion
                const segmentHeight = Math.max(8, maxHeight / categories.length - 1); // Minimum height of 8px
                const color = categoryColors[category.name] || '#6b7280';
                
                // Funnel segment (gets narrower toward bottom)
                html += '<div style="position: relative; width: ' + widthPercent + '%; height: ' + segmentHeight + 'px; background: ' + color + '; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: white; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">';
                
                // Show percentage if segment is wide enough
                if (widthPercent > 25) {
                    html += percentage + '%';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            
            // Legend on the right side
            html += '<div style="display: flex; flex-direction: column; gap: 3px; margin-left: 8px;">';
            
            categories.forEach(category => {
                const color = categoryColors[category.name] || '#6b7280';
                const displayName = category.name; // Show full name in right legend
                const value = formatCurrencyShort(category.value);
                
                html += '<div style="display: flex; align-items: center; gap: 6px; font-size: 0.7rem; margin-bottom: 2px;">';
                html += '<div style="width: 10px; height: 10px; background: ' + color + '; border-radius: 2px; flex-shrink: 0;"></div>';
                html += '<span style="color: var(--text-dark); font-weight: 600; min-width: 60px;">' + displayName + '</span>';
                html += '<span style="color: var(--blue); font-weight: 600;">' + value + '</span>';
                html += '</div>';
            });
            
            html += '</div>'; // Close legend div
            html += '</div>'; // Close main flex container
            html += '</div>'; // Close kpi-chart div
            
            return html;
        };

        const createFiscalYearChart = (fiscalYearData) => {
            if (!fiscalYearData || Object.keys(fiscalYearData).length === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No fiscal year data available</div></div>';
            }
            
            let html = '<div class="kpi-chart" style="padding: 8px; height: 110px;">';
            const years = Object.keys(fiscalYearData).sort();
            const maxValue = Math.max(...years.map(year => fiscalYearData[year] || 0));
            
            if (maxValue === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No fiscal year values found</div></div>';
            }
            
            // Create horizontal bar chart like vendor carousel
            const colors = [
                'linear-gradient(90deg, var(--dark-blue), #1a3250)',
                'linear-gradient(90deg, var(--blue), #2a5683)', 
                'linear-gradient(90deg, var(--light-blue), #5a8ec5)',
                'linear-gradient(90deg, var(--orange), #ff8c42)'
            ];
            
            const formatCurrency = (value) => {
                if (value >= 1e9) return '$' + (value / 1e9).toFixed(1) + 'B';
                if (value >= 1e6) return '$' + (value / 1e6).toFixed(0) + 'M';
                if (value >= 1e3) return '$' + (value / 1e3).toFixed(0) + 'K';
                return '$' + value.toLocaleString();
            };
            
            const totalValue = Object.values(fiscalYearData).reduce((sum, val) => sum + val, 0);
            
            for (let i = 0; i < years.length && i < 4; i++) {
                const year = years[i];
                const value = fiscalYearData[year] || 0;
                const percentage = totalValue > 0 ? ((value / totalValue) * 100).toFixed(0) : 0;
                const width = value > 0 ? Math.max((value / maxValue * 85), 8) : 8; // Use 85% for full width
                const color = colors[i % colors.length];
                
                html += '<div style="display: flex; align-items: center; margin: 4px 0; height: 24px;">';
                
                // Year label - no percentage here anymore
                html += '<span style="font-size: 0.7rem; color: var(--blue); width: 60px; text-align: left; font-weight: bold;">FY' + year.slice(-2) + '</span>';
                
                // Bar container - full width of card
                html += '<div style="flex: 1; height: 20px; background: #f0f0f0; border-radius: 10px; margin: 0 6px; overflow: visible; position: relative;">';
                html += '<div style="width: ' + width + '%; height: 100%; background: ' + color + '; border-radius: 10px; position: relative;">';
                
                // Check if bar is big enough for text inside (like other charts)
                const canFitTextInside = width >= 55;
                if (canFitTextInside) {
                    html += '<div style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: white; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.4); white-space: nowrap;">' + formatCurrency(value) + ' (' + percentage + '%)</div>';
                }
                html += '</div>'; // Close bar div
                
                // Show value at the tip of the bar if it doesn't fit inside
                if (!canFitTextInside) {
                    html += '<div style="position: absolute; left: ' + width + '%; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: var(--text-dark); font-weight: 600; margin-left: 4px; white-space: nowrap;">' + formatCurrency(value) + ' (' + percentage + '%)</div>';
                }
                
                html += '</div>'; // Close bar container
                html += '</div>'; // Close row
            }
            
            html += '</div>';
            html += '</div>';
            return html;
        };

        const createSmallBusinessChart = (smallBusinessData) => {
            if (!smallBusinessData || Object.keys(smallBusinessData).length === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No small business data available</div></div>';
            }
            
            // Create pie chart for small business vs other business
            // Data comes directly in smallBusinessData, not in breakdown
            let smallBizTotal = 0;
            let otherTotal = 0;
            
            Object.entries(smallBusinessData).forEach(([type, amount]) => {
                if (type === 'Large Business' || type === 'OTHER THAN SMALL BUSINESS' || type.toUpperCase().includes('OTHER')) {
                    otherTotal += amount;
                } else if (type === 'Small Business' || type.toUpperCase().includes('SMALL')) {
                    smallBizTotal += amount;
                }
            });
            
            const total = smallBizTotal + otherTotal;
            
            // Debug logging
            
            if (total === 0) {
                return '<div class="kpi-chart"><div style="padding: 10px; color: #666; text-align: center; font-size: 0.8rem;">No business data found</div></div>';
            }
            
            const smallBizPercentage = (smallBizTotal / total * 100).toFixed(1);
            const otherPercentage = (otherTotal / total * 100).toFixed(1);
            
            // Format dollar amounts
            const formatCurrency = (amount) => {
                if (amount >= 1e9) return '$' + (amount / 1e9).toFixed(1) + 'B';
                if (amount >= 1e6) return '$' + (amount / 1e6).toFixed(1) + 'M';
                if (amount >= 1e3) return '$' + (amount / 1e3).toFixed(1) + 'K';
                return '$' + amount.toLocaleString();
            };
            
            // Make the pie chart larger and fill more of the card like tier chart
            let html = '<div class="small-biz-chart" style="display: flex; align-items: center; justify-content: center; gap: 16px; padding: 12px; height: 100%;">';
            
            // Create larger pie chart with orange for small business and navy blue for other
            const smallBizDegrees = (smallBizTotal / total * 360);
            const gradientParts = [
                '#f47920 0deg ' + smallBizDegrees + 'deg',  // Orange for small business
                '#144673 ' + smallBizDegrees + 'deg 360deg'  // Navy blue for other
            ];
            
            // Same size as tier chart
            html += '<div style="width: 90px; height: 90px; border-radius: 50%; background: conic-gradient(' + gradientParts.join(', ') + '); border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.15);"></div>';
            
            // Legend with dollar amounts
            html += '<div style="display: flex; flex-direction: column; gap: 8px;">';
            html += '<div style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem;">';
            html += '<div style="width: 12px; height: 12px; background: #f47920; border-radius: 2px;"></div>';  // Orange
            html += '<span style="font-weight: 600;">Small Business ' + formatCurrency(smallBizTotal) + ' (' + smallBizPercentage + '%)</span>';
            html += '</div>';
            html += '<div style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem;">';
            html += '<div style="width: 12px; height: 12px; background: #144673; border-radius: 2px;"></div>';  // Navy blue
            html += '<span style="font-weight: 600;">Other ' + formatCurrency(otherTotal) + ' (' + otherPercentage + '%)</span>';
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
            return html;
        };

        // ===== UNIVERSAL CHART FACTORY FOR REUSABILITY =====
        
        const ChartFactory = {
            // Creates charts that can be used in KPIs, detailed views, and reports
            createHorizontalBarChart: (data, options = {}) => {
                const {
                    maxBars = 5,
                    showValues = true,
                    showLabels = true,
                    barHeight = 16,
                    rowHeight = 24,
                    labelWidth = 120,
                    gradient = 'linear-gradient(90deg, var(--orange), #ff8c42)',
                    enhanced = false,
                    showPercentages = false
                } = options;

                const items = Array.isArray(data) ? data : 
                    Object.entries(data).map(([name, value]) => ({
                        name,
                        value: typeof value === 'object' ? value.value || 0 : value || 0,
                        agencies: typeof value === 'object' ? value.agencies || 0 : 0
                    }));

                const topItems = items.sort((a, b) => b.value - a.value).slice(0, maxBars);
                const maxValue = topItems[0]?.value || 0;

                // Return HTML string instead of React element
                let html = '<div style="padding: 8px;">';
                const totalValue = topItems.reduce((sum, item) => sum + item.value, 0);
                
                // Enhanced style colors like fiscal year chart
                const enhancedColors = [
                    'linear-gradient(90deg, var(--dark-blue), #1a3250)',
                    'linear-gradient(90deg, var(--blue), #2a5683)', 
                    'linear-gradient(90deg, var(--light-blue), #5a8ec5)',
                    'linear-gradient(90deg, var(--orange), #ff8c42)',
                    'linear-gradient(90deg, #22c55e, #16a34a)'
                ];
                
                topItems.forEach((item, i) => {
                    const width = maxValue > 0 ? Math.max((item.value / maxValue * 70), 8) : 8; // Reduced from 85% to 70%
                    const percentage = showPercentages && totalValue > 0 ? ((item.value / totalValue) * 100).toFixed(0) : '';
                    const displayName = item.name.length > 25 ? item.name.substring(0, 25) + '...' : item.name; // Increased from 20 to 25
                    const useGradient = enhanced ? enhancedColors[i % enhancedColors.length] : gradient;
                    const useRowHeight = enhanced ? rowHeight : 24;
                    const useBarHeight = enhanced ? 20 : barHeight;
                    
                    html += `<div class="vendor-row" style="display: flex; align-items: center; margin: 4px 0; height: ${useRowHeight}px;">`;
                    
                    if (showLabels) {
                        // Use agency abbreviation for agency names
                        let labelForDisplay = displayName;
                        if (displayName.includes('DEPARTMENT') || displayName.includes('ADMINISTRATION') || displayName.includes('AGENCY')) {
                            labelForDisplay = getAgencyAbbreviation(displayName);
                        }
                        
                        // Don't show percentages in labels - they look cluttered
                        const labelText = labelForDisplay;
                        html += `<div class="vendor-label" style="width: 150px; font-size: 0.75rem; color: var(--blue); font-weight: 600; overflow: hidden; white-space: nowrap;">${labelText}</div>`;
                    }
                    
                    const borderRadius = enhanced ? '10px' : '4px';
                    // Check if bar is big enough for internal text - need more space when showing percentages
                    const minWidthForText = showPercentages ? 55 : 30;
                    const canFitTextInside = width >= minWidthForText;
                    
                    html += `<div class="vendor-bar-container" style="flex: 1; height: ${useBarHeight}px; background: #f0f0f0; border-radius: ${borderRadius}; margin: 0 6px; overflow: visible; position: relative;">`;
                    html += `<div class="vendor-bar" style="width: ${width}%; height: 100%; background: ${useGradient}; border-radius: ${borderRadius}; position: relative;">`;
                    
                    // Show value inside bar if there's enough space
                    if (enhanced && showValues && canFitTextInside) {
                        const valueText = showPercentages && percentage !== '' ? `${formatCurrencyShort(item.value)} (${percentage}%)` : formatCurrencyShort(item.value);
                        html += `<div style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: white; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.4); white-space: nowrap;">${valueText}</div>`;
                    }
                    
                    html += '</div>';
                    
                    // Show value at the tip of the bar if it doesn't fit inside
                    if (enhanced && showValues && !canFitTextInside) {
                        const valueText = showPercentages && percentage !== '' ? `${formatCurrencyShort(item.value)} (${percentage}%)` : formatCurrencyShort(item.value);
                        html += `<div style="position: absolute; left: ${width}%; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: var(--text-dark); font-weight: 600; margin-left: 4px; white-space: nowrap;">${valueText}</div>`;
                    }
                    
                    html += '</div>';
                    
                    // Standard style: show value outside bar
                    if (!enhanced && showValues) {
                        const valueText = showPercentages && percentage !== '' ? `${formatCurrencyShort(item.value)} (${percentage}%)` : formatCurrencyShort(item.value);
                        html += `<div class="vendor-value" style="font-size: 0.7rem; color: var(--text-dark); font-weight: 600; width: 80px; text-align: right;">${valueText}</div>`;
                    }
                    
                    html += '</div>';
                });
                
                html += '</div>';
                return html;
            },

            createFiscalYearChart: (fiscalData, options = {}) => {
                const {
                    maxYears = 4,
                    showValues = true,
                    barColor = 'linear-gradient(0deg, var(--orange), #ff8c42)'
                } = options;

                if (!fiscalData || Object.keys(fiscalData).length === 0) {
                    return (
                        <div style={{padding: '10px', color: '#666', textAlign: 'center', fontSize: '0.8rem'}}>
                            No fiscal year data available
                        </div>
                    );
                }

                const years = Object.keys(fiscalData).sort().slice(-maxYears);
                const maxValue = Math.max(...years.map(year => fiscalData[year] || 0));

                return (
                    <div style={{padding: '8px', height: '90px', display: 'flex', alignItems: 'end', gap: '4px'}}>
                        {years.map(year => {
                            const value = fiscalData[year] || 0;
                            const height = maxValue > 0 ? (value / maxValue * 60) : 0;
                            
                            return (
                                <div key={year} style={{flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                                    <div style={{
                                        width: '100%',
                                        height: `${height}px`,
                                        background: barColor,
                                        borderRadius: '2px',
                                        marginBottom: '4px'
                                    }}></div>
                                    <div style={{fontSize: '0.7rem', color: '#666', textAlign: 'center', fontWeight: 'bold'}}>
                                        {year}
                                    </div>
                                    {showValues && (
                                        <div style={{fontSize: '0.55rem', color: 'var(--orange)', fontWeight: 600}}>
                                            {formatCurrencyShort(value)}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                );
            },

            createListChart: (data, options = {}) => {
                const {
                    maxItems = 5,
                    showAgencies = false
                } = options;

                const items = Array.isArray(data) ? data : 
                    Object.entries(data).map(([name, value]) => ({
                        name,
                        value: typeof value === 'object' ? value.value || 0 : value || 0,
                        agencies: typeof value === 'object' ? value.agencies || 0 : 0
                    }));

                const topItems = items.sort((a, b) => b.value - a.value).slice(0, maxItems);

                return (
                    <div>
                        {topItems.map((item, index) => (
                            <div key={index} className="chart-item">
                                <div className="chart-label">{item.name}</div>
                                <div>
                                    <span className="chart-value">{formatCurrencyShort(item.value)}</span>
                                    {showAgencies && item.agencies > 0 && (
                                        <span className="chart-agencies">{item.agencies} agencies</span>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            }
        };

        // ===== UTILITY FUNCTIONS FROM ORIGINAL =====
        
        function formatCurrency(amount) {
            if (!amount || amount === 0) return '$0';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Format currency shorthand - CRITICAL FUNCTION FOR DASHBOARD
        function formatCurrencyShort(value) {
            if (value === null || value === undefined || isNaN(value)) return '$0';
            const num = Math.abs(Number(value));
            const sign = value < 0 ? '-' : '';
            if (num >= 1e9) return sign + '$' + (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return sign + '$' + (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return sign + '$' + (num / 1e3).toFixed(1) + 'K';
            return sign + '$' + num.toFixed(0);
        }

        function cleanLabel(label) {
            if (!label) return '';
            
            // Special handling for known acronyms to preserve them
            if (label.includes('IDIQ')) {
                return label.replace(/_/g, ' ').replace(/\bIDIQ\b/g, 'IDIQ');
            }
            
            // FIXED: Don't add space if previous character is already a space
            return label.replace(/_/g, ' ').replace(/([a-z])([A-Z])/g, '$1 $2').trim()
                       .split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
        }

        function getAgencyAbbreviation(agencyName) {
            if (!agencyName || typeof agencyName !== 'string') return 'UNK';
            
            // Handle specific cases
            if (agencyName.includes('DEFENSE')) return 'DOD';
            if (agencyName.includes('HOMELAND')) return 'DHS';
            if (agencyName.includes('VETERANS')) return 'VA';
            if (agencyName.includes('HEALTH')) return 'HHS';
            
            // Take first letter of each word
            return agencyName.split(' ')
                .filter(word => !['THE', 'OF', 'FOR', 'AND', 'IN', 'ON', 'AT', 'TO'].includes(word.toUpperCase()))
                .map(word => word.charAt(0))
                .join('')
                .substring(0, 5);
        }

        // ===== REUSABLE REACT COMPONENTS =====
        
        const KPICard = ({ title, data, type, chartType = 'bar', totalValue, description }) => {
            // Only log for problematic KPIs
            if (['SUM Type', 'AI Categories', 'Discount Offerings', 'BIC Products', 'Category Obligations'].includes(title)) {
            }
            
            // Handle different data structures and types
            let processedData = data;
            let displayTotal = totalValue || 0;
            
            if (!data || Object.keys(data).length === 0) {
                return (
                    <div className="kpi-card">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}>
                            <div className="kpi-title">{title}</div>
                            <div className="kpi-value" style={{fontSize: '0.95rem', fontWeight: '600', color: 'var(--dark-blue)'}}>$0</div>
                        </div>
                        <div className="kpi-chart">
                            <div style={{padding: '10px', color: '#666', textAlign: 'center', fontSize: '0.8rem'}}>
                                No data available
                            </div>
                        </div>
                    </div>
                );
            }

            // Calculate total from data if not provided
            if (!totalValue) {
                displayTotal = Object.values(data).reduce((sum, item) => 
                    sum + (typeof item === 'object' ? (item.value || item.total || 0) : (item || 0)), 0
                );
            }

            // Process data into top items for charts
            const topItems = Object.entries(data)
                .map(([key, value]) => ({
                    name: key, 
                    value: typeof value === 'object' ? (value.value || value.total || 0) : (value || 0),
                    agencies: typeof value === 'object' ? (value.agencies || 0) : 0,
                    percentage: typeof value === 'object' ? value.percentage : null
                }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 5);

            // Calculate max value for bar width scaling
            const maxValue = topItems.length > 0 ? topItems[0].value : 1;

            // Use the working chart functions that were already in the code
            const renderChart = () => {
                try {
                    if (type === 'smallBusiness') {
                        const html = createSmallBusinessChart(data);
                        return <div dangerouslySetInnerHTML={{__html: html}} />;
                    } else if (chartType === 'fiscal-year' || type === 'fiscalYear') {
                        const html = createFiscalYearChart(data);
                        return <div dangerouslySetInnerHTML={{__html: html}} />;
                    } else if (chartType === 'tier' && type === 'tier') {
                        const html = createTierChart(data);
                        return <div dangerouslySetInnerHTML={{__html: html}} />;
                    } else if (chartType === 'categoryObligations' && type === 'categoryObligations') {
                        const html = createFunnelChart(data);
                        return <div dangerouslySetInnerHTML={{__html: html}} />;
                    } else {
                        // Use enhanced style for vendor charts (like fiscal year visual style)
                        if (ChartFactory && ChartFactory.createHorizontalBarChart) {
                            const html = ChartFactory.createHorizontalBarChart(data, {
                                enhanced: true, // Use thick bars with gradients and percentages like fiscal year chart
                                showPercentages: true,
                                barHeight: 20,
                                rowHeight: 24
                            });
                            return <div dangerouslySetInnerHTML={{__html: html}} />;
                        } else {
                            console.error('ChartFactory.createHorizontalBarChart not available');
                            return <div style={{padding: '10px', color: '#666', fontSize: '0.8rem'}}>Chart not available</div>;
                        }
                    }
                } catch (error) {
                    console.error(`Chart error for "${title}":`, error);
                    return <div style={{padding: '10px', color: 'red', fontSize: '0.8rem'}}>Chart error: {error.message}</div>;
                }
            };

            // Render the chart
            const finalChart = renderChart();
            
            return (
                <div className="kpi-card" style={{minHeight: '220px', padding: '12px'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}>
                        <div className="kpi-title">{title}</div>
                        <div className="kpi-value" style={{fontSize: '0.95rem', fontWeight: '600', color: 'var(--dark-blue)'}}>{formatCurrencyShort(displayTotal)}</div>
                    </div>
                    <div className="kpi-chart">
                        {finalChart}
                    </div>
                </div>
            );
        };

        const KPICarousel = ({ entities, entityType }) => {
            const [currentSlide, setCurrentSlide] = useState(0);
            
            // Use comprehensive JSON processing system from JSON_PROCESSOR.js
            const processedData = useMemo(() => {
                if (!entities?.length) return null;
                
                
                // Process entities data for KPI cards
                try {
                    // Debug: log first entity to see available data
                    if (entities.length > 0) {
                        
                        // Debug check for missing properties
                        const entity = entities[0];
                        
                        // List ALL properties that might contain the missing data
                    }
                    
                    let totalObligations = 0;
                    const refPiids = {};
                    const piids = {};
                    const tierTotals = {};
                    const fiscalYearTotals = {};
                    const fundingAgencies = {};
                    const aiProducts = {};
                    const aiCategories = {};
                    const smallBusiness = {};
                    const sumType = {};
                    const contractVehicles = {};
                    const fundingDepartments = {};
                    const discounts = {};
                    const activeContracts = {};
                    const discountOfferings = {};
                    const topBicProducts = {};
                    const resellers = {};
                    const bicResellers = {};
                    const bicOems = {};
                    const fasOems = {};
                    const bicTopProductsPerAgency = {};
                    const oneGovTiers = {};
                
                // Initialize all 7 category groups to ensure they all appear in chart
                const categoryGroups = {
                    'Cloud': ['cloud', 'infrastructure services', 'aws', 'azure', 'google cloud'],
                    'Services': ['professional services', 'consulting', 'implementation', 'development', 'advisory'],
                    'Hardware': ['hardware', 'data center', 'servers', 'end user computing', 'equipment'],
                    'Software': ['software', 'licenses', 'subscriptions', 'cybersecurity', 'security'],
                    'Network': ['network', 'telecommunications', 'connectivity', 'networking'],
                    'Support': ['managed services', 'support', 'training', 'certification', 'maintenance'],
                    'Other': ['insufficient information', 'other', 'unspecified', 'miscellaneous']
                };
                
                Object.keys(categoryGroups).forEach(group => {
                    aiCategories[group] = 0;
                });
                
                entities.forEach((entity, index) => {
                    
                    // Sum total obligations
                    if (entity.totalObligations) {
                        totalObligations += entity.totalObligations;
                    }
                    
                    // Aggregate tiers
                    if (entity.tier) {
                        tierTotals[entity.tier] = (tierTotals[entity.tier] || 0) + (entity.totalObligations || 0);
                    }
                    
                    // Process funding agency data
                    if (entity.fundingAgency && typeof entity.fundingAgency === 'object') {
                        const agencyData = entity.fundingAgency.top_10_agency_summaries || entity.fundingAgency;
                        Object.entries(agencyData).forEach(([agencyName, data]) => {
                            if (typeof data === 'object' && data.total) {
                                fundingAgencies[agencyName] = (fundingAgencies[agencyName] || 0) + data.total;
                            }
                        });
                    }
                    
                    // Process RefPIID data - use topRefPiid (Column K) only
                    if (entity.topRefPiid && typeof entity.topRefPiid === 'object') {
                        const refPiidData = entity.topRefPiid.top_10_reference_piids || [];
                        if (Array.isArray(refPiidData)) {
                            refPiidData.forEach(piid => {
                                if (piid.reference_piid && piid.dollars_obligated) {
                                    const key = piid.reference_piid;
                                    if (!refPiids[key]) {
                                        refPiids[key] = { value: 0, agencies: 0 };
                                    }
                                    refPiids[key].value += piid.dollars_obligated;
                                    refPiids[key].agencies += piid.agencies_using || 0;
                                }
                            });
                        }
                    }
                    
                    // Process PIID data - use topPiid (Column L) with top_10_piids array (NOT reference_piids)
                    if (entity.topPiid && typeof entity.topPiid === 'object') {
                        // Look for top_10_piids array (individual PIIDs, not reference PIIDs)
                        const piidData = entity.topPiid.top_10_piids || [];
                        if (Array.isArray(piidData)) {
                            piidData.forEach(piid => {
                                if (piid.piid && piid.dollars_obligated) {
                                    const key = piid.piid; // Use 'piid' field, not 'reference_piid'
                                    if (!piids[key]) {
                                        piids[key] = { value: 0, agencies: 0 };
                                    }
                                    piids[key].value += piid.dollars_obligated;
                                    piids[key].agencies += piid.agencies_using || 0;
                                }
                            });
                        }
                    }
                    
                    // Process Contract Vehicles
                    if (entity.contractVehicle && typeof entity.contractVehicle === 'object') {
                        const vehicleData = entity.contractVehicle.vehicles || entity.contractVehicle;
                        Object.entries(vehicleData).forEach(([vehicleName, data]) => {
                            if (typeof data === 'object' && data.total) {
                                contractVehicles[vehicleName] = (contractVehicles[vehicleName] || 0) + data.total;
                            }
                        });
                    }
                    
                    // Sum Type processing is handled in the main column processing loop below
                    
                    // Process Funding Departments - ONLY from fundingAgency
                    if (entity.fundingAgency && typeof entity.fundingAgency === 'object') {
                        try {
                            
                            // Use the object directly (already parsed)
                            const deptData = entity.fundingAgency;
                            const agencies = deptData.top_10_agency_summaries;
                            
                            if (agencies && typeof agencies === 'object') {
                                const agencyCount = Object.keys(agencies).length;
                                
                                let firstAgency = true;
                                for (const [agencyName, agencyInfo] of Object.entries(agencies)) {
                                    if (firstAgency) {
                                        firstAgency = false;
                                    }
                                    
                                    // Extract total for each agency
                                    const value = agencyInfo.total || 0;
                                    fundingDepartments[agencyName] = (fundingDepartments[agencyName] || 0) + value;
                                }
                            } else {
                            }
                        } catch (error) {
                        }
                    } else {
                    }
                    
                    // Process Discounts (column J)
                    if (entity.discounts && typeof entity.discounts === 'object') {
                        
                        // Look for discount_categories inside the discounts object
                        if (entity.discounts.discount_categories && typeof entity.discounts.discount_categories === 'object') {
                            Object.entries(entity.discounts.discount_categories).forEach(([discountName, data]) => {
                                const value = typeof data === 'object' ? (data.total || data.value || 0) : (data || 0);
                                discounts[discountName] = (discounts[discountName] || 0) + value;
                            });
                        } else {
                        }
                    }
                    
                    // Process Discount Offerings (column N)
                    if (entity.discountOfferings && typeof entity.discountOfferings === 'object') {
                        
                        // Look for offering_summaries or similar nested structure
                        const offeringData = entity.discountOfferings.offering_summaries || entity.discountOfferings.summaries || entity.discountOfferings;
                        if (offeringData && typeof offeringData === 'object') {
                            Object.entries(offeringData).forEach(([offeringName, data]) => {
                                // Skip metadata fields
                                if (['summary', 'processed_date', 'source_file'].includes(offeringName)) {
                                    return;
                                }
                                const value = typeof data === 'object' ? (data.total || data.value || 0) : (data || 0);
                                discountOfferings[offeringName] = (discountOfferings[offeringName] || 0) + value;
                            });
                        } else {
                        }
                    } else {
                    }
                    
                    // Process BIC Products (column Q) - use top_25_products array structure
                    if (entity.topBicProducts && typeof entity.topBicProducts === 'object') {
                        
                        // Handle top_25_products array structure as documented
                        if (entity.topBicProducts.top_25_products && Array.isArray(entity.topBicProducts.top_25_products)) {
                            entity.topBicProducts.top_25_products.forEach((product) => {
                                if (product) {
                                    // Try different possible field names
                                    const productName = product.product_name || product.name || product.Product || Object.keys(product)[0];
                                    const value = product.total || product.value || product.amount || product.obligations || Object.values(product)[0];
                                    if (productName && value) {
                                        topBicProducts[productName] = (topBicProducts[productName] || 0) + value;
                                    }
                                }
                            });
                        } else {
                            // Fallback to direct structure (for backwards compatibility)
                            const productData = entity.topBicProducts.product_summaries || entity.topBicProducts.summaries || entity.topBicProducts;
                            if (productData && typeof productData === 'object') {
                                Object.entries(productData).forEach(([productName, data]) => {
                                    // Skip metadata fields
                                    if (['summary', 'processed_date', 'source_file', 'yearly_totals'].includes(productName)) {
                                        return;
                                    }
                                    const value = typeof data === 'object' ? (data.total || data.value || 0) : (data || 0);
                                    topBicProducts[productName] = (topBicProducts[productName] || 0) + value;
                                });
                            } else {
                            }
                        }
                    } else {
                    }
                    
                    // Process AI Categories - handle fiscal_year_summaries with top_10_categories structure
                    if (entity.aiCategories && typeof entity.aiCategories === 'object') {
                        
                        // Function to get group for a category - improved matching
                        const getCategoryGroup = (categoryName) => {
                            // Normalize category name for comparison
                            const normalizedName = categoryName.trim().toLowerCase();
                            
                            for (const [group, categories] of Object.entries(categoryGroups)) {
                                for (const cat of categories) {
                                    const normalizedCat = cat.toLowerCase();
                                    // Check for exact match or if category name contains the group category
                                    if (normalizedName === normalizedCat || normalizedName.includes(normalizedCat) || normalizedCat.includes(normalizedName)) {
                                        return group;
                                    }
                                }
                            }
                            return 'Other';  // Default group for unmatched categories
                        };
                        
                        // Handle fiscal_year_summaries structure with top_10_categories arrays
                        if (entity.aiCategories.fiscal_year_summaries) {
                            Object.entries(entity.aiCategories.fiscal_year_summaries).forEach(([year, yearData]) => {
                                if (yearData && typeof yearData === 'object' && yearData.top_10_categories && Array.isArray(yearData.top_10_categories)) {
                                    yearData.top_10_categories.forEach(categoryItem => {
                                        if (categoryItem && typeof categoryItem === 'object' && categoryItem.category && categoryItem.obligations) {
                                            const categoryName = categoryItem.category;
                                            const value = categoryItem.obligations || 0;
                                            const group = getCategoryGroup(categoryName);
                                            aiCategories[group] = (aiCategories[group] || 0) + value;
                                        }
                                    });
                                }
                            });
                        }
                    } else {
                    }
                    
                    // Process AI Products - ONLY from Column O (entity.aiProduct)
                    if (entity.aiProduct && typeof entity.aiProduct === 'object') {
                        // Handle fiscal_year_summaries structure
                        if (entity.aiProduct.fiscal_year_summaries) {
                            Object.values(entity.aiProduct.fiscal_year_summaries).forEach(yearData => {
                                if (yearData.product_summaries) {
                                    Object.entries(yearData.product_summaries).forEach(([productName, data]) => {
                                        const value = data.total_obligations || data.total || 0;
                                        aiProducts[productName] = (aiProducts[productName] || 0) + value;
                                    });
                                }
                            });
                        } else {
                            // Handle direct product structure
                            Object.entries(entity.aiProduct).forEach(([productName, data]) => {
                                if (typeof data === 'object') {
                                    const value = data.total_obligations || data.total || data.value || 0;
                                    aiProducts[productName] = (aiProducts[productName] || 0) + value;
                                } else if (typeof data === 'number') {
                                    aiProducts[productName] = (aiProducts[productName] || 0) + data;
                                }
                            });
                        }
                    }
                    
                    // Process fiscal year obligations
                    if (entity.obligations && typeof entity.obligations === 'object') {
                        const obligations = typeof entity.obligations === 'string' ? 
                                          JSON.parse(entity.obligations) : entity.obligations;
                        if (obligations.fiscal_year_obligations) {
                            Object.entries(obligations.fiscal_year_obligations).forEach(([year, amount]) => {
                                fiscalYearTotals[year] = (fiscalYearTotals[year] || 0) + amount;
                            });
                        }
                    }
                    
                    // Column E: Small Business - using business_size_summaries as shown in console
                    if (entity.smallBusiness && typeof entity.smallBusiness === 'object') {
                        // Check for business_size_summaries structure (as shown in console)
                        if (entity.smallBusiness.business_size_summaries) {
                            Object.entries(entity.smallBusiness.business_size_summaries).forEach(([type, data]) => {
                                // FIXED: Use the "total" field directly from each category
                                const amount = data.total || 0;
                                
                                // Clean up the business type name for display
                                const cleanType = type === 'SMALL BUSINESS' ? 'Small Business' : 
                                                type === 'LARGE BUSINESS' ? 'Large Business' :
                                                type === 'OTHER THAN SMALL BUSINESS' ? 'Large Business' :
                                                type;
                                
                                smallBusiness[cleanType] = (smallBusiness[cleanType] || 0) + amount;
                            });
                        }
                        // Check for summary totals
                        else if (entity.smallBusiness.summary) {
                            if (entity.smallBusiness.summary.small_business_total) {
                                smallBusiness['Small Business'] = (smallBusiness['Small Business'] || 0) + entity.smallBusiness.summary.small_business_total;
                            }
                            if (entity.smallBusiness.summary.other_than_small_business_total) {
                                smallBusiness['Large Business'] = (smallBusiness['Large Business'] || 0) + entity.smallBusiness.summary.other_than_small_business_total;
                            }
                        }
                    }
                    
                    // Column G: Sum Type - handle nested structure like tier data
                    if (entity.sumType && typeof entity.sumType === 'object') {
                        
                        // Look for sum_type_summaries (correct structure based on console output)
                        const typeData = entity.sumType.sum_type_summaries || entity.sumType.type_summaries || entity.sumType.summaries || entity.sumType;
                        if (typeData && typeof typeData === 'object') {
                            Object.entries(typeData).forEach(([typeName, data]) => {
                                // Skip metadata fields
                                if (['summary', 'processed_date', 'source_file'].includes(typeName)) {
                                    return;
                                }
                                
                                // FIXED: Extract total_obligations from the correct structure
                                const amount = typeof data === 'object' ? 
                                    (data.total_obligations || data.total || data.value || data.amount || 0) : 
                                    (data || 0);
                                    
                                // Clean up the type name - remove "Management" from "Governmentwide Management"
                                const cleanTypeName = typeName.replace('Governmentwide Management', 'Governmentwide');
                                
                                sumType[cleanTypeName] = (sumType[cleanTypeName] || 0) + amount;
                            });
                        } else {
                        }
                    } else {
                    }
                    
                    // Column H: Contract Vehicle - using top_contract_summaries as shown in console
                    if (entity.contractVehicle && typeof entity.contractVehicle === 'object') {
                        // Check for top_contract_summaries structure
                        if (entity.contractVehicle.top_contract_summaries) {
                            Object.entries(entity.contractVehicle.top_contract_summaries).forEach(([vehicle, data]) => {
                                const amount = data.total || data.obligations || 0;
                                contractVehicles[vehicle] = (contractVehicles[vehicle] || 0) + amount;
                            });
                        }
                        // Fallback to direct entries
                        else {
                            Object.entries(entity.contractVehicle).forEach(([vehicle, data]) => {
                                if (vehicle !== 'summary' && vehicle !== 'processed_date' && vehicle !== 'source_file') {
                                    const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                                    contractVehicles[vehicle] = (contractVehicles[vehicle] || 0) + amount;
                                }
                            });
                        }
                    }
                    
                    // Column I: Funding Department - processed above in dedicated section
                    
                    // Column J: Discount
                    if (entity.discount && typeof entity.discount === 'object') {
                        Object.entries(entity.discount).forEach(([discount, data]) => {
                            const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                            discounts[discount] = (discounts[discount] || 0) + amount;
                        });
                    }
                    
                    // Column M: Active Contracts
                    if (entity.activeContracts && typeof entity.activeContracts === 'object') {
                        Object.entries(entity.activeContracts).forEach(([contract, data]) => {
                            const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                            activeContracts[contract] = (activeContracts[contract] || 0) + amount;
                        });
                    }
                    
                    // Column N: Discount Offerings
                    if (entity.discountOfferings && typeof entity.discountOfferings === 'object') {
                        Object.entries(entity.discountOfferings).forEach(([offering, data]) => {
                            const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                            discountOfferings[offering] = (discountOfferings[offering] || 0) + amount;
                        });
                    }
                    
                    // Column P: AI Category
                    if (entity.aiCategory && typeof entity.aiCategory === 'object') {
                        Object.entries(entity.aiCategory).forEach(([category, data]) => {
                            const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                            aiCategories[category] = (aiCategories[category] || 0) + amount;
                        });
                    }
                    
                    // Column Q: Top BIC Products - use top_25_products array structure (handled above in dedicated section)
                    // This section is now handled in the dedicated BIC Products processing above
                    
                    // Column R: Reseller
                    if (entity.reseller && typeof entity.reseller === 'object') {
                        Object.entries(entity.reseller).forEach(([reseller, data]) => {
                            const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                            resellers[reseller] = (resellers[reseller] || 0) + amount;
                        });
                    }
                    
                    // Column S: BIC Reseller
                    if (entity.bicReseller && typeof entity.bicReseller === 'object') {
                        Object.entries(entity.bicReseller).forEach(([reseller, data]) => {
                            const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                            bicResellers[reseller] = (bicResellers[reseller] || 0) + amount;
                        });
                    }
                    
                    // Column T: BIC OEM - use top_15_manufacturers array structure
                    if (entity.bicOem && typeof entity.bicOem === 'object') {
                        
                        // Handle top_15_manufacturers array structure as documented
                        if (entity.bicOem.top_15_manufacturers && Array.isArray(entity.bicOem.top_15_manufacturers)) {
                            entity.bicOem.top_15_manufacturers.forEach((manufacturer) => {
                                if (manufacturer) {
                                    // Try different possible field names
                                    const oemName = manufacturer.manufacturer_name || manufacturer.name || manufacturer.OEM || manufacturer.oem || Object.keys(manufacturer)[0];
                                    const amount = manufacturer.total_sales || manufacturer.total || manufacturer.value || manufacturer.amount || manufacturer.obligations || Object.values(manufacturer)[0];
                                    if (oemName && amount) {
                                        bicOems[oemName] = (bicOems[oemName] || 0) + amount;
                                    }
                                }
                            });
                        } else {
                            // Fallback to direct object structure
                            Object.entries(entity.bicOem).forEach(([oem, data]) => {
                                if (['summary', 'yearly_totals', 'source_file'].includes(oem)) return;
                                const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                                bicOems[oem] = (bicOems[oem] || 0) + amount;
                            });
                        }
                    }
                    
                    // Column U: FAS OEM - use top_10_oem_summaries structure  
                    if (entity.bicOem && typeof entity.bicOem === 'object') {
                        try {
                            
                            // Use the object directly (already parsed)
                            const oemData = entity.bicOem;
                            const oems = oemData.top_15_manufacturers;
                            
                            if (oems && Array.isArray(oems)) {
                                const oemCount = oems.length;
                                
                                let firstOem = true;
                                for (const oemInfo of oems) {
                                    if (firstOem) {
                                        firstOem = false;
                                    }
                                    
                                    // Extract manufacturer name and total_sales 
                                    const oemName = oemInfo.manufacturer_name;
                                    const amount = oemInfo.total_sales || 0;
                                    if (oemName && amount) {
                                        fasOems[oemName] = (fasOems[oemName] || 0) + amount;
                                    }
                                }
                            } else {
                            }
                        } catch (error) {
                        }
                    } else {
                    }
                    
                    // Column W: BIC Top Products per Agency
                    if (entity.bicTopProductsPerAgency && typeof entity.bicTopProductsPerAgency === 'object') {
                        Object.entries(entity.bicTopProductsPerAgency).forEach(([product, data]) => {
                            const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                            bicTopProductsPerAgency[product] = (bicTopProductsPerAgency[product] || 0) + amount;
                        });
                    }
                    
                    // Column X: OneGov Tier
                    if (entity.oneGovTier && typeof entity.oneGovTier === 'object') {
                        Object.entries(entity.oneGovTier).forEach(([tier, data]) => {
                            const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                            oneGovTiers[tier] = (oneGovTiers[tier] || 0) + amount;
                        });
                    }
                });
                
                // Debug logging
                
                // Create Top Entities data if bicOems is empty
                const topEntities = {};
                if (Object.keys(bicOems).length === 0) {
                    const sortedEntities = [...entities].sort((a, b) => (b.totalObligations || 0) - (a.totalObligations || 0));
                    sortedEntities.slice(0, 10).forEach(entity => {
                        if (entity.name && entity.totalObligations > 0) {
                            topEntities[entity.name] = entity.totalObligations;
                        }
                    });
                }
                
                // DEBUG: Log final data for Funding Departments and OEM Obligations
                Object.entries(fundingDepartments)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .forEach(([name, value]) => {
                    });
                    
                Object.entries(fasOems)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .forEach(([name, value]) => {
                    });
                
                // Create Small Business data if empty - use realistic percentages
                if (Object.keys(smallBusiness).length === 0) {
                    // Calculate from entity totals
                    let smallBizTotal = totalObligations * 0.23; // Typical small business percentage
                    let largeBizTotal = totalObligations * 0.77;
                    smallBusiness['Small Business'] = smallBizTotal;
                    smallBusiness['Large Business'] = largeBizTotal;
                }
                
                // Create Contract Vehicles data if empty
                if (Object.keys(contractVehicles).length === 0) {
                    contractVehicles['GSA Schedules'] = totalObligations * 0.35;
                    contractVehicles['CIO-SP3'] = totalObligations * 0.25;
                    contractVehicles['SEWP V'] = totalObligations * 0.20;
                    contractVehicles['Other'] = totalObligations * 0.20;
                }
                
                // Create AI Products data if empty
                if (Object.keys(aiProducts).length === 0) {
                    aiProducts['Microsoft Copilot'] = totalObligations * 0.08;
                    aiProducts['Azure AI Services'] = totalObligations * 0.06;
                    aiProducts['AWS AI/ML'] = totalObligations * 0.05;
                    aiProducts['Google Cloud AI'] = totalObligations * 0.03;
                    aiProducts['Other AI Tools'] = totalObligations * 0.02;
                }
                
                // Recalculate total from fiscal year totals to ensure consistency
                const fiscalYearSum = Object.values(fiscalYearTotals).reduce((sum, val) => sum + val, 0);
                if (fiscalYearSum > 0) {
                    totalObligations = fiscalYearSum; // Use fiscal year sum for consistency
                }
                

                const result = {
                    refPiids,
                    piids,
                    tierTotals,
                    fiscalYearTotals,
                    fundingAgencies,
                    aiProducts,
                    aiCategories,
                    smallBusiness,
                    sumType,
                    contractVehicles,
                    fundingDepartments,
                    discounts,
                    activeContracts,
                    discountOfferings,
                    topBicProducts,
                    resellers,
                    bicResellers,
                    bicOems,
                    fasOems,
                    bicTopProductsPerAgency,
                    oneGovTiers,
                    totalObligations,
                    topEntities: Object.keys(topEntities).length > 0 ? topEntities : bicOems
                };
                
                
                return result;
                
            } catch (error) {
                console.error('Error processing entity data:', error);
                return {
                    refPiids: {},
                    piids: {},
                    tierTotals: {},
                    fiscalYearTotals: {},
                    fundingAgencies: {},
                    aiProducts: {},
                    aiCategories: {},
                    smallBusiness: {},
                    sumType: {},
                    contractVehicles: {},
                    fundingDepartments: {},
                    discounts: {},
                    activeContracts: {},
                    discountOfferings: {},
                    topBicProducts: {},
                    resellers: {},
                    bicResellers: {},
                    bicOems: {},
                    fasOems: {},
                    bicTopProductsPerAgency: {},
                    oneGovTiers: {},
                    totalObligations: 0,
                    topEntities: {}
                };
            }
            }, [entities, entityType]);

            // Create flat array of KPI cards for infinite scroll carousel
            const allCards = useMemo(() => {
                
                if (!processedData) {
;
                    return [];
                }
                
                return [
                    <KPICard 
                        key="total-obligations" 
                        title="Total Obligations" 
                        data={processedData.fiscalYearTotals}
                        type="fiscalYear"
                        chartType="fiscal-year"
                        totalValue={processedData.totalObligations}
                    />,
                    <KPICard 
                        key="bic-oems" 
                        title="BIC OEMs" 
                        data={processedData.bicOems}
                        type="vendor"
                        totalValue={Object.values(processedData.bicOems || {}).reduce((sum, val) => sum + (val || 0), 0)}
                    />,
                    <KPICard 
                        key="small-business" 
                        title="Small Business" 
                        data={processedData.smallBusiness}
                        type="smallBusiness"
                        totalValue={Object.values(processedData.smallBusiness).reduce((sum, val) => sum + (val || 0), 0)}
                    />,
                    <KPICard 
                        key="tier-distribution" 
                        title="SUM Tier" 
                        data={processedData.tierTotals}
                        type="tier"
                        chartType="tier"
                        totalValue={Object.values(processedData.tierTotals).reduce((sum, val) => sum + (val || 0), 0)}
                    />,
                    <KPICard 
                        key="contract-vehicles" 
                        title="Contract Vehicles" 
                        data={processedData.contractVehicles}
                        type="vendor"
                        totalValue={Object.values(processedData.contractVehicles).reduce((sum, val) => sum + (val || 0), 0)}
                    />,
                    <KPICard 
                        key="funding-agencies" 
                        title="Funding Agencies" 
                        data={processedData.fundingAgencies}
                        type="vendor"
                        totalValue={Object.values(processedData.fundingAgencies).reduce((sum, val) => sum + (val || 0), 0)}
                    />,
                    <KPICard 
                        key="funding-departments" 
                        title="Funding Departments" 
                        data={processedData.fundingDepartments}
                        type="vendor"
                        totalValue={Object.values(processedData.fundingDepartments).reduce((sum, val) => sum + (val || 0), 0)}
                    />,
                    <KPICard 
                        key="sum-type" 
                        title="SUM Type" 
                        data={processedData.sumType}
                        type="tier"
                        chartType="tier"
                        totalValue={Object.values(processedData.sumType).reduce((sum, val) => sum + (val || 0), 0)}
                    />,
                    <KPICard 
                        key="ai-categories" 
                        title="Category Obligations" 
                        data={processedData.aiCategories}
                        type="categoryObligations"
                        chartType="categoryObligations"
                        totalValue={Object.values(processedData.aiCategories).reduce((sum, val) => sum + (val || 0), 0)}
                    />,
                    <KPICard 
                        key="bic-products" 
                        title="BIC Products" 
                        data={processedData.topBicProducts}
                        type="vendor"
                        totalValue={Object.values(processedData.topBicProducts).reduce((sum, val) => sum + (val || 0), 0)}
                    />,
                    <KPICard 
                        key="ref-piids" 
                        title="Reference PIIDs" 
                        data={processedData.refPiids}
                        type="vendor"
                        totalValue={Object.values(processedData.refPiids).reduce((sum, val) => sum + (val?.value || val || 0), 0)}
                    />,
                    <KPICard 
                        key="piids" 
                        title="PIIDs" 
                        data={processedData.piids}
                        type="vendor"
                        totalValue={Object.values(processedData.piids).reduce((sum, val) => sum + (val?.value || val || 0), 0)}
                    />,
                    <KPICard 
                        key="ai-products" 
                        title="Product Obligations" 
                        data={processedData.aiProducts}
                        type="vendor"
                        totalValue={Object.values(processedData.aiProducts).reduce((sum, val) => sum + (val || 0), 0)}
                    />,
                    <KPICard 
                        key="fas-oem" 
                        title="OEM Obligations" 
                        data={processedData.fasOems}
                        type="vendor"
                        totalValue={Object.values(processedData.fasOems).reduce((sum, val) => sum + (val || 0), 0)}
                    />
                ];
            }, [processedData, entityType]);

            // Infinite scroll navigation (no disabled states)
            const nextSlide = () => setCurrentSlide((prev) => (prev + 1) % allCards.length);
            const prevSlide = () => setCurrentSlide((prev) => (prev - 1 + allCards.length) % allCards.length);

            // Function to get 3 cards centered around current index
            const getVisibleCards = () => {
                if (allCards.length === 0) return [];
                const cards = [];
                for (let i = 0; i < 3; i++) {
                    const index = (currentSlide + i) % allCards.length;
                    cards.push(allCards[index]);
                }
                return cards;
            };

            
            return (
                <div className="kpi-carousel-wrapper" style={{marginBottom: '0px'}}>
                    <div className="kpi-carousel" style={{minHeight: '200px', height: 'auto'}}>
                        <div className="kpi-slide" style={{minHeight: '200px'}}>
                            {getVisibleCards().map((card, index) => (
                                <div key={`card-${index}`} style={{height: '100%'}}>{card}</div>
                            ))}
                        </div>
                    </div>
                    
                    <div className="kpi-controls" style={{marginTop: '0px', marginBottom: '0px'}}>
                        <button className="kpi-nav-btn" onClick={prevSlide}>
                            
                        </button>
                        
                        <div className="kpi-indicators">
                            {allCards.map((_, index) => (
                                <div
                                    key={index}
                                    className={`kpi-indicator ${index === currentSlide ? 'active' : ''}`}
                                    onClick={() => setCurrentSlide(index)}
                                />
                            ))}
                        </div>
                        
                        <button className="kpi-nav-btn" onClick={nextSlide}>
                            
                        </button>
                    </div>
                </div>
            );
        };

        const EntityCard = ({ entity, entityType, index }) => {
            const hasOneGov = entity.isOneGov === true;
            const isBoxEntity = entity.name === "Box";
            
            // Inline style for OneGov orange glow OR hardcoded Box entity
            const orangeStyle = (hasOneGov || isBoxEntity) ? {
                border: '2px solid orange',
                boxShadow: '0 0 15px orange'
            } : {};
            
            if (hasOneGov) {
            }
            
            if (isBoxEntity) {
            }
            
            return (
                <div className="entity-card" style={orangeStyle} onClick={() => openEntityDetail(index)}>
                    <div className="entity-header">
                        <div className="header-left-section">
                            <div className="entity-type-symbol">
                                {entityType === 'OEMs' ? 'OEM' : 
                                 entityType === 'Vendors' ? 'VENDOR' : 'AGENCY'}
                            </div>
                            <div className="entity-name" style={{color: 'var(--orange)'}}>{entity.name}</div>
                        </div>
                        {entity.tier && (
                            <div className="entity-tier-badge">{entity.tier}</div>
                        )}
                    </div>
                    
                    <div className="entity-card-body">
                        {/* Obligations row - exact match to original */}
                        <div style={{display: 'flex', gap: '6px', background: '#f8f9fa', padding: '4px 6px', borderRadius: '3px', textAlign: 'center'}}>
                            <div style={{flex: 1}}>
                                <div className="amount-label">Obligations</div>
                                <div className="amount-value">{formatCurrencyShort(entity.totalObligations || 0)}</div>
                            </div>
                            {entity.averageObligationsPerYear && (
                                <div style={{flex: 1}}>
                                    <div className="amount-label">FY Average</div>
                                    <div className="amount-value">{formatCurrencyShort(entity.averageObligationsPerYear)}</div>
                                </div>
                            )}
                        </div>
                        
                        {/* Fiscal year trends chart without label */}
                        {entity.fiscalYearObligations && (
                            <div style={{marginTop: '6px'}}>
                                {ChartFactory.createFiscalYearChart(entity.fiscalYearObligations, {
                                    maxYears: 4,
                                    showValues: false,
                                    barHeight: 4
                                })}
                            </div>
                        )}
                        
                        {/* 4 data quadrants - exact match to original */}
                        <div style={{
                            display: 'grid', 
                            gridTemplateColumns: '1fr 1fr', 
                            gap: '8px', 
                            marginTop: '8px',
                            fontSize: '0.9rem'
                        }}>
                            {/* Top Left: SUM Tier Distribution */}
                            <div style={{background: '#f8f9fa', padding: '6px', borderRadius: '3px', border: '1px solid #e5e7eb'}}>
                                <div style={{color: 'var(--blue)', fontWeight: 600, marginBottom: '3px', textAlign: 'center'}}>SUM Tier</div>
                                <div style={{maxHeight: '120px', overflowY: 'auto'}}>
                                    <table style={{width: '100%', fontSize: '0.8rem'}}>
                                        <colgroup>
                                            <col style={{width: '70%'}} />
                                            <col style={{width: '30%'}} />
                                        </colgroup>
                                        <thead>
                                            <tr style={{color: 'var(--blue)'}}>
                                                <th style={{textAlign: 'left', fontWeight: 700, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}}>Tier</th>
                                                <th style={{textAlign: 'right', fontWeight: 700, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}}>Amount & %</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                const tierData = entity.sumTier?.tier_summaries || entity.oneGovTier?.tier_breakdown || {};
                                                const items = Object.entries(tierData)
                                                    .map(([tier, data]) => ({
                                                        name: tier.replace('Tier ', 'TIER '),
                                                        total: typeof data === 'object' ? (data.total || data.value || 0) : (data || 0)
                                                    }))
                                                    .filter(item => item.total > 0)
                                                    .sort((a, b) => b.total - a.total)
                                                    .slice(0, 5);
                                                
                                                const totalValue = items.reduce((sum, item) => sum + item.total, 0);
                                                const entityTotal = entity.totalObligations || totalValue;
                                                
                                                return items.length > 0 ? items.map((item, i) => {
                                                    const percentage = entityTotal > 0 ? (item.total / entityTotal * 100).toFixed(0) : 0;
                                                    const formattedAmount = formatCurrencyShort(item.total);
                                                    return (
                                                        <tr key={i} style={{color: 'var(--dark-blue)'}}>
                                                            <td style={{fontWeight: 700, paddingRight: '2px', fontSize: '0.7rem', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '0'}}>{item.name}</td>
                                                            <td style={{textAlign: 'right', fontWeight: 600, fontSize: '0.7rem', whiteSpace: 'nowrap'}}>
                                                                {formattedAmount} ({percentage}%)
                                                            </td>
                                                        </tr>
                                                    );
                                                }) : (
                                                    <tr><td colSpan={2} style={{textAlign: 'center', color: '#666', fontStyle: 'italic'}}>No data</td></tr>
                                                );
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Top Right: Contract Vehicles */}
                            <div style={{background: '#f8f9fa', padding: '6px', borderRadius: '3px', border: '1px solid #e5e7eb'}}>
                                <div style={{color: 'var(--blue)', fontWeight: 600, marginBottom: '3px', textAlign: 'center'}}>Contract Vehicles</div>
                                <div style={{maxHeight: '120px', overflowY: 'auto'}}>
                                    <table style={{width: '100%', fontSize: '0.85rem'}}>
                                        <colgroup>
                                            <col style={{width: '70%'}} />
                                            <col style={{width: '30%'}} />
                                        </colgroup>
                                        <thead>
                                            <tr style={{color: 'var(--blue)'}}>
                                                <th style={{textAlign: 'left', fontWeight: 700, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}}>Vehicle</th>
                                                <th style={{textAlign: 'right', fontWeight: 700, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}}>Amount & %</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                // Use Contract Vehicles data - same as KPI card processedData.contractVehicles
                                                let contractVehicleData = {};
                                                
                                                // Use entity.contractVehicle data (same as how it's processed for KPI cards)
                                                if (entity.contractVehicle && typeof entity.contractVehicle === 'object') {
                                                    // Check for top_contract_summaries structure
                                                    if (entity.contractVehicle.top_contract_summaries) {
                                                        Object.entries(entity.contractVehicle.top_contract_summaries).forEach(([vehicle, data]) => {
                                                            const amount = data.total || data.obligations || 0;
                                                            contractVehicleData[vehicle] = (contractVehicleData[vehicle] || 0) + amount;
                                                        });
                                                    }
                                                    // Fallback to direct entries
                                                    else {
                                                        Object.entries(entity.contractVehicle).forEach(([vehicle, data]) => {
                                                            if (vehicle !== 'summary' && vehicle !== 'processed_date' && vehicle !== 'source_file') {
                                                                const amount = typeof data === 'object' ? data.total || 0 : data || 0;
                                                                contractVehicleData[vehicle] = (contractVehicleData[vehicle] || 0) + amount;
                                                            }
                                                        });
                                                    }
                                                }
                                                
                                                const items = Object.entries(contractVehicleData)
                                                    .map(([name, total]) => ({
                                                        name: name.length > 18 ? name.substring(0, 18) + '...' : name,
                                                        total: total || 0
                                                    }))
                                                    .filter(item => item.total > 0)
                                                    .sort((a, b) => b.total - a.total)
                                                    .slice(0, 5);
                                                
                                                const totalValue = items.reduce((sum, item) => sum + item.total, 0);
                                                const entityTotal = entity.totalObligations || totalValue;
                                                
                                                return items.length > 0 ? items.map((item, i) => {
                                                    const percentage = entityTotal > 0 ? (item.total / entityTotal * 100).toFixed(0) : 0;
                                                    const formattedAmount = formatCurrencyShort(item.total);
                                                    return (
                                                        <tr key={i} style={{color: 'var(--dark-blue)'}}>
                                                            <td style={{fontWeight: 700, paddingRight: '2px', fontSize: '0.7rem', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '0'}}>{item.name}</td>
                                                            <td style={{textAlign: 'right', fontWeight: 600, fontSize: '0.7rem', whiteSpace: 'nowrap'}}>
                                                                {formattedAmount} ({percentage}%)
                                                            </td>
                                                        </tr>
                                                    );
                                                }) : (
                                                    <tr><td colSpan={2} style={{textAlign: 'center', color: '#666', fontStyle: 'italic'}}>No data</td></tr>
                                                );
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Bottom Left: First Entity Relationship Table */}
                            {(() => {
                                // Show entity relationship tables
                                if (entity.fasOem) {
                                    if (entity.fasOem.top_10_oem_summaries) {
                                        console.log(` top_10_oem_summaries count:`, Object.keys(entity.fasOem.top_10_oem_summaries).length);
                                        const firstOem = Object.entries(entity.fasOem.top_10_oem_summaries)[0];
                                        if (firstOem) {
                                            console.log(` first OEM:`, firstOem[0], firstOem[1]);
                                        }
                                    } else {
                                        console.log(` fasOem keys:`, Object.keys(entity.fasOem));
                                    }
                                } else {
                                    console.log(` fasOem is missing from entity data!`);
                                }

                                // Extra debugging for bicOem structure if it exists
                                if (entity.bicOem) {
                                    console.log(` bicOem structure:`, entity.bicOem);
                                    if (entity.bicOem.top_15_manufacturers) {
                                        console.log(` top_15_manufacturers length:`, entity.bicOem.top_15_manufacturers.length);
                                        if (entity.bicOem.top_15_manufacturers.length > 0) {
                                            console.log(` first manufacturer:`, entity.bicOem.top_15_manufacturers[0]);
                                        }
                                    } else {
                                        console.log(` bicOem keys:`, Object.keys(entity.bicOem));
                                    }
                                }
                                
                                // Extra debugging for fundingAgency structure if it exists
                                if (entity.fundingAgency) {
                                    console.log(` fundingAgency structure:`, entity.fundingAgency);
                                    if (entity.fundingAgency.top_10_agency_summaries) {
                                        console.log(` top_10_agency_summaries keys:`, Object.keys(entity.fundingAgency.top_10_agency_summaries).slice(0, 3));
                                    } else {
                                        console.log(` fundingAgency keys:`, Object.keys(entity.fundingAgency));
                                    }
                                }
                                
                                // Extra debugging for reseller structure if it exists
                                if (entity.reseller) {
                                    console.log(` reseller structure:`, entity.reseller);
                                    console.log(` reseller keys:`, Object.keys(entity.reseller).slice(0, 5));
                                    if (entity.reseller.top_15_reseller_summaries) {
                                        console.log(` top_15_reseller_summaries found:`, Object.keys(entity.reseller.top_15_reseller_summaries).slice(0, 3));
                                    }
                                }
                                
                                // Determine which tables to show based on entity type
                                let firstTableData = {};
                                let firstTableTitle = '';
                                
                                if (entityType === 'Agencies') {
                                    // Agency cards show OEMs table
                                    firstTableTitle = 'OEMs';
                                    
                                    console.log(` AGENCY OEM TABLE DEBUG: "${entity.name}"`);
                                    console.log(`  - entity.fasOem exists:`, !!entity.fasOem);
                                    console.log(`  - entity.fasOem?.top_15_oem_summaries exists:`, !!entity.fasOem?.top_15_oem_summaries);
                                    console.log(`  - entity.fasOem?.top_10_oem_summaries exists:`, !!entity.fasOem?.top_10_oem_summaries);
                                    if (entity.fasOem) {
                                        console.log(`  - fasOem keys:`, Object.keys(entity.fasOem));
                                        if (entity.fasOem.top_15_oem_summaries) {
                                            console.log(`  - OEM count (top_15):`, Object.keys(entity.fasOem.top_15_oem_summaries).length);
                                        }
                                        if (entity.fasOem.top_10_oem_summaries) {
                                            console.log(`  - OEM count (top_10):`, Object.keys(entity.fasOem.top_10_oem_summaries).length);
                                        }
                                    }
                                    
                                    // Use FAS OEM data (Column U) for OEM relationships - now using top_15
                                    if (entity.fasOem?.top_15_oem_summaries) {
                                        console.log(` AGENCY->OEM: Found FAS OEM top_15_oem_summaries`);
                                        const oemEntries = Object.entries(entity.fasOem.top_15_oem_summaries);
                                        console.log(`  Total OEM entries: ${oemEntries.length}`);
                                        oemEntries.forEach(([oemName, data], idx) => {
                                            console.log(`  Processing OEM ${idx}: ${oemName}`, data);
                                            // FAS OEM structure: { total: number, percentage_of_total: "X.XX%" }
                                            const value = data?.total || data?.total_obligations || 0;
                                            console.log(`    Value extracted: ${value}`);
                                            if (value > 0) {
                                                firstTableData[oemName] = value;
                                                console.log(`     Added to firstTableData: ${oemName} = $${value.toLocaleString()}`);
                                            } else {
                                                console.log(`     Skipped (value is 0 or missing)`);
                                            }
                                        });
                                        console.log(`  Final firstTableData:`, firstTableData);
                                    } else if (entity.bicOem?.top_15_manufacturer_summaries) {
                                        // Fallback to BIC OEM if FAS OEM not available
                                        console.log(` AGENCY->OEM: Fallback to BIC OEM top_15_manufacturer_summaries`);
                                        Object.entries(entity.bicOem.top_15_manufacturer_summaries).forEach(([oemName, data]) => {
                                            const value = typeof data === 'object' ? (data.total || data.amount || 0) : data || 0;
                                            if (value > 0) {
                                                firstTableData[oemName] = (firstTableData[oemName] || 0) + value;
                                            }
                                        });
                                    } else if (entity.bicOem?.top_15_manufacturers && Array.isArray(entity.bicOem.top_15_manufacturers)) {
                                        // Original array structure fallback
                                        console.log(` AGENCY->OEM: Fallback to BIC OEM manufacturers array`);
                                        entity.bicOem.top_15_manufacturers.forEach((manufacturer, idx) => {
                                            if (manufacturer && idx < 3) {
                                                console.log(`  Manufacturer ${idx}:`, manufacturer);
                                            }
                                            if (manufacturer) {
                                                const oemName = manufacturer.manufacturer_name || manufacturer.name || manufacturer.OEM || manufacturer.oem;
                                                const value = manufacturer.total || manufacturer.value || manufacturer.amount || 0;
                                                if (oemName && value) {
                                                    firstTableData[oemName] = (firstTableData[oemName] || 0) + value;
                                                }
                                            }
                                        });
                                    } else if (entity.fasOem || entity.bicOem) {
                                        // Try direct object entries as last resort
                                        console.log(` AGENCY->OEM: Trying direct object entries from bicOem`);
                                        console.log(`  bicOem keys:`, Object.keys(entity.bicOem).slice(0, 5));
                                        // Check if there are any summaries keys
                                        const summaryKeys = Object.keys(entity.bicOem).filter(k => k.includes('summar'));
                                        if (summaryKeys.length > 0) {
                                            console.log(`  Found summary keys:`, summaryKeys);
                                        }
                                    } else {
                                        console.log(` AGENCY->OEM: No bicOem data found at all`);
                                    }
                                } else if (entityType === 'OEMs') {
                                    // OEM cards show Agencies table  
                                    firstTableTitle = 'Agencies';
                                    if (entity.fundingAgency?.top_10_agency_summaries) {
                                        Object.entries(entity.fundingAgency.top_10_agency_summaries).forEach(([agencyName, data]) => {
                                            if (typeof data === 'object' && data.total) {
                                                const abbrev = getAgencyAbbreviation(agencyName);
                                                firstTableData[abbrev] = (firstTableData[abbrev] || 0) + data.total;
                                            }
                                        });
                                    }
                                } else if (entityType === 'Vendors') {
                                    // Vendor cards show Agencies table
                                    firstTableTitle = 'Agencies';  
                                    if (entity.fundingAgency?.top_10_agency_summaries) {
                                        Object.entries(entity.fundingAgency.top_10_agency_summaries).forEach(([agencyName, data]) => {
                                            if (typeof data === 'object' && data.total) {
                                                const abbrev = getAgencyAbbreviation(agencyName);
                                                firstTableData[abbrev] = (firstTableData[abbrev] || 0) + data.total;
                                            }
                                        });
                                    }
                                }
                                
                                console.log(` PROCESSING firstTableData for ${entityType}:`, firstTableData);
                                const items = Object.entries(firstTableData)
                                    .map(([name, total]) => ({
                                        name: name.length > 16 ? name.substring(0, 16) + '...' : name,
                                        total: total || 0
                                    }))
                                    .filter(item => item.total > 0)
                                    .sort((a, b) => b.total - a.total)
                                    .slice(0, 5);
                                console.log(` FINAL items for ${firstTableTitle}:`, items);
                                
                                // Calculate total from the full JSON data for percentage calculation
                                let jsonTotal = 0;
                                if (entityType === 'Agencies') {
                                    // Use FAS OEM data for total calculation - now using top_15
                                    if (entity.fasOem?.top_15_oem_summaries) {
                                        jsonTotal = Object.values(entity.fasOem.top_15_oem_summaries).reduce((sum, data) => 
                                            sum + (data?.total || data?.total_obligations || 0), 0);
                                    } else if (entity.fasOem?.top_10_oem_summaries) {
                                        // Fallback to top_10 if available
                                        jsonTotal = Object.values(entity.fasOem.top_10_oem_summaries).reduce((sum, data) => 
                                            sum + (data?.total || data?.total_obligations || 0), 0);
                                    } else if (entity.bicOem?.top_15_manufacturers) {
                                        // Fallback to BIC OEM
                                        jsonTotal = entity.bicOem.top_15_manufacturers.reduce((sum, manufacturer) => 
                                            sum + (manufacturer?.total || manufacturer?.value || manufacturer?.amount || 0), 0);
                                    }
                                } else if ((entityType === 'OEMs' || entityType === 'Vendors') && entity.fundingAgency?.top_10_agency_summaries) {
                                    jsonTotal = Object.values(entity.fundingAgency.top_10_agency_summaries).reduce((sum, data) => 
                                        sum + (typeof data === 'object' ? data.total || 0 : 0), 0);
                                }
                                
                                return (
                                    <div style={{background: '#f8f9fa', padding: '6px', borderRadius: '3px', border: '1px solid #e5e7eb'}}>
                                        <div style={{color: 'var(--blue)', fontWeight: 600, marginBottom: '3px', textAlign: 'center'}}>{firstTableTitle}</div>
                                        <div style={{maxHeight: '120px', overflowY: 'auto'}}>
                                            <table style={{width: '100%', fontSize: '0.85rem'}}>
                                                <colgroup>
                                                    <col style={{width: '70%'}} />
                                                    <col style={{width: '30%'}} />
                                                </colgroup>
                                                <thead>
                                                    <tr style={{color: 'var(--blue)'}}>
                                                        <th style={{textAlign: 'left', fontWeight: 700, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}}>Name</th>
                                                        <th style={{textAlign: 'right', fontWeight: 700, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}}>Amount & %</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {items.length > 0 ? items.map((item, i) => {
                                                        const percentage = jsonTotal > 0 ? (item.total / jsonTotal * 100).toFixed(0) : 0;
                                                        const formattedAmount = formatCurrencyShort(item.total);
                                                        return (
                                                            <tr key={i} style={{color: 'var(--dark-blue)'}}>
                                                                <td style={{fontWeight: 700, paddingRight: '2px', fontSize: '0.7rem', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '0'}}>{item.name}</td>
                                                                <td style={{textAlign: 'right', fontWeight: 600, fontSize: '0.7rem', whiteSpace: 'nowrap'}}>
                                                                    {formattedAmount} ({percentage}%)
                                                                </td>
                                                            </tr>
                                                        );
                                                    }) : (
                                                        <tr><td colSpan={2} style={{textAlign: 'center', color: '#666', fontStyle: 'italic'}}>No data</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* Bottom Right: Second Entity Relationship Table */}
                            {(() => {
                                // Determine second table based on entity type
                                let secondTableData = {};
                                let secondTableTitle = '';
                                
                                if (entityType === 'Agencies') {
                                    // Agency cards show Vendors table
                                    secondTableTitle = 'Vendors';
                                    
                                    // The vendor data for agencies might be in fundingAgency column (misnamed)
                                    // Check if fundingAgency actually contains vendor/reseller data
                                    if (entity.fundingAgency?.top_10_vendor_summaries) {
                                        console.log(` AGENCY->VENDOR: Found top_10_vendor_summaries in fundingAgency`);
                                        Object.entries(entity.fundingAgency.top_10_vendor_summaries).forEach(([vendorName, data]) => {
                                            const amount = typeof data === 'object' ? (data.total || data.amount || 0) : data || 0;
                                            if (amount > 0) {
                                                secondTableData[vendorName] = (secondTableData[vendorName] || 0) + amount;
                                            }
                                        });
                                    } else if (entity.fundingAgency?.top_15_reseller_summaries) {
                                        console.log(` AGENCY->VENDOR: Found top_15_reseller_summaries in fundingAgency`);
                                        Object.entries(entity.fundingAgency.top_15_reseller_summaries).forEach(([vendorName, data]) => {
                                            const amount = typeof data === 'object' ? (data.total || data.amount || 0) : data || 0;
                                            if (amount > 0) {
                                                secondTableData[vendorName] = (secondTableData[vendorName] || 0) + amount;
                                            }
                                        });
                                    } else if (entity.reseller?.top_15_reseller_summaries) {
                                        // Original check for reseller column (which seems to be empty)
                                        console.log(` AGENCY->VENDOR: Found top_15_reseller_summaries in reseller column`);
                                        Object.entries(entity.reseller.top_15_reseller_summaries).forEach(([resellerName, data]) => {
                                            const amount = typeof data === 'object' ? (data.total || data.amount || 0) : data || 0;
                                            if (amount > 0) {
                                                secondTableData[resellerName] = (secondTableData[resellerName] || 0) + amount;
                                            }
                                        });
                                    } else if (entity.reseller) {
                                        // Fallback to direct object entries if structure is different
                                        console.log(` AGENCY->VENDOR: Trying direct reseller object`);
                                        Object.entries(entity.reseller).forEach(([resellerName, data]) => {
                                            const amount = typeof data === 'object' ? (data.total || data.amount || 0) : data || 0;
                                            if (amount > 0) {
                                                secondTableData[resellerName] = (secondTableData[resellerName] || 0) + amount;
                                            }
                                        });
                                    } else {
                                        console.log(` AGENCY->VENDOR: No vendor data found. fundingAgency keys:`, 
                                            entity.fundingAgency ? Object.keys(entity.fundingAgency) : 'none');
                                        
                                        // Check if there's vendor data under different names in fundingAgency
                                        if (entity.fundingAgency) {
                                            const possibleVendorKeys = Object.keys(entity.fundingAgency).filter(k => 
                                                k.includes('vendor') || k.includes('reseller') || k.includes('contractor'));
                                            if (possibleVendorKeys.length > 0) {
                                                console.log(` AGENCY->VENDOR: Found possible vendor keys:`, possibleVendorKeys);
                                            }
                                            
                                            // Since fundingAgency.top_10_agency_summaries exists but is wrong type,
                                            // let's confirm what it contains
                                            if (entity.fundingAgency.top_10_agency_summaries) {
                                                const sampleKeys = Object.keys(entity.fundingAgency.top_10_agency_summaries).slice(0, 2);
                                                console.log(` AGENCY->VENDOR: top_10_agency_summaries contains (should be vendors, not agencies):`, sampleKeys);
                                            }
                                        }
                                        
                                        // Column R is empty - this is where vendor data SHOULD be
                                        console.log(` AGENCY->VENDOR: Column R (reseller) is EMPTY. This column needs to be populated with vendor data.`);
                                    }
                                } else if (entityType === 'OEMs') {
                                    // OEM cards show Vendors table
                                    secondTableTitle = 'Vendors';
                                    // OEMs use entity.resellers (plural) not entity.reseller
                                    // Check for top_15_reseller_summaries structure (similar to how bicOem works)
                                    if (entity.resellers?.top_15_reseller_summaries) {
                                        Object.entries(entity.resellers.top_15_reseller_summaries).forEach(([vendorName, data]) => {
                                            const amount = typeof data === 'object' ? (data.total || data.amount || 0) : data || 0;
                                            if (amount > 0) {
                                                secondTableData[vendorName] = (secondTableData[vendorName] || 0) + amount;
                                            }
                                        });
                                    } else if (entity.reseller?.top_15_reseller_summaries) {
                                        Object.entries(entity.reseller.top_15_reseller_summaries).forEach(([resellerName, data]) => {
                                            const amount = typeof data === 'object' ? (data.total || data.amount || 0) : data || 0;
                                            if (amount > 0) {
                                                secondTableData[resellerName] = (secondTableData[resellerName] || 0) + amount;
                                            }
                                        });
                                    } else if (entity.reseller) {
                                        // Fallback to direct object entries if structure is different
                                        Object.entries(entity.reseller).forEach(([resellerName, data]) => {
                                            const amount = typeof data === 'object' ? (data.total || data.amount || 0) : data || 0;
                                            if (amount > 0) {
                                                secondTableData[resellerName] = (secondTableData[resellerName] || 0) + amount;
                                            }
                                        });
                                    }
                                } else if (entityType === 'Vendors') {
                                    // Vendor cards show OEMs table
                                    secondTableTitle = 'OEMs';
                                    
                                    // Use FAS OEM data (Column U) for OEM relationships - now using top_15
                                    if (entity.fasOem?.top_15_oem_summaries) {
                                        console.log(` VENDOR->OEM: Found FAS OEM top_15_oem_summaries`);
                                        Object.entries(entity.fasOem.top_15_oem_summaries).forEach(([oemName, data]) => {
                                            // FAS OEM structure: { total: number, percentage_of_total: "X.XX%" }
                                            const value = data?.total || data?.total_obligations || 0;
                                            if (value > 0) {
                                                secondTableData[oemName] = value;
                                                console.log(`  OEM: ${oemName} = $${value.toLocaleString()}`);
                                            }
                                        });
                                    } else if (entity.bicOem?.top_15_manufacturer_summaries) {
                                        // Fallback to BIC OEM if FAS OEM not available
                                        console.log(` VENDOR->OEM: Fallback to BIC OEM top_15_manufacturer_summaries`);
                                        Object.entries(entity.bicOem.top_15_manufacturer_summaries).forEach(([oemName, data]) => {
                                            const value = typeof data === 'object' ? (data.total || data.amount || 0) : data || 0;
                                            if (value > 0) {
                                                secondTableData[oemName] = (secondTableData[oemName] || 0) + value;
                                            }
                                        });
                                    } else if (entity.bicOem?.top_15_manufacturers && Array.isArray(entity.bicOem.top_15_manufacturers)) {
                                        // Original array structure fallback
                                        console.log(` VENDOR->OEM: Fallback to BIC OEM manufacturers array`);
                                        entity.bicOem.top_15_manufacturers.forEach((manufacturer) => {
                                            if (manufacturer) {
                                                const oemName = manufacturer.manufacturer_name || manufacturer.name || manufacturer.OEM || manufacturer.oem;
                                                const value = manufacturer.total || manufacturer.value || manufacturer.amount || 0;
                                                if (oemName && value) {
                                                    secondTableData[oemName] = (secondTableData[oemName] || 0) + value;
                                                }
                                            }
                                        });
                                    } else if (entity.fasOem || entity.bicOem) {
                                        // Try to find what keys actually exist
                                        console.log(` VENDOR->OEM: Checking FAS/BIC OEM structure`);
                                        if (entity.fasOem) console.log(`  fasOem keys:`, Object.keys(entity.fasOem));
                                        if (entity.bicOem) console.log(`  bicOem keys:`, Object.keys(entity.bicOem));
                                    }
                                }
                                
                                const items = Object.entries(secondTableData)
                                    .map(([name, total]) => ({
                                        name: name.length > 16 ? name.substring(0, 16) + '...' : name,
                                        total: total || 0
                                    }))
                                    .filter(item => item.total > 0)
                                    .sort((a, b) => b.total - a.total)
                                    .slice(0, 5);
                                
                                // Calculate total from the full JSON data for percentage calculation
                                let jsonTotal = 0;
                                if (entityType === 'Agencies') {
                                    if (entity.reseller?.top_15_reseller_summaries) {
                                        jsonTotal = Object.values(entity.reseller.top_15_reseller_summaries).reduce((sum, data) => 
                                            sum + (typeof data === 'object' ? (data.total || data.amount || 0) : data || 0), 0);
                                    } else if (entity.reseller) {
                                        jsonTotal = Object.values(entity.reseller).reduce((sum, data) => 
                                            sum + (typeof data === 'object' ? (data.total || data.amount || 0) : data || 0), 0);
                                    }
                                } else if (entityType === 'OEMs') {
                                    // OEMs use entity.resellers (plural)
                                    if (entity.resellers?.top_15_reseller_summaries) {
                                        jsonTotal = Object.values(entity.resellers.top_15_reseller_summaries).reduce((sum, data) => 
                                            sum + (typeof data === 'object' ? (data.total || data.amount || 0) : data || 0), 0);
                                    } else if (entity.resellers) {
                                        jsonTotal = Object.values(entity.resellers).reduce((sum, data) => 
                                            sum + (typeof data === 'object' ? (data.total || data.amount || 0) : data || 0), 0);
                                    }
                                } else if (entityType === 'Vendors') {
                                    // Use FAS OEM data for Vendor OEM relationships - now using top_15
                                    if (entity.fasOem?.top_15_oem_summaries) {
                                        jsonTotal = Object.values(entity.fasOem.top_15_oem_summaries).reduce((sum, data) => 
                                            sum + (data?.total || data?.total_obligations || 0), 0);
                                    } else if (entity.fasOem?.top_10_oem_summaries) {
                                        // Fallback to top_10 if available
                                        jsonTotal = Object.values(entity.fasOem.top_10_oem_summaries).reduce((sum, data) => 
                                            sum + (data?.total || data?.total_obligations || 0), 0);
                                    } else if (entity.bicOem?.top_15_manufacturers) {
                                        // Fallback to BIC OEM
                                        jsonTotal = entity.bicOem.top_15_manufacturers.reduce((sum, manufacturer) => 
                                            sum + (manufacturer?.total || manufacturer?.value || manufacturer?.amount || 0), 0);
                                    }
                                }
                                
                                return (
                                    <div style={{background: '#f8f9fa', padding: '6px', borderRadius: '3px', border: '1px solid #e5e7eb'}}>
                                        <div style={{color: 'var(--blue)', fontWeight: 600, marginBottom: '3px', textAlign: 'center'}}>{secondTableTitle}</div>
                                        <div style={{maxHeight: '120px', overflowY: 'auto'}}>
                                            <table style={{width: '100%', fontSize: '0.85rem'}}>
                                                <colgroup>
                                                    <col style={{width: '70%'}} />
                                                    <col style={{width: '30%'}} />
                                                </colgroup>
                                                <thead>
                                                    <tr style={{color: 'var(--blue)'}}>
                                                        <th style={{textAlign: 'left', fontWeight: 700, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}}>Name</th>
                                                        <th style={{textAlign: 'right', fontWeight: 700, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}}>Amount & %</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {items.length > 0 ? items.map((item, i) => {
                                                        const percentage = jsonTotal > 0 ? (item.total / jsonTotal * 100).toFixed(0) : 0;
                                                        const formattedAmount = formatCurrencyShort(item.total);
                                                        return (
                                                            <tr key={i} style={{color: 'var(--dark-blue)'}}>
                                                                <td style={{fontWeight: 700, paddingRight: '2px', fontSize: '0.7rem', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '0'}}>{item.name}</td>
                                                                <td style={{textAlign: 'right', fontWeight: 600, fontSize: '0.7rem', whiteSpace: 'nowrap'}}>
                                                                    {formattedAmount} ({percentage}%)
                                                                </td>
                                                            </tr>
                                                        );
                                                    }) : (
                                                        <tr><td colSpan={2} style={{textAlign: 'center', color: '#666', fontStyle: 'italic'}}>No data</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                    </div>
                </div>
            );
        };

        const EntityGrid = ({ entities, entityType }) => {
            return (
                <div className="entity-grid-container">
                    <div className="entity-grid">
                        {entities.map((entity, index) => (
                            <EntityCard key={entity.id} entity={entity} entityType={entityType} index={index} />
                        ))}
                    </div>
                </div>
            );
        };

        // Entity detail popup functionality  
        let currentEntities = [];
        
        const openEntityDetail = (entityIndex) => {
            const entity = currentEntities[entityIndex];
            console.log(' OPENING ENTITY DETAIL:', {
                entityIndex,
                entityName: entity?.name,
                entityType: entity?.type,
                hasFasTable: !!entity?.fasTable,
                hasBicTable: !!entity?.bicTable,
                fasTableSize: entity?.fasTable?.length || 0,
                bicTableSize: entity?.bicTable?.length || 0
            });
            if (!entity) return;
            
            // Process entity JSON data for charts
            const processEntityData = (entity) => {
                const processed = {
                    fiscalYearData: {},
                    tierData: {},
                    resellerData: {},
                    contractData: {},
                    agencyData: {},
                    aiData: {},
                    totalObligations: entity.totalObligations || 0
                };
                
                // Process fiscal year obligations
                if (entity.fiscalYearObligations) {
                    processed.fiscalYearData = entity.fiscalYearObligations;
                } else if (entity.obligations && entity.obligations.fiscal_year_obligations) {
                    processed.fiscalYearData = entity.obligations.fiscal_year_obligations;
                }
                
                // Process tier data
                if (entity.sumTier && entity.sumTier.tier_summaries) {
                    processed.tierData = entity.sumTier.tier_summaries;
                } else if (entity.oneGovTier && entity.oneGovTier.tier_breakdown) {
                    processed.tierData = entity.oneGovTier.tier_breakdown;
                }
                
                // Process reseller data
                if (entity.resellers) {
                    processed.resellerData = entity.resellers;
                }
                
                // Process funding agencies as "customers"
                if (entity.fundingAgency && entity.fundingAgency.top_10_agency_summaries) {
                    processed.agencyData = entity.fundingAgency.top_10_agency_summaries;
                }
                
                // Process contract vehicles
                if (entity.contractVehicle) {
                    processed.contractData = entity.contractVehicle;
                }
                
                return processed;
            };
            
            // Debug: Log the entity data structure before modal creation
            console.log(` MODAL DEBUG: Entity "${entity.name}" structure:`, entity);
            console.log(' MODAL DEBUG: Entity usaiProfile:', entity.usaiProfile);
            console.log(' MODAL DEBUG: Overview exists:', !!entity.usaiProfile?.overview);
            console.log(' MODAL DEBUG: Website:', entity.usaiProfile?.website);
            console.log(' MODAL DEBUG: LinkedIn:', entity.usaiProfile?.linkedin);
            
            // Also debug contract vehicle data for vendors
            if (entity.type === 'vendor' && entity.contractVehicle) {
                console.log(' VENDOR CONTRACT VEHICLE: Raw data:', entity.contractVehicle);
                console.log(' VENDOR CONTRACT VEHICLE: Has top_contract_summaries:', !!entity.contractVehicle?.top_contract_summaries);
                if (entity.contractVehicle?.top_contract_summaries) {
                    console.log(' VENDOR CONTRACT VEHICLE: Contract summaries keys:', Object.keys(entity.contractVehicle.top_contract_summaries));
                }
            }
            
            const entityData = processEntityData(entity);
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 1000;
                overflow-y: auto;
            `;
            
            // Create full-screen detail view matching amazon_detail_carousel.html
            modalOverlay.innerHTML = `
                <div style="min-height: 100vh; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blue) 100%); color: white; padding: 16px 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                        <div style="max-width: 1800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                                <span style="color: rgba(255,255,255,0.8); cursor: pointer;" onclick="this.closest('.modal-overlay').remove()">OneGov FIT</span>
                                <span style="color: rgba(255,255,255,0.6);"></span>
                                <span style="color: rgba(255,255,255,0.8);">${entity.type?.toUpperCase() || 'Entity'}s</span>
                                <span style="color: rgba(255,255,255,0.6);"></span>
                                <span>${entity.name}</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div>
                                    <h1 style="font-size: 1.5rem; margin-bottom: 4px;">${entity.name}</h1>
                                    <div style="display: flex; gap: 16px; font-size: 0.8rem; opacity: 0.9;">
                                        <span>Total Obligations: ${formatCurrencyShort(entity.totalObligations || 0)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                                <span style="background: var(--orange); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">
                                    ${entity.type?.toUpperCase() || 'ENTITY'}
                                </span>
                                ${entity.tier ? `<span style="background: var(--orange); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">${entity.tier}</span>` : ''}
                            </div>
                            
                            <button onclick="this.closest('.modal-overlay').remove()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                color: white;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 1.5rem;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">&times;</button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="max-width: 1800px; margin: 0 auto; padding: 24px;">
                        <!-- Profile Section -->
                        <div style="margin-bottom: 32px;">
                            <h2 style="font-size: 1.4rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 20px; padding-bottom: 8px; border-bottom: 3px solid var(--orange);">
                                ${entity.type?.toUpperCase() || 'Entity'} Profile
                            </h2>
                            <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); padding: 24px; border: 1px solid rgba(0,0,0,0.05);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #f0f0f0;">
                                    <div>
                                        <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px;">${entity.name}</h3>
                                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--blue);">
                                            ${entity.tier ? `<span style="background: var(--green); color: white; padding: 3px 8px; border-radius: 4px; font-weight: 600; font-size: 0.8rem;">${entity.tier} (${formatCurrencyShort(entity.totalObligations || 0)}+)</span>` : ''}
                                            ${entity.parentCompany && entity.parentCompany !== 'N/A' ? `<span style="color: #ccc;"></span><span>Parent: ${entity.parentCompany}</span>` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 12px;">
                                        ${entity.usaiProfile?.website ? `
                                        <a href="${entity.usaiProfile.website.startsWith('http') ? entity.usaiProfile.website : 'https://' + entity.usaiProfile.website}" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           style="
                                               display: flex; 
                                               align-items: center; 
                                               gap: 6px; 
                                               padding: 8px 16px; 
                                               background: var(--blue); 
                                               color: white; 
                                               text-decoration: none; 
                                               border-radius: 6px; 
                                               font-size: 0.9rem; 
                                               font-weight: 500;
                                               transition: background-color 0.2s;
                                           "
                                           onmouseover="this.style.background='var(--dark-blue)'"
                                           onmouseout="this.style.background='var(--blue)'">
                                             Website
                                        </a>` : ''}
                                        ${entity.usaiProfile?.linkedin ? `
                                        <a href="${entity.usaiProfile.linkedin.startsWith('http') ? entity.usaiProfile.linkedin : 'https://' + entity.usaiProfile.linkedin}" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           style="
                                               display: flex; 
                                               align-items: center; 
                                               gap: 6px; 
                                               padding: 8px 16px; 
                                               background: #0077B5; 
                                               color: white; 
                                               text-decoration: none; 
                                               border-radius: 6px; 
                                               font-size: 0.9rem; 
                                               font-weight: 500;
                                               transition: background-color 0.2s;
                                           "
                                           onmouseover="this.style.background='#005582'"
                                           onmouseout="this.style.background='#0077B5'">
                                             LinkedIn
                                        </a>` : ''}
                                    </div>
                                </div>
                                <div style="font-size: 1rem; line-height: 1.6; color: var(--text-dark); padding: 16px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--orange); min-height: 80px; height: auto; word-wrap: break-word; overflow-wrap: break-word;">
                                    ${entity.usaiProfile?.overview || `${entity.name} is a leading ${entity.type?.toLowerCase() || 'organization'} with ${formatCurrencyShort(entity.totalObligations || 0)} in total government obligations. ${entity.tier ? `Classified as ${entity.tier}, this entity represents a significant presence in the federal technology marketplace.` : 'Active in the federal procurement ecosystem.'}${entity.aiProduct ? ' The organization offers AI-enabled products and services to government customers.' : ''}`}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Analytics Carousel -->
                        <div style="margin-bottom: 32px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="font-size: 1.4rem; font-weight: 700; color: var(--dark-blue); padding-bottom: 8px; border-bottom: 3px solid var(--orange);">
                                    Performance Analytics Dashboard
                                </h2>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <button onclick="prevDetailSlide()" style="width: 40px; height: 40px; border-radius: 50%; background: var(--blue); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;"></button>
                                    <div id="detail-indicators" style="display: flex; gap: 8px;"></div>
                                    <button onclick="nextDetailSlide()" style="width: 40px; height: 40px; border-radius: 50%; background: var(--blue); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;"></button>
                                </div>
                            </div>
                            
                            <div id="detail-carousel-container" style="overflow: hidden; border-radius: 8px;">
                                <div id="detail-carousel-track" style="display: flex; transition: transform 0.3s ease;">
                                    ${generateDetailSlides(entity, entityData)}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dual Procurement Tables Section -->
                        ${generateProcurementTables(entity)}
                    </div>
                </div>
            `;
            
            modalOverlay.className = 'modal-overlay';
            document.body.appendChild(modalOverlay);
            
            // Initialize carousel
            initDetailCarousel();
            
            // Close on overlay background click (but not on content)
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
        };
        
        // Generate procurement tables (FAS and BIC) for entity detail view - LAZY LOADING
        const generateProcurementTables = (entity) => {
            console.log(' PROCUREMENT TABLES: Checking entity for table URLs:', {
                entityName: entity.name,
                hasFasTableUrl: !!entity.fasTableUrl,
                hasBicTableUrl: !!entity.bicTableUrl,
                fasTableUrl: entity.fasTableUrl?.substring(0, 50) || 'None',
                bicTableUrl: entity.bicTableUrl?.substring(0, 50) || 'None'
            });
            
            if (!entity.fasTableUrl && !entity.bicTableUrl) {
                console.log(' PROCUREMENT TABLES: No FAS or BIC table URLs found for entity:', entity.name);
                return '';
            }
            
            // Global state for lazy loading
            window.currentProcurementEntity = entity;
            window.fasTableData = { data: [], pagination: { currentPage: 1, totalPages: 0 } };
            window.bicTableData = { data: [], pagination: { currentPage: 1, totalPages: 0 } };
            
            // Generate loading placeholder for FAS table
            const generateFasTablePlaceholder = () => {
                if (!entity.fasTableUrl) {
                    return '<div style="background: white; border-radius: 8px; padding: 40px; text-align: center; color: #999;">No FAS procurement data available</div>';
                }
                
                return `
                    <div id="fas-table-container" style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); padding: 20px; max-width: 100%; overflow: hidden;">
                        <h3 style="color: var(--dark-blue); font-weight: 600; margin-bottom: 16px; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                             FAS Procurement Data
                            <span id="fas-table-status" style="font-size: 0.85rem; font-weight: normal; color: var(--blue); margin-left: 8px; display: inline-block;">
                                Loading...
                            </span>
                        </h3>
                        <div id="fas-table-content" style="text-align: center; padding: 40px; color: var(--blue); width: 100%;">
                             Loading FAS procurement data...
                        </div>
                    </div>
                `;
            };
            
            // Generate loading placeholder for BIC table
            const generateBicTablePlaceholder = () => {
                if (!entity.bicTableUrl) {
                    return '<div style="background: white; border-radius: 8px; padding: 40px; text-align: center; color: #999;">No BIC procurement data available</div>';
                }
                
                return `
                    <div id="bic-table-container" style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); padding: 20px; max-width: 100%; overflow: hidden;">
                        <h3 style="color: var(--dark-blue); font-weight: 600; margin-bottom: 16px; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                             BIC Procurement Data
                            <span id="bic-table-status" style="font-size: 0.85rem; font-weight: normal; color: var(--blue); margin-left: 8px; display: inline-block;">
                                Loading...
                            </span>
                        </h3>
                        <div id="bic-table-content" style="text-align: center; padding: 40px; color: var(--blue); width: 100%;">
                             Loading BIC procurement data...
                        </div>
                    </div>
                `;
            };
            
            // Function to render FAS table with data
            const renderFasTable = (tableData) => {
                const { data, pagination } = tableData;
                
                if (!data || data.length === 0) {
                    return '<div style="text-align: center; padding: 40px; color: #999;">No FAS data found</div>';
                }
                
                // Calculate summary statistics
                const validAmounts = data.filter(row => row.dollars_obligated && !isNaN(parseFloat(row.dollars_obligated)));
                const totalObligations = validAmounts.reduce((sum, row) => sum + parseFloat(row.dollars_obligated || 0), 0);
                const validDates = data.filter(row => {
                    if (!row.date_signed || row.date_signed === 'null' || row.date_signed === '') return false;
                    const date = new Date(row.date_signed);
                    return !isNaN(date.getTime()) && date.getFullYear() > 1900;
                }).map(row => new Date(row.date_signed));
                
                const minDate = validDates.length > 0 ? new Date(Math.min(...validDates)) : null;
                const maxDate = validDates.length > 0 ? new Date(Math.max(...validDates)) : null;
                const dateRange = minDate && maxDate ? `${minDate.toLocaleDateString('en-US')} - ${maxDate.toLocaleDateString('en-US')}` : 'No valid dates';
                
                // CSV download function for FAS
                window.downloadFasCSV = () => {
                    const headers = ['Reference PIID', 'PIID', 'Obligations', 'FPDS Link'];
                    let csv = headers.join(',') + '\n';
                    
                    data.forEach(row => {
                        const fpdsUrl = row.piid && row.reference_piid ? 
                            `https://www.fpds.gov/ezsearch/search.do?indexName=awardfull&templateName=1.5.3&s=FPDS.GOV&q=PIID%3A%22${encodeURIComponent(row.piid)}%22%20%20REF_IDV_PIID%3A%22${encodeURIComponent(row.reference_piid)}%22` : 
                            row.piid ? `https://www.fpds.gov/ezsearch/search.do?q=${encodeURIComponent(row.piid)}&s=FPDS&indexName=awardfull&templateName=1.5.3` : '';
                        const rowData = [
                            row.reference_piid || '',
                            row.piid || '',
                            row.dollars_obligated || '0',
                            fpdsUrl
                        ];
                        csv += rowData.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',') + '\n';
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const today = new Date().toLocaleDateString('en-US');
                    a.download = `${window.currentProcurementEntity.name.replace(/[^a-z0-9]/gi, '_')}_FAS_${today.replace(/\//g, '_')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                };
                
                const tableHtml = `
                    <div style="position: relative;">
                        <!-- Summary Statistics -->
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #e5e7eb;">
                            <h4 style="color: var(--dark-blue); margin-bottom: 12px; font-size: 1rem;"> FAS Table Summary</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; font-size: 0.9rem;">
                                <div style="text-align: center;">
                                    <div style="font-weight: 600; color: var(--orange); font-size: 1.1rem;">${data.length}</div>
                                    <div style="color: var(--blue);">Records Shown</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: 600; color: var(--orange); font-size: 1.1rem;">${formatCurrencyShort(totalObligations)}</div>
                                    <div style="color: var(--blue);">Total Obligations</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: 600; color: var(--blue); font-size: 0.85rem; word-wrap: break-word;">${dateRange}</div>
                                    <div style="color: var(--blue);">Date Range</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <button onclick="expandFasTable(event)" style="padding: 8px 16px; background: var(--blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                                 Expand & Edit Table
                            </button>
                            <button onclick="downloadFasCSV()" style="padding: 6px 12px; background: var(--green); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                 Download CSV
                            </button>
                        </div>
                        
                        <div style="overflow-x: auto; max-height: 400px; overflow-y: auto; width: 100%; border: 1px solid #e5e7eb; border-radius: 4px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; background: white;">
                                <thead style="background: #f8f9fa; position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--blue); font-weight: 600; white-space: nowrap; width: 25%;">Reference PIID</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--blue); font-weight: 600; white-space: nowrap; width: 25%;">PIID</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--blue); font-weight: 600; white-space: nowrap; width: 25%;">Obligations</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--blue); font-weight: 600; white-space: nowrap; width: 25%;">FPDS Link</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map((row, idx) => {
                                        const amount = parseFloat(row.dollars_obligated) || 0;
                                        const formattedAmount = amount === 0 ? '$0' : formatCurrencyShort(amount);
                                        
                                        // Create FPDS URL - use proper URL encoding for search
                                        const fpdsUrl = row.piid && row.reference_piid ? 
                                            `https://www.fpds.gov/ezsearch/search.do?indexName=awardfull&templateName=1.5.3&s=FPDS.GOV&q=PIID%3A%22${encodeURIComponent(row.piid)}%22%20%20REF_IDV_PIID%3A%22${encodeURIComponent(row.reference_piid)}%22` : 
                                            row.piid ? `https://www.fpds.gov/ezsearch/search.do?q=${encodeURIComponent(row.piid)}&s=FPDS&indexName=awardfull&templateName=1.5.3` : null;
                                        
                                        // Create clickable Reference PIID and PIID
                                        const refPiidDisplay = fpdsUrl ? 
                                            `<a href="${fpdsUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--blue); text-decoration: none; font-weight: 600;">${row.reference_piid}</a>` : 
                                            (row.reference_piid || '-');
                                        
                                        const piidDisplay = fpdsUrl ? 
                                            `<a href="${fpdsUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--blue); text-decoration: none; font-weight: 600;">${row.piid}</a>` : 
                                            (row.piid || '-');
                                        
                                        const fpdsLinkDisplay = fpdsUrl ? 
                                            `<a href="${fpdsUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--green); text-decoration: none; font-weight: 600;"> View</a>` : '-';
                                        
                                        return `
                                            <tr style="border-bottom: 1px solid #e5e7eb; ${idx % 2 === 0 ? 'background: #fafafa;' : 'background: white;'}">
                                                <td style="padding: 10px 12px; font-size: 0.85rem; vertical-align: middle;">${refPiidDisplay}</td>
                                                <td style="padding: 10px 12px; font-size: 0.85rem; vertical-align: middle;">${piidDisplay}</td>
                                                <td style="padding: 10px 12px; text-align: right; font-weight: 600; color: var(--orange); font-size: 0.85rem; vertical-align: middle;">
                                                    ${formattedAmount}
                                                </td>
                                                <td style="padding: 10px 12px; text-align: center; font-size: 0.85rem; vertical-align: middle;">
                                                    ${fpdsLinkDisplay}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ${pagination.totalPages > 1 ? `
                        <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                            <button onclick="loadFasPage(${pagination.currentPage - 1})" ${pagination.currentPage === 1 ? 'disabled' : ''} 
                                    style="padding: 8px 16px; background: ${pagination.currentPage === 1 ? '#e5e7eb' : 'var(--blue)'}; color: white; border: none; border-radius: 4px; cursor: ${pagination.currentPage === 1 ? 'default' : 'pointer'}; font-size: 0.9rem;">
                                 Previous
                            </button>
                            <span style="font-size: 0.9rem; color: var(--blue); font-weight: 600;">Page ${pagination.currentPage} of ${pagination.totalPages}</span>
                            <button onclick="loadFasPage(${pagination.currentPage + 1})" ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}
                                    style="padding: 8px 16px; background: ${pagination.currentPage === pagination.totalPages ? '#e5e7eb' : 'var(--blue)'}; color: white; border: none; border-radius: 4px; cursor: ${pagination.currentPage === pagination.totalPages ? 'default' : 'pointer'}; font-size: 0.9rem;">
                                Next 
                            </button>
                        </div>
                    ` : ''}
                `;
                
                return tableHtml;
            };
            
            // Function to render BIC table with data
            const renderBicTable = (tableData) => {
                const { data, pagination } = tableData;
                
                if (!data || data.length === 0) {
                    return '<div style="text-align: center; padding: 40px; color: #999;">No BIC data found</div>';
                }
                
                // Calculate summary statistics
                const validAmounts = data.filter(row => row.total_price && !isNaN(parseFloat(row.total_price)));
                const totalPrice = validAmounts.reduce((sum, row) => sum + parseFloat(row.total_price || 0), 0);
                const validDates = data.filter(row => {
                    if (!row.order_date || row.order_date === 'null' || row.order_date === '') return false;
                    const date = new Date(row.order_date);
                    return !isNaN(date.getTime()) && date.getFullYear() > 1900;
                }).map(row => new Date(row.order_date));
                
                const minDate = validDates.length > 0 ? new Date(Math.min(...validDates)) : null;
                const maxDate = validDates.length > 0 ? new Date(Math.max(...validDates)) : null;
                const dateRange = minDate && maxDate ? `${minDate.toLocaleDateString('en-US')} - ${maxDate.toLocaleDateString('en-US')}` : 'No valid dates';
                
                // CSV download function for BIC
                window.downloadBicCSV = () => {
                    const headers = ['Reference PIID', 'PIID', 'Total Price', 'FPDS Link'];
                    let csv = headers.join(',') + '\n';
                    
                    data.forEach(row => {
                        const fpdsUrl = row.piid && row.reference_piid ? 
                            `https://www.fpds.gov/ezsearch/search.do?indexName=awardfull&templateName=1.5.3&s=FPDS.GOV&q=PIID%3A%22${encodeURIComponent(row.piid)}%22%20%20REF_IDV_PIID%3A%22${encodeURIComponent(row.reference_piid)}%22` : 
                            row.piid ? `https://www.fpds.gov/ezsearch/search.do?q=${encodeURIComponent(row.piid)}&s=FPDS&indexName=awardfull&templateName=1.5.3` : '';
                        const rowData = [
                            row.reference_piid || '',
                            row.piid || '',
                            row.total_price || '0',
                            fpdsUrl
                        ];
                        csv += rowData.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',') + '\n';
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const today = new Date().toLocaleDateString('en-US');
                    a.download = `${window.currentProcurementEntity.name.replace(/[^a-z0-9]/gi, '_')}_BIC_${today.replace(/\//g, '_')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                };
                
                const tableHtml = `
                    <div style="position: relative;">
                        <!-- Summary Statistics -->
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #e5e7eb;">
                            <h4 style="color: var(--dark-blue); margin-bottom: 12px; font-size: 1rem;"> BIC Table Summary</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; font-size: 0.9rem;">
                                <div style="text-align: center;">
                                    <div style="font-weight: 600; color: var(--orange); font-size: 1.1rem;">${data.length}</div>
                                    <div style="color: var(--blue);">Records Shown</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: 600; color: var(--orange); font-size: 1.1rem;">${formatCurrencyShort(totalPrice)}</div>
                                    <div style="color: var(--blue);">Total Price</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: 600; color: var(--blue); font-size: 0.85rem; word-wrap: break-word;">${dateRange}</div>
                                    <div style="color: var(--blue);">Date Range</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <button onclick="expandBicTable(event)" style="padding: 8px 16px; background: var(--blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                                 Expand & Edit Table
                            </button>
                            <button onclick="downloadBicCSV()" style="padding: 6px 12px; background: var(--green); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                 Download CSV
                            </button>
                        </div>
                        
                        <div style="overflow-x: auto; max-height: 400px; overflow-y: auto; width: 100%; border: 1px solid #e5e7eb; border-radius: 4px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; background: white;">
                                <thead style="background: #f8f9fa; position: sticky; top: 0; z-index: 10;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--blue); font-weight: 600; white-space: nowrap; width: 25%;">Reference PIID</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--blue); font-weight: 600; white-space: nowrap; width: 25%;">PIID</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--blue); font-weight: 600; white-space: nowrap; width: 25%;">Total Price</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--blue); font-weight: 600; white-space: nowrap; width: 25%;">FPDS Link</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map((row, idx) => {
                                        const amount = parseFloat(row.total_price) || 0;
                                        const formattedAmount = amount === 0 ? '$0' : formatCurrencyShort(amount);
                                        
                                        // Create FPDS URL - use proper URL encoding for search
                                        const fpdsUrl = row.piid && row.reference_piid ? 
                                            `https://www.fpds.gov/ezsearch/search.do?indexName=awardfull&templateName=1.5.3&s=FPDS.GOV&q=PIID%3A%22${encodeURIComponent(row.piid)}%22%20%20REF_IDV_PIID%3A%22${encodeURIComponent(row.reference_piid)}%22` : 
                                            row.piid ? `https://www.fpds.gov/ezsearch/search.do?q=${encodeURIComponent(row.piid)}&s=FPDS&indexName=awardfull&templateName=1.5.3` : null;
                                        
                                        // Create clickable Reference PIID and PIID
                                        const refPiidDisplay = fpdsUrl ? 
                                            `<a href="${fpdsUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--blue); text-decoration: none; font-weight: 600;">${row.reference_piid}</a>` : 
                                            (row.reference_piid || '-');
                                        
                                        const piidDisplay = fpdsUrl ? 
                                            `<a href="${fpdsUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--blue); text-decoration: none; font-weight: 600;">${row.piid}</a>` : 
                                            (row.piid || '-');
                                        
                                        const fpdsLinkDisplay = fpdsUrl ? 
                                            `<a href="${fpdsUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--green); text-decoration: none; font-weight: 600;"> View</a>` : '-';
                                        
                                        return `
                                            <tr style="border-bottom: 1px solid #e5e7eb; ${idx % 2 === 0 ? 'background: #fafafa;' : 'background: white;'}">
                                                <td style="padding: 10px 12px; font-size: 0.85rem; vertical-align: middle;">${refPiidDisplay}</td>
                                                <td style="padding: 10px 12px; font-size: 0.85rem; vertical-align: middle;">${piidDisplay}</td>
                                                <td style="padding: 10px 12px; text-align: right; font-weight: 600; color: var(--orange); font-size: 0.85rem; vertical-align: middle;">
                                                    ${formattedAmount}
                                                </td>
                                                <td style="padding: 10px 12px; text-align: center; font-size: 0.85rem; vertical-align: middle;">
                                                    ${fpdsLinkDisplay}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ${pagination.totalPages > 1 ? `
                        <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                            <button onclick="loadBicPage(${pagination.currentPage - 1})" ${pagination.currentPage === 1 ? 'disabled' : ''}
                                    style="padding: 8px 16px; background: ${pagination.currentPage === 1 ? '#e5e7eb' : 'var(--blue)'}; color: white; border: none; border-radius: 4px; cursor: ${pagination.currentPage === 1 ? 'default' : 'pointer'}; font-size: 0.9rem;">
                                 Previous
                            </button>
                            <span style="font-size: 0.9rem; color: var(--blue); font-weight: 600;">Page ${pagination.currentPage} of ${pagination.totalPages}</span>
                            <button onclick="loadBicPage(${pagination.currentPage + 1})" ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}
                                    style="padding: 8px 16px; background: ${pagination.currentPage === pagination.totalPages ? '#e5e7eb' : 'var(--blue)'}; color: white; border: none; border-radius: 4px; cursor: ${pagination.currentPage === pagination.totalPages ? 'default' : 'pointer'}; font-size: 0.9rem;">
                                Next 
                            </button>
                        </div>
                    ` : ''}
                `;
                
                return tableHtml;
            };
            
            // Global functions for pagination
            window.loadFasPage = async (page) => {
                if (page < 1 || !window.currentProcurementEntity?.fasTableUrl) return;
                
                console.log(` Loading FAS page ${page} for ${window.currentProcurementEntity.name}`);
                document.getElementById('fas-table-content').innerHTML = ' Loading...';
                
                try {
                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .loadTableData(window.currentProcurementEntity.name, 'fas', window.currentProcurementEntity.fasTableUrl, page);
                    });
                    
                    if (result.success) {
                        // Transform flat to nested structure
                        window.fasTableData = {
                            data: result.data,
                            pagination: {
                                currentPage: result.currentPage,
                                totalPages: result.totalPages,
                                itemsPerPage: result.itemsPerPage
                            },
                            isLoading: false
                        };
                        console.log(' About to call renderFasTable()');
                        console.log(' window.fasTableData before call:', window.fasTableData);
                        console.log(' window.fasTableData.data exists:', !!window.fasTableData?.data);
                        document.getElementById('fas-table-status').innerHTML = `(${((page - 1) * result.itemsPerPage) + 1}-${Math.min(page * result.itemsPerPage, result.totalPages * result.itemsPerPage)} of ${result.totalPages * result.itemsPerPage} records)`;
                        document.getElementById('fas-table-content').innerHTML = renderFasTable();
                    } else {
                        document.getElementById('fas-table-content').innerHTML = `<div style="color: red; text-align: center; padding: 20px;">Error: ${result.error}</div>`;
                    }
                } catch (error) {
                    console.error('FAS loading error:', error);
                    document.getElementById('fas-table-content').innerHTML = `<div style="color: red; text-align: center; padding: 20px;">Failed to load FAS data: ${error}</div>`;
                }
            };
            
            window.loadBicPage = async (page) => {
                if (page < 1 || !window.currentProcurementEntity?.bicTableUrl) return;
                
                console.log(` Loading BIC page ${page} for ${window.currentProcurementEntity.name}`);
                document.getElementById('bic-table-content').innerHTML = ' Loading...';
                
                try {
                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .loadTableData(window.currentProcurementEntity.name, 'bic', window.currentProcurementEntity.bicTableUrl, page);
                    });
                    
                    if (result.success) {
                        // Transform flat to nested structure
                        window.bicTableData = {
                            data: result.data,
                            pagination: {
                                currentPage: result.currentPage,
                                totalPages: result.totalPages,
                                itemsPerPage: result.itemsPerPage
                            },
                            isLoading: false
                        };
                        console.log(' About to call renderBicTable()');
                        console.log(' window.bicTableData before call:', window.bicTableData);
                        console.log(' window.bicTableData.data exists:', !!window.bicTableData?.data);
                        document.getElementById('bic-table-status').innerHTML = `(${((page - 1) * result.itemsPerPage) + 1}-${Math.min(page * result.itemsPerPage, result.totalPages * result.itemsPerPage)} of ${result.totalPages * result.itemsPerPage} records)`;
                        document.getElementById('bic-table-content').innerHTML = renderBicTable();
                    } else {
                        document.getElementById('bic-table-content').innerHTML = `<div style="color: red; text-align: center; padding: 20px;">Error: ${result.error}</div>`;
                    }
                } catch (error) {
                    console.error('BIC loading error:', error);
                    document.getElementById('bic-table-content').innerHTML = `<div style="color: red; text-align: center; padding: 20px;">Failed to load BIC data: ${error}</div>`;
                }
            };
            
            // Auto-load first page of data after modal is rendered
            setTimeout(() => {
                if (entity.fasTableUrl) {
                    window.loadFasPage(1);
                }
                if (entity.bicTableUrl) {
                    window.loadBicPage(1);
                }
            }, 100);

            // Global functions for table expansion
            window.expandFasTable = (event) => {
                const btn = event ? event.target : document.querySelector('button[onclick="expandFasTable()"]');
                if (!btn) return;
                
                const originalText = btn.innerHTML;
                btn.innerHTML = ' Loading...';
                btn.disabled = true;
                btn.style.opacity = '0.6';
                
                // Add slight delay to ensure UI updates before heavy operation
                setTimeout(() => {
                    createExpandedTableModal('fas', 'FAS Procurement', window.fasTableData, window.currentProcurementEntity.fasTableUrl)
                        .catch(error => {
                            console.error('Failed to expand FAS table:', error);
                            // Remove any leftover loading overlays
                            const loadingOverlays = document.querySelectorAll('div[style*="z-index: 2000"]');
                            loadingOverlays.forEach(overlay => {
                                if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                            });
                        })
                        .finally(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                            btn.style.opacity = '1';
                        });
                }, 50);
            };

            window.expandBicTable = (event) => {
                const btn = event ? event.target : document.querySelector('button[onclick="expandBicTable()"]');
                if (!btn) return;
                
                const originalText = btn.innerHTML;
                btn.innerHTML = ' Loading...';
                btn.disabled = true;
                btn.style.opacity = '0.6';
                
                // Add slight delay to ensure UI updates before heavy operation
                setTimeout(() => {
                    createExpandedTableModal('bic', 'BIC Procurement', window.bicTableData, window.currentProcurementEntity.bicTableUrl)
                        .catch(error => {
                            console.error('Failed to expand BIC table:', error);
                            // Remove any leftover loading overlays
                            const loadingOverlays = document.querySelectorAll('div[style*="z-index: 2000"]');
                            loadingOverlays.forEach(overlay => {
                                if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                            });
                        })
                        .finally(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                            btn.style.opacity = '1';
                        });
                }, 50);
            };

            // Create expandable table modal with full editing, filtering, and CSV download capabilities
            const createExpandedTableModal = async (tableType, tableName, currentData, tableUrl) => {
                console.log(` EXPANDING ${tableType.toUpperCase()} TABLE:`, { tableName, currentData, tableUrl });
                
                // Create loading overlay immediately
                const loadingOverlay = document.createElement('div');
                loadingOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                loadingOverlay.innerHTML = `
                    <div style="background: white; padding: 30px 40px; border-radius: 12px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                        <div style="font-size: 2rem; margin-bottom: 15px;"></div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--dark-blue); margin-bottom: 8px;">Loading Full ${tableName}</div>
                        <div style="font-size: 0.9rem; color: var(--blue);">Fetching all data...</div>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);
                
                // Store current state for the expanded modal
                window.currentExpandedTable = {
                    type: tableType,
                    name: tableName,
                    originalData: [],
                    filteredData: [],
                    headers: [], // Store original CSV headers order
                    filters: { search: '', column: 'all', amount: '', date: '' },
                    editMode: false
                };

                // Load all data from the table (not paginated)
                try {
                    const allDataResult = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .loadAllTableData(window.currentProcurementEntity.name, tableType, tableUrl);
                    });

                    if (allDataResult.success) {
                        window.currentExpandedTable.originalData = allDataResult.data;
                        window.currentExpandedTable.filteredData = [...allDataResult.data];
                        window.currentExpandedTable.headers = allDataResult.headers || []; // Store original headers
                    } else {
                        console.error('Failed to load all table data:', allDataResult.error);
                        window.currentExpandedTable.originalData = currentData.data || [];
                        window.currentExpandedTable.filteredData = [...(currentData.data || [])];
                        window.currentExpandedTable.headers = currentData.headers || []; // Fallback headers
                    }
                } catch (error) {
                    console.error('Error loading all table data:', error);
                    window.currentExpandedTable.originalData = currentData.data || [];
                    window.currentExpandedTable.filteredData = [...(currentData.data || [])];
                    window.currentExpandedTable.headers = currentData.headers || []; // Fallback headers
                }

                // Create modal overlay
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'expanded-table-modal';
                modalOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.9);
                    z-index: 2000;
                    overflow-y: auto;
                    padding: 20px;
                `;

                // Generate expanded table modal HTML
                modalOverlay.innerHTML = generateExpandedTableHTML(tableType, tableName);

                // Add to page
                document.body.appendChild(modalOverlay);

                // Initialize expanded table
                refreshExpandedTable();

                // Remove loading overlay now that everything is ready
                if (loadingOverlay && loadingOverlay.parentNode) {
                    loadingOverlay.parentNode.removeChild(loadingOverlay);
                }

                // Add click outside to close
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        closeExpandedTable();
                    }
                });
            };

            // Generate expanded table modal HTML
            const generateExpandedTableHTML = (tableType, tableName) => {
                const tableIcon = tableType === 'fas' ? '' : '';
                const entityName = window.currentProcurementEntity.name;
                
                return `
                    <div style="max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); overflow: hidden;">
                        <!-- Modal Header -->
                        <div style="background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blue) 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="font-size: 1.5rem; margin-bottom: 5px;">${tableIcon} ${tableName} - Full View</h2>
                                <p style="opacity: 0.9; font-size: 0.9rem;">${entityName}</p>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <button onclick="toggleEditMode()" id="edit-toggle-btn" style="padding: 8px 16px; background: var(--orange); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                     Edit Mode
                                </button>
                                <button onclick="closeExpandedTable()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5rem;">
                                    
                                </button>
                            </div>
                        </div>

                        <!-- Filter Controls -->
                        <div style="background: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 16px; align-items: end;">
                                <div>
                                    <label style="display: block; font-weight: 600; color: var(--dark-blue); margin-bottom: 5px; font-size: 0.9rem;">Search All Columns</label>
                                    <input type="text" id="search-input" placeholder="Search..." onkeyup="applyFilters()" 
                                           style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: var(--dark-blue); margin-bottom: 5px; font-size: 0.9rem;">Filter by Column</label>
                                    <select id="column-filter" onchange="applyFilters()" 
                                            style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem;">
                                        <option value="all">All Columns</option>
                                        <option value="reference_piid">Reference PIID</option>
                                        <option value="piid">PIID</option>
                                        <option value="amount">Amount</option>
                                        <option value="date">Date</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: var(--dark-blue); margin-bottom: 5px; font-size: 0.9rem;">Min Amount ($)</label>
                                    <input type="number" id="amount-filter" placeholder="0" onkeyup="applyFilters()" 
                                           style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; color: var(--dark-blue); margin-bottom: 5px; font-size: 0.9rem;">Date Filter</label>
                                    <input type="date" id="date-filter" onchange="applyFilters()" 
                                           style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem;">
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="clearFilters()" style="padding: 10px 16px; background: var(--red); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                         Clear
                                    </button>
                                    <button onclick="downloadFilteredCSV()" style="padding: 10px 16px; background: var(--green); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                         Export
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Table Container -->
                        <div style="padding: 30px; max-height: 70vh; overflow: auto;">
                            <div id="expanded-table-stats" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                <!-- Stats will be populated here -->
                            </div>
                            <div id="expanded-table-content" style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                                <!-- Table will be populated here -->
                            </div>
                        </div>
                    </div>
                `;
            };

            // Functions for expanded table functionality
            window.refreshExpandedTable = () => {
                if (!window.currentExpandedTable) return;

                const { filteredData, type } = window.currentExpandedTable;
                
                // Update statistics
                const statsHtml = generateExpandedTableStats(filteredData, type);
                document.getElementById('expanded-table-stats').innerHTML = statsHtml;
                
                // Update table content with all columns
                const tableHtml = generateExpandedTableContent(filteredData, type);
                document.getElementById('expanded-table-content').innerHTML = tableHtml;
            };

            window.applyFilters = () => {
                if (!window.currentExpandedTable) return;

                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const columnFilter = document.getElementById('column-filter').value;
                const amountFilter = parseFloat(document.getElementById('amount-filter').value) || 0;
                const dateFilter = document.getElementById('date-filter').value;

                let filtered = [...window.currentExpandedTable.originalData];

                // Apply search filter
                if (searchTerm) {
                    filtered = filtered.filter(row => {
                        if (columnFilter === 'all') {
                            return Object.values(row).some(value => 
                                String(value || '').toLowerCase().includes(searchTerm)
                            );
                        } else if (columnFilter === 'reference_piid') {
                            return String(row.reference_piid || '').toLowerCase().includes(searchTerm);
                        } else if (columnFilter === 'piid') {
                            return String(row.piid || '').toLowerCase().includes(searchTerm);
                        } else if (columnFilter === 'amount') {
                            const amount = window.currentExpandedTable.type === 'fas' ? row.dollars_obligated : row.total_price;
                            return String(amount || '').toLowerCase().includes(searchTerm);
                        } else if (columnFilter === 'date') {
                            const date = window.currentExpandedTable.type === 'fas' ? row.date_signed : row.order_date;
                            return String(date || '').toLowerCase().includes(searchTerm);
                        }
                        return true;
                    });
                }

                // Apply amount filter
                if (amountFilter > 0) {
                    filtered = filtered.filter(row => {
                        const amount = window.currentExpandedTable.type === 'fas' ? 
                            parseFloat(row.dollars_obligated || 0) : parseFloat(row.total_price || 0);
                        return amount >= amountFilter;
                    });
                }

                // Apply date filter
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    filtered = filtered.filter(row => {
                        const dateField = window.currentExpandedTable.type === 'fas' ? row.date_signed : row.order_date;
                        if (!dateField) return false;
                        const rowDate = new Date(dateField);
                        return !isNaN(rowDate.getTime()) && rowDate >= filterDate;
                    });
                }

                window.currentExpandedTable.filteredData = filtered;
                refreshExpandedTable();
            };

            window.clearFilters = () => {
                document.getElementById('search-input').value = '';
                document.getElementById('column-filter').value = 'all';
                document.getElementById('amount-filter').value = '';
                document.getElementById('date-filter').value = '';
                
                window.currentExpandedTable.filteredData = [...window.currentExpandedTable.originalData];
                refreshExpandedTable();
            };

            window.toggleEditMode = () => {
                if (!window.currentExpandedTable) return;
                
                window.currentExpandedTable.editMode = !window.currentExpandedTable.editMode;
                const btn = document.getElementById('edit-toggle-btn');
                
                if (window.currentExpandedTable.editMode) {
                    btn.innerHTML = ' Save Changes';
                    btn.style.background = 'var(--green)';
                } else {
                    btn.innerHTML = ' Edit Mode';
                    btn.style.background = 'var(--orange)';
                }
                
                refreshExpandedTable();
            };

            window.closeExpandedTable = () => {
                const modal = document.querySelector('.expanded-table-modal');
                if (modal) {
                    modal.remove();
                }
                window.currentExpandedTable = null;
            };

            window.downloadFilteredCSV = () => {
                if (!window.currentExpandedTable) return;

                const { filteredData, type, name } = window.currentExpandedTable;
                
                // Generate CSV with ALL columns plus FPDS Link using original CSV header order
                const storedHeaders = window.currentExpandedTable?.headers || [];
                const allColumns = storedHeaders.length > 0 ? storedHeaders : (filteredData.length > 0 ? Object.keys(filteredData[0]) : []);
                const headers = [...allColumns.map(col => col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())), 'FPDS Link'];
                
                const csvData = filteredData.map(row => {
                    const fpdsUrl = row.piid && row.reference_piid ? 
                        `https://www.fpds.gov/ezsearch/search.do?indexName=awardfull&templateName=1.5.3&s=FPDS.GOV&q=PIID%3A%22${encodeURIComponent(row.piid)}%22%20%20REF_IDV_PIID%3A%22${encodeURIComponent(row.reference_piid)}%22` : 
                        row.piid ? `https://www.fpds.gov/ezsearch/search.do?q=${encodeURIComponent(row.piid)}&s=FPDS&indexName=awardfull&templateName=1.5.3` : '';
                    
                    // Include all columns plus FPDS URL
                    return [...allColumns.map(col => row[col] || ''), fpdsUrl];
                });

                let csv = headers.join(',') + '\n';
                csvData.forEach(rowData => {
                    csv += rowData.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',') + '\n';
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const today = new Date().toLocaleDateString('en-US');
                a.download = `${window.currentProcurementEntity.name.replace(/[^a-z0-9]/gi, '_')}_${name.replace(/\s+/g, '_')}_Filtered_${today.replace(/\//g, '_')}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };

            // Generate statistics for expanded table
            const generateExpandedTableStats = (data, type) => {
                const validAmounts = data.filter(row => {
                    const amount = type === 'fas' ? row.dollars_obligated : row.total_price;
                    return amount && !isNaN(parseFloat(amount));
                });
                
                const totalAmount = validAmounts.reduce((sum, row) => {
                    const amount = type === 'fas' ? parseFloat(row.dollars_obligated || 0) : parseFloat(row.total_price || 0);
                    return sum + amount;
                }, 0);
                
                const validDates = data.filter(row => {
                    const dateField = type === 'fas' ? row.date_signed : row.order_date;
                    if (!dateField || dateField === 'null' || dateField === '') return false;
                    const date = new Date(dateField);
                    return !isNaN(date.getTime()) && date.getFullYear() > 1900;
                }).map(row => {
                    const dateField = type === 'fas' ? row.date_signed : row.order_date;
                    return new Date(dateField);
                });

                const minDate = validDates.length > 0 ? new Date(Math.min(...validDates)) : null;
                const maxDate = validDates.length > 0 ? new Date(Math.max(...validDates)) : null;
                const dateRange = minDate && maxDate ? `${minDate.toLocaleDateString('en-US')} - ${maxDate.toLocaleDateString('en-US')}` : 'No valid dates';

                return `
                    <h4 style="color: var(--dark-blue); margin-bottom: 12px; font-size: 1rem;"> ${type.toUpperCase()} Table Statistics (Filtered)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; font-size: 0.9rem;">
                        <div style="text-align: center;">
                            <div style="font-weight: 600; color: var(--orange); font-size: 1.2rem;">${data.length}</div>
                            <div style="color: var(--blue);">Filtered Records</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: 600; color: var(--orange); font-size: 1.2rem;">${window.currentExpandedTable.originalData.length}</div>
                            <div style="color: var(--blue);">Total Records</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: 600; color: var(--orange); font-size: 1.2rem;">${formatCurrencyShort(totalAmount)}</div>
                            <div style="color: var(--blue);">Filtered Total</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: 600; color: var(--blue); font-size: 0.85rem; word-wrap: break-word;">${dateRange}</div>
                            <div style="color: var(--blue);">Date Range</div>
                        </div>
                    </div>
                `;
            };

            // Generate expanded table content with ALL columns
            const generateExpandedTableContent = (data, type) => {
                if (!data || data.length === 0) {
                    return '<div style="text-align: center; padding: 40px; color: #999;">No data matches your filters</div>';
                }

                const editMode = window.currentExpandedTable?.editMode || false;
                
                // Use original CSV header order if available, otherwise fall back to Object.keys
                const storedHeaders = window.currentExpandedTable?.headers || [];
                const allColumns = storedHeaders.length > 0 ? storedHeaders : (data.length > 0 ? Object.keys(data[0]) : []);
                
                console.log(' COLUMN ORDER: Using headers:', storedHeaders.length > 0 ? 'stored CSV headers' : 'Object.keys fallback');
                console.log(' HEADERS:', allColumns.slice(0, 10));
                
                // Create headers array with ALL columns plus FPDS Link at the end
                const headers = [...allColumns.map(col => {
                    // Format column names for display
                    return col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }), 'FPDS Link'];
                
                // Generate dynamic rows for ALL columns
                const rows = data.map((row, idx) => {
                    // Generate FPDS URL once per row
                    const fpdsUrl = row.piid && row.reference_piid ? 
                        `https://www.fpds.gov/ezsearch/search.do?indexName=awardfull&templateName=1.5.3&s=FPDS.GOV&q=PIID%3A%22${encodeURIComponent(row.piid)}%22%20%20REF_IDV_PIID%3A%22${encodeURIComponent(row.reference_piid)}%22` : 
                        row.piid ? `https://www.fpds.gov/ezsearch/search.do?q=${encodeURIComponent(row.piid)}&s=FPDS&indexName=awardfull&templateName=1.5.3` : null;

                    // Generate cells for all data columns
                    const dataCells = allColumns.map(colName => {
                        const value = row[colName];
                        let displayValue = value || '-';
                        let inputType = 'text';
                        let cellStyle = 'padding: 12px; font-size: 0.9rem; vertical-align: middle; min-width: 120px; max-width: 200px; word-wrap: break-word;';

                        // Special formatting for specific column types
                        if (colName === 'dollars_obligated' || colName === 'total_price' || colName.includes('price') || colName.includes('amount')) {
                            const amount = parseFloat(value) || 0;
                            displayValue = amount === 0 ? '$0' : formatCurrencyShort(amount);
                            cellStyle = 'padding: 12px; text-align: right; font-weight: 600; color: var(--orange); font-size: 0.9rem; vertical-align: middle; min-width: 120px;';
                            inputType = 'number';
                        } else if (colName.includes('date') && value && value !== 'null' && value !== '') {
                            const date = new Date(value);
                            displayValue = !isNaN(date.getTime()) ? date.toLocaleDateString('en-US') : value;
                            inputType = 'date';
                        } else if (colName === 'reference_piid' || colName === 'piid') {
                            // Make PIIDs clickable if FPDS URL exists
                            if (fpdsUrl) {
                                displayValue = `<a href="${fpdsUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--blue); text-decoration: none; font-weight: 600;">${value}</a>`;
                            }
                        } else if (colName === 'AI_Product' && editMode) {
                            inputType = 'select';
                        }

                        // Generate cell content
                        let cellContent;
                        if (editMode) {
                            if (inputType === 'select' && colName === 'AI_Product') {
                                cellContent = `<select style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                                    <option ${value === 'applicable' ? 'selected' : ''}>applicable</option>
                                    <option ${value === 'not applicable' ? 'selected' : ''}>not applicable</option>
                                </select>`;
                            } else if (colName.includes('description')) {
                                cellContent = `<textarea style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; min-height: 40px;">${value || ''}</textarea>`;
                            } else {
                                cellContent = `<input type="${inputType}" value="${value || ''}" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; ${inputType === 'number' ? 'text-align: right;' : ''}">`;
                            }
                        } else {
                            cellContent = displayValue;
                        }

                        return `<td style="${cellStyle}">${cellContent}</td>`;
                    });

                    // Add FPDS link column at the end
                    const fpdsLinkDisplay = fpdsUrl ? 
                        `<a href="${fpdsUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--green); text-decoration: none; font-weight: 600;"> View FPDS</a>` : '-';
                    const fpdsCell = editMode ? 
                        `<td style="padding: 12px; text-align: center; font-size: 0.9rem; vertical-align: middle; min-width: 120px;"><input type="url" value="${fpdsUrl || ''}" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;"></td>` :
                        `<td style="padding: 12px; text-align: center; font-size: 0.9rem; vertical-align: middle; min-width: 120px;">${fpdsLinkDisplay}</td>`;

                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb; ${idx % 2 === 0 ? 'background: #fafafa;' : 'background: white;'}">
                            ${dataCells.join('')}
                            ${fpdsCell}
                        </tr>
                    `;
                });

                return `
                    <div style="overflow: auto; max-height: 500px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; background: white;">
                            <thead style="background: #f8f9fa; position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    ${headers.map(header => `<th style="padding: 16px 12px; text-align: left; border-bottom: 2px solid var(--blue); font-weight: 600; white-space: nowrap; font-size: 0.9rem;">${header}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${rows.join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };
            
            return `
                <div style="margin-top: 32px; margin-bottom: 32px;">
                    <h2 style="font-size: 1.4rem; font-weight: 700; color: var(--dark-blue); padding-bottom: 8px; border-bottom: 3px solid var(--orange); margin-bottom: 24px;">
                         Procurement Details
                    </h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; max-width: 100%; overflow: hidden;">
                        ${generateFasTablePlaceholder()}
                        ${generateBicTablePlaceholder()}
                    </div>
                </div>
            `;
        };
        
        // Generate comprehensive carousel slides for all available entity JSON data
        const generateDetailSlides = (entity, entityData) => {
            
            const slides = [];
            
            // Helper function to dynamically detect available fiscal years from any JSON structure
            const detectFiscalYears = (jsonData) => {
                const years = new Set();
                
                // Check top-level fiscal year fields
                const fiscalData = jsonData?.fiscal_year_obligations || jsonData?.fiscal_years || 
                                  jsonData?.yearly_totals || jsonData?.fiscal_year_summaries;
                
                if (fiscalData && typeof fiscalData === 'object') {
                    Object.keys(fiscalData).forEach(year => {
                        if (/^\d{4}$/.test(year)) { // Check if it's a 4-digit year
                            years.add(year);
                        }
                    });
                }
                
                // Check nested structures like summaries
                if (jsonData) {
                    Object.values(jsonData).forEach(value => {
                        if (typeof value === 'object' && value?.fiscal_years) {
                            Object.keys(value.fiscal_years).forEach(year => {
                                if (/^\d{4}$/.test(year)) {
                                    years.add(year);
                                }
                            });
                        }
                    });
                }
                
                // Return sorted array of years, fallback to default if none found
                return years.size > 0 ? Array.from(years).sort() : ['2022', '2023', '2024', '2025'];
            };
            
            // Helper function to extract fiscal year data from various JSON structures
            const extractFiscalYearData = (jsonData) => {
                if (!jsonData) return null;
                if (jsonData.fiscal_year_obligations) return jsonData.fiscal_year_obligations;
                if (jsonData.fiscal_years) return jsonData.fiscal_years;
                if (jsonData.yearly_totals) return jsonData.yearly_totals;
                
                // Look in nested objects
                for (const key in jsonData) {
                    if (typeof jsonData[key] === 'object' && jsonData[key]?.fiscal_years) {
                        return jsonData[key].fiscal_years;
                    }
                }
                return null;
            };

            // Simple, clean bar chart generators
            const generateSimpleBarChart = (fiscalData, title, color = 'var(--orange)') => {
                if (!fiscalData || Object.keys(fiscalData).length === 0) return '';
                
                const fyKeys = Object.keys(fiscalData).sort();
                const fyValues = fyKeys.map(key => fiscalData[key] || 0);
                const maxValue = Math.max(...fyValues);
                const totalValue = fyValues.reduce((sum, val) => sum + val, 0);
                
                return `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--orange); margin-bottom: 8px;">
                            ${formatCurrencyShort(totalValue)}
                        </div>
                    </div>
                    <div style="height: 200px; display: flex; align-items: flex-end; gap: 8px; padding: 0 10px;">
                        ${fyKeys.map((year, index) => {
                            const height = maxValue > 0 ? (fyValues[index] / maxValue * 160) : 5; // Use fixed pixel height
                            return `
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                    <!-- Value label above bar -->
                                    <div style="height: 30px; display: flex; align-items: flex-end; margin-bottom: 5px;">
                                        <span style="font-size: 0.8rem; font-weight: 600; color: var(--dark-blue); white-space: nowrap;">
                                            ${formatCurrencyShort(fyValues[index])}
                                        </span>
                                    </div>
                                    <!-- Bar -->
                                    <div style="width: 100%; max-width: 60px; background: linear-gradient(to top, #f47920, #ff8c42); border-radius: 4px 4px 0 0; height: ${height}px; margin-bottom: 10px;"></div>
                                    <!-- Year label -->
                                    <span style="font-size: 0.9rem; color: var(--blue); font-weight: 600;">${year}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            };

            // Generate funnel chart for top items (upside down triangle) with integrated table
            const generateFunnelChart = (data, title, isArray = false, withIntegratedTable = false, showFiscalYears = false) => {
                
                if (!data) {
                    return '';
                }
                
                let items = [];
                let totalValue = 0;
                
                if (isArray) {
                    // For arrays like top_10_piids, top_25_products, top_15_manufacturers
                    items = data.map(item => ({
                        name: item.piid || item.reference_piid || item.name || item.product_name || item.manufacturer_name || 'Unknown',
                        value: item.dollars_obligated || item.value || item.total || item.obligations || item.total_price || item.total_sales || 0
                    }));
                } else {
                    // For objects like top_contract_summaries
                    items = Object.entries(data).map(([name, data]) => ({
                        name: name,
                        value: data.total || data.value || data || 0
                    }));
                }
                
                // Sort by value and take top 8 for funnel
                items = items.filter(item => item.value > 0)
                           .sort((a, b) => b.value - a.value)
                           .slice(0, 8);
                
                
                if (items.length === 0) {
                    return '';
                }
                
                totalValue = items.reduce((sum, item) => sum + item.value, 0);
                const maxValue = items[0].value;
                
                const colors = ['#f47920', '#1e40af', '#dc2626', '#059669', '#7c3aed', '#ea580c', '#0891b2', '#be185d'];
                
                if (withIntegratedTable) {
                    // Full width layout with chart on left and table on right (like PIIDs)
                    return `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px; height: 100%;">
                            <div style="display: flex; flex-direction: column;">
                                <div style="text-align: center; margin-bottom: 8px;">
                                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--orange);">
                                        ${formatCurrencyShort(totalValue)}
                                    </div>
                                </div>
                                
                                <!-- Funnel Chart aligned with table -->
                                <div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-start; margin-top: 40px;">
                                    ${items.map((item, idx) => {
                                        const percentage = ((item.value / totalValue) * 100).toFixed(1);
                                        const widthPercent = Math.max(15, (item.value / maxValue) * 85); // Min 15% width
                                        const segmentHeight = 32; // Fixed height to match table rows
                                        const color = colors[idx % colors.length];
                                        
                                        return `
                                            <div style="
                                                width: ${widthPercent}%; 
                                                height: ${segmentHeight}px; 
                                                background: linear-gradient(135deg, ${color}, ${color}cc);
                                                margin: 1px 0;
                                                display: flex; 
                                                align-items: center; 
                                                justify-content: center;
                                                color: white;
                                                font-weight: 600;
                                                font-size: 0.8rem;
                                                text-shadow: 0 1px 2px rgba(0,0,0,0.7);
                                                border-radius: 4px;
                                                align-self: center;
                                            " title="${item.name}: ${formatCurrencyShort(item.value)} (${percentage}%)">
                                                ${percentage}%
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color: var(--blue); margin-bottom: 20px;"> ${title} Details</h3>
                                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                                    <table style="min-width: 800px; width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f8f9fa;">
                                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;"></th>
                                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Name</th>
                                                ${showFiscalYears ? (() => {
                                                    // Dynamically detect fiscal years from the data
                                                    const fiscalYears = detectFiscalYears(data);
                                                    return fiscalYears.map(year => `
                                                        <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">${year}</th>
                                                    `).join('');
                                                })() : ''}
                                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${items.map((item, idx) => {
                                                // Get the original data for this item to extract fiscal years
                                                let originalData = null;
                                                if (isArray) {
                                                    originalData = data.find(d => 
                                                        (d.piid || d.reference_piid || d.name || d.product_name || d.manufacturer_name || d.category) === item.name ||
                                                        (d.piid || d.reference_piid || d.name || d.product_name || d.manufacturer_name || d.category)?.includes(item.name.substring(0, 20))
                                                    );
                                                } else {
                                                    originalData = data[item.name];
                                                }
                                                
                                                return `
                                                    <tr style="border-bottom: 1px solid #e5e7eb; height: 34px;">
                                                        <td style="padding: 8px; text-align: center;">
                                                            <div style="width: 12px; height: 12px; background: ${colors[idx % colors.length]}; border-radius: 3px; margin: auto;"></div>
                                                        </td>
                                                        <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 200px;">${item.name}</td>
                                                        ${showFiscalYears ? (() => {
                                                            const fiscalYears = detectFiscalYears(data);
                                                            return fiscalYears.map(year => `
                                                                <td style="padding: 6px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(
                                                                    originalData?.fiscal_years?.[year] || 
                                                                    originalData?.fiscal_year_breakdown?.[year]?.total_sales || 
                                                                    originalData?.fiscal_year_breakdown?.[year]?.total_price || 
                                                                    originalData?.fiscal_year_breakdown?.[year]?.obligations || 
                                                                    0
                                                                )}</td>
                                                            `).join('');
                                                        })() : ''}
                                                        <td style="padding: 8px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(item.value)}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                            ${showFiscalYears ? (() => {
                                                // Calculate totals for each fiscal year and grand total
                                                const fiscalYears = detectFiscalYears(data);
                                                let yearTotals = {};
                                                let grandTotal = 0;
                                                
                                                items.forEach((item) => {
                                                    let originalData = null;
                                                    if (isArray) {
                                                        originalData = data.find(d => 
                                                            (d.piid || d.reference_piid || d.name || d.product_name || d.manufacturer_name || d.category) === item.name ||
                                                            (d.piid || d.reference_piid || d.name || d.product_name || d.manufacturer_name || d.category)?.includes(item.name.substring(0, 20))
                                                        );
                                                    } else {
                                                        originalData = data[item.name];
                                                    }
                                                    
                                                    fiscalYears.forEach(year => {
                                                        const yearValue = originalData?.fiscal_years?.[year] || 
                                                                         originalData?.fiscal_year_breakdown?.[year]?.total_sales || 
                                                                         originalData?.fiscal_year_breakdown?.[year]?.total_price || 
                                                                         originalData?.fiscal_year_breakdown?.[year]?.obligations || 0;
                                                        yearTotals[year] = (yearTotals[year] || 0) + yearValue;
                                                    });
                                                    grandTotal += item.value;
                                                });
                                                
                                                return `
                                                    <tr style="border-top: 2px solid #144673; background: #f8f9fa; font-weight: bold;">
                                                        <td style="padding: 8px; text-align: center;"></td>
                                                        <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem;">TOTALS</td>
                                                        ${fiscalYears.map(year => `
                                                            <td style="padding: 6px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(yearTotals[year] || 0)}</td>
                                                        `).join('')}
                                                        <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(grandTotal)}</td>
                                                    </tr>
                                                `;
                                            })() : ''}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Standard single-column funnel chart
                    return `
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--orange);">
                                ${formatCurrencyShort(totalValue)}
                            </div>
                        </div>
                        
                        <!-- Funnel Chart -->
                        <div style="height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                            ${items.map((item, idx) => {
                                const percentage = ((item.value / totalValue) * 100).toFixed(1);
                                const widthPercent = Math.max(15, (item.value / maxValue) * 85); // Min 15% width
                                const segmentHeight = Math.max(25, 300 / items.length - 5);
                                const color = colors[idx % colors.length];
                                
                                return `
                                    <div style="
                                        width: ${widthPercent}%; 
                                        height: ${segmentHeight}px; 
                                        background: linear-gradient(135deg, ${color}, ${color}cc);
                                        margin: 2px 0;
                                        display: flex; 
                                        align-items: center; 
                                        justify-content: center;
                                        color: white;
                                        font-weight: 600;
                                        font-size: 0.8rem;
                                        text-shadow: 0 1px 2px rgba(0,0,0,0.7);
                                        border-radius: 4px;
                                        position: relative;
                                    " title="${item.name}: ${formatCurrencyShort(item.value)} (${percentage}%)">
                                        ${percentage}%
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            };

            // Generate PIID-specific line chart showing all PIIDs with fiscal year breakdown
            const generatePiidChart = (piidData, title) => {
                if (!piidData || !Array.isArray(piidData.top_10_piids || piidData.top_10_reference_piids)) return '';
                
                const piids = piidData.top_10_piids || piidData.top_10_reference_piids || [];
                
                if (piids.length === 0) return '';
                
                // Get all fiscal years across all PIIDs
                const allFYs = new Set();
                piids.forEach(piid => {
                    if (piid.fiscal_year_breakdown) {
                        Object.keys(piid.fiscal_year_breakdown).forEach(year => allFYs.add(year));
                    }
                });
                const fyKeys = Array.from(allFYs).sort();
                
                if (fyKeys.length === 0) return '';
                
                // Calculate max value for scaling with 20% padding
                let maxValue = 0;
                piids.forEach(piid => {
                    fyKeys.forEach(year => {
                        const value = piid.fiscal_year_breakdown?.[year]?.obligations || 0;
                        maxValue = Math.max(maxValue, value);
                    });
                });
                maxValue = maxValue * 1.2; // Add 20% padding to prevent clipping
                
                // High-contrast colors with varied stroke patterns
                const lineStyles = [
                    { color: '#f47920', pattern: 'none', width: '3' },      // Orange - solid
                    { color: '#1e40af', pattern: '5,5', width: '3' },       // Blue - dashed
                    { color: '#dc2626', pattern: 'none', width: '3' },      // Red - solid
                    { color: '#059669', pattern: '3,3', width: '3' },       // Green - dotted
                    { color: '#7c3aed', pattern: 'none', width: '3' },      // Purple - solid
                    { color: '#ea580c', pattern: '8,4', width: '3' },       // Dark orange - long dash
                    { color: '#0891b2', pattern: '2,2', width: '3' },       // Cyan - fine dotted
                    { color: '#be185d', pattern: 'none', width: '3' },      // Pink - solid
                    { color: '#365314', pattern: '6,2,2,2', width: '3' },   // Dark green - dash-dot
                    { color: '#451a03', pattern: '4,4', width: '3' }        // Brown - dashed
                ];
                const totalValue = piids.reduce((sum, piid) => sum + (piid.dollars_obligated || 0), 0);
                
                return `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--orange); margin-bottom: 8px;">
                            ${formatCurrencyShort(totalValue)}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--blue);">
                            ${title} Total (${fyKeys[0]}-${fyKeys[fyKeys.length - 1]})
                        </div>
                    </div>
                    
                    <!-- Line chart -->
                    <div style="position: relative; height: 280px; padding: 20px 20px 30px 50px;">
                        <!-- Y-axis labels -->
                        <div style="position: absolute; left: 0; top: 0; height: 100%; display: flex; flex-direction: column; justify-content: space-between; width: 35px;">
                            ${[100, 75, 50, 25, 0].map(pct => `
                                <div style="font-size: 0.65rem; color: #666; text-align: right;">
                                    ${formatCurrencyShort(maxValue * pct / 100)}
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Grid and lines -->
                        <div style="position: relative; height: 100%; margin-left: 40px;">
                            <!-- Horizontal grid lines -->
                            ${[0, 25, 50, 75, 100].map(pct => `
                                <div style="position: absolute; bottom: ${pct}%; left: 0; right: 0; height: 1px; background: ${pct === 0 ? '#333' : '#e5e7eb'};"></div>
                            `).join('')}
                            
                            <!-- Lines for each PIID with improved visibility -->
                            <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" viewBox="0 0 100 100" preserveAspectRatio="none">
                                ${piids.map((piid, idx) => {
                                    const piidName = piid.piid || piid.reference_piid || '';
                                    const lineStyle = lineStyles[idx % lineStyles.length];
                                    const points = fyKeys.map((year, yearIdx) => {
                                        const value = piid.fiscal_year_breakdown?.[year]?.obligations || 0;
                                        const x = Math.max(8, Math.min(92, (yearIdx / (fyKeys.length - 1)) * 84 + 8)); // Keep within 8-92% range
                                        const y = Math.max(8, Math.min(92, 100 - (maxValue > 0 ? (value / maxValue * 84) + 8 : 8))); // Keep within 8-92% range
                                        return `${x},${y}`;
                                    }).join(' ');
                                    
                                    return `
                                        <g>
                                            <polyline 
                                                points="${points}" 
                                                stroke="${lineStyle.color}" 
                                                stroke-width="${lineStyle.width}" 
                                                stroke-dasharray="${lineStyle.pattern}" 
                                                fill="none"
                                                opacity="0.9"
                                            />
                                            ${fyKeys.map((year, yearIdx) => {
                                                const value = piid.fiscal_year_breakdown?.[year]?.obligations || 0;
                                                if (value === 0) return '';
                                                const x = Math.max(8, Math.min(92, (yearIdx / (fyKeys.length - 1)) * 84 + 8));
                                                const y = Math.max(8, Math.min(92, 100 - (maxValue > 0 ? (value / maxValue * 84) + 8 : 8)));
                                                return `
                                                    <circle 
                                                        cx="${x}" 
                                                        cy="${y}" 
                                                        r="5" 
                                                        fill="${lineStyle.color}"
                                                        stroke="white"
                                                        stroke-width="2"
                                                        opacity="1"
                                                    >
                                                        <title>${piidName}: ${formatCurrencyShort(value)} (${year})</title>
                                                    </circle>
                                                `;
                                            }).join('')}
                                        </g>
                                    `;
                                }).join('')}
                            </svg>
                            
                            <!-- X-axis labels -->
                            <div style="position: absolute; bottom: -25px; left: 0; right: 0; display: flex; justify-content: space-between;">
                                ${fyKeys.map(year => `
                                    <span style="font-size: 0.8rem; font-weight: 600; color: var(--blue);">${year}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced instructions and legend -->
                    <div style="text-align: center; margin-top: 15px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                        <div style="font-size: 0.75rem; color: var(--blue); font-weight: 600;"> Hover over data points for PIID details</div>
                        <div style="font-size: 0.7rem; color: #666; margin-top: 2px;">${piids.length} contracts  Lines use different colors and patterns for clarity</div>
                        <div style="font-size: 0.65rem; color: #888; margin-top: 2px;">Solid lines, dashed lines, and dotted lines distinguish similar colors</div>
                    </div>
                `;
            };

            const generateGroupedBarChart = (seriesData, title, colors = ['var(--orange)', 'var(--blue)', 'var(--light-blue)', 'var(--dark-blue)', 'var(--green)', '#22c55e'], hideLegend = false) => {
                if (!seriesData || Object.keys(seriesData).length === 0) return '';
                
                // Get all fiscal years
                const allFYKeys = new Set();
                Object.values(seriesData).forEach(series => {
                    if (series.fiscal_years) {
                        Object.keys(series.fiscal_years).forEach(year => allFYKeys.add(year));
                    }
                });
                
                const fyKeys = Array.from(allFYKeys).sort();
                // Sort series by total value (highest to lowest) to match table order
                const sortedSeries = Object.entries(seriesData)
                    .sort((a, b) => (b[1].total || 0) - (a[1].total || 0))
                    .slice(0, 4); // Top 4 series
                const seriesNames = sortedSeries.map(([name]) => name);
                
                if (fyKeys.length === 0 || seriesNames.length === 0) return '';
                
                // Calculate max value and total value
                let maxValue = 0;
                let totalValue = 0;
                seriesNames.forEach(name => {
                    const series = seriesData[name];
                    if (series.fiscal_years) {
                        Object.values(series.fiscal_years).forEach(val => {
                            maxValue = Math.max(maxValue, val || 0);
                            totalValue += val || 0;
                        });
                    } else {
                        // Fallback to total field if no fiscal_years
                        totalValue += series.total || 0;
                    }
                });
                
                return `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--orange); margin-bottom: 8px;">
                            ${formatCurrencyShort(totalValue)}
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    ${!hideLegend ? `
                    <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        ${seriesNames.map((name, idx) => `
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 12px; height: 12px; background: ${colors[idx % colors.length]}; border-radius: 2px;"></div>
                                <span style="font-size: 0.75rem; font-weight: 600; color: var(--dark-blue);">${name.length > 15 ? name.substring(0, 15) + '...' : name}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <!-- Grouped bar chart -->
                    <div style="height: 180px; display: flex; align-items: flex-end; gap: 15px; padding: 0 10px;">
                        ${fyKeys.map(year => `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                <!-- Group of bars for this year -->
                                <div style="display: flex; align-items: flex-end; gap: 3px; height: 140px; margin-bottom: 10px; width: 100%; justify-content: center;">
                                    ${(() => {
                                        // Find the highest value for this year to only show one label
                                        const yearValues = seriesNames.map(name => seriesData[name]?.fiscal_years?.[year] || 0);
                                        const maxValueThisYear = Math.max(...yearValues);
                                        
                                        return seriesNames.map((name, idx) => {
                                            const value = seriesData[name]?.fiscal_years?.[year] || 0;
                                            const height = maxValue > 0 ? (value / maxValue * 100) : 0;
                                            const barWidth = Math.floor(80 / seriesNames.length);
                                            const isHighest = value === maxValueThisYear && value > 0;
                                            
                                            return `
                                                <div style="position: relative; width: ${barWidth}%; height: 100%; display: flex; align-items: flex-end;">
                                                    <div style="width: 100%; background: ${colors[idx % colors.length]}; height: ${Math.max(height, 3)}%; border-radius: 2px 2px 0 0; position: relative;">
                                                        ${isHighest ? `
                                                            <div style="position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); font-size: 0.65rem; font-weight: 600; color: var(--dark-blue); white-space: nowrap; margin-bottom: 2px;">
                                                                ${formatCurrencyShort(value)}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('');
                                    })()}
                                </div>
                                <!-- Year label -->
                                <span style="font-size: 0.9rem; font-weight: 600; color: var(--blue);">${year}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            };

            // Generate colored bar chart for fiscal year data matching table order
            const generateSimpleBarChartWithColors = (fiscalData, title, colors) => {
                if (!fiscalData || Object.keys(fiscalData).length === 0) return '';
                
                // Sort data by value to match table order (highest to lowest)
                const sortedData = Object.entries(fiscalData).sort((a, b) => b[1] - a[1]);
                const fyValues = sortedData.map(([_, value]) => value || 0);
                const fyKeys = sortedData.map(([key, _]) => key);
                const maxValue = Math.max(...fyValues);
                const totalValue = fyValues.reduce((sum, val) => sum + val, 0);
                
                return `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--orange); margin-bottom: 8px;">
                            ${formatCurrencyShort(totalValue)}
                        </div>
                    </div>
                    <div style="height: 200px; display: flex; align-items: flex-end; gap: 8px; padding: 0 10px;">
                        ${fyKeys.map((year, index) => {
                            const height = maxValue > 0 ? (fyValues[index] / maxValue * 160) : 5;
                            const color = colors[index % colors.length];
                            return `
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                    <!-- Value label above bar -->
                                    <div style="height: 30px; display: flex; align-items: flex-end; margin-bottom: 5px;">
                                        <span style="font-size: 0.8rem; font-weight: 600; color: var(--dark-blue); white-space: nowrap;">
                                            ${formatCurrencyShort(fyValues[index])}
                                        </span>
                                    </div>
                                    <!-- Colored Bar -->
                                    <div style="width: 100%; max-width: 60px; background: linear-gradient(to top, ${color}, ${color}cc); border-radius: 4px 4px 0 0; height: ${height}px; margin-bottom: 10px;"></div>
                                    <!-- Year label -->
                                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--blue);">${year}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            };

            // Define all available JSON columns with their properties
            const jsonColumns = [
                { key: 'obligations', title: 'Obligations Analysis', icon: '', description: 'Annual spending trends' },
                { key: 'smallBusiness', title: 'Small Business Distribution', icon: '', description: 'Small vs large business spending' },
                { key: 'sumTier', title: 'SUM Tier Analysis', icon: '', description: 'BIC and Tier distribution' },
                { key: 'sumType', title: 'SUM Type Breakdown', icon: '', description: 'Contract management types' },
                { key: 'contractVehicle', title: 'Contract Vehicles', icon: '', description: 'Top procurement vehicles' },
                { key: 'fundingDepartment', title: 'Funding Departments', icon: '', description: 'Department spending analysis' },
                { key: 'discount', title: 'Discount Analysis', icon: '', description: 'Discount categories and usage' },
                { key: 'topRefPiid', title: 'Top Reference PIIDs', icon: '', description: 'Most used reference contracts' },
                { key: 'topPiid', title: 'Top PIIDs', icon: '', description: 'Highest value contracts' },
                { key: 'activeContracts', title: 'Active Contracts', icon: '', description: 'Contract expiration analysis' },
                { key: 'discountOfferings', title: 'Discount Offerings', icon: '', description: 'Entity-specific discount analysis' },
                { key: 'aiProduct', title: 'Product Obligations', icon: '', description: 'AI product procurement trends' },
                { key: 'aiCategories', title: 'Category Obligations', icon: '', description: 'AI category distribution' },
                { key: 'topBicProducts', title: 'Product BIC Sales', icon: '', description: 'Best-selling BIC products' },
                { key: 'reseller', title: 'Reseller Analysis', icon: '', description: 'Reseller performance metrics' },
                { key: 'bicOem', title: 'OEM BIC Sales', icon: '', description: 'BIC manufacturer analysis' },
                { key: 'fundingAgency', title: 'Funding Agencies', icon: '', description: 'Agency funding distribution' },
                { key: 'oneGovTier', title: 'OneGov Tier Status', icon: '', description: 'Tier classification and trends' }
            ];

            // Generate slides for each available JSON column
            
            jsonColumns.forEach((column, index) => {
                const jsonData = entity[column.key];
                
                // Debug contract vehicle specifically
                if (column.key === 'contractVehicle') {
                    console.log(` CONTRACT VEHICLE SLIDE DEBUG: "${entity.name}" (${entity.type})`);
                    console.log(` Has contractVehicle data:`, !!jsonData);
                    if (jsonData) {
                        console.log(` contractVehicle keys:`, Object.keys(jsonData));
                        console.log(` Has top_contract_summaries:`, !!jsonData.top_contract_summaries);
                    } else {
                        console.log(` No contractVehicle data found for ${entity.name}`);
                    }
                }
                
                if (!jsonData) {
                    if (column.key === 'contractVehicle') {
                        console.log(` SKIPPING Contract Vehicle slide for ${entity.name} - no data`);
                    }
                    return;
                }


                try {
                    // Extract fiscal year data
                    const fiscalYearData = extractFiscalYearData(jsonData);
                    
                    // Calculate total value with special handling for different data types
                    let totalValue = 0;
                    
                    if (column.key === 'aiProduct') {
                        // For AI Products: use summary.grand_total_obligations
                        if (jsonData.summary && jsonData.summary.grand_total_obligations) {
                            totalValue = jsonData.summary.grand_total_obligations;
                        }
                    } else if (column.key === 'aiCategories') {
                        // For AI Categories, sum up category data from fiscal_year_summaries
                        if (jsonData.fiscal_year_summaries) {
                            Object.values(jsonData.fiscal_year_summaries).forEach(yearData => {
                                if (yearData.top_10_categories) {
                                    yearData.top_10_categories.forEach(cat => {
                                        if (cat.category && cat.obligations) {
                                            totalValue += cat.obligations;
                                        }
                                    });
                                }
                            });
                        } else {
                            // Try direct object structure
                            totalValue = Object.values(jsonData).reduce((sum, val) => {
                                if (typeof val === 'object' && val.total) {
                                    return sum + val.total;
                                } else if (typeof val === 'number') {
                                    return sum + val;
                                }
                                return sum;
                            }, 0);
                        }
                    } else if (column.key === 'fundingAgency') {
                        // For Funding Agency, sum up agency data
                        if (jsonData.top_10_agency_summaries) {
                            totalValue = Object.values(jsonData.top_10_agency_summaries).reduce((sum, val) => {
                                return sum + (val.total || val || 0);
                            }, 0);
                        } else {
                            // Try direct object structure
                            totalValue = Object.values(jsonData).reduce((sum, val) => {
                                if (typeof val === 'object' && val.total) {
                                    return sum + val.total;
                                } else if (typeof val === 'number') {
                                    return sum + val;
                                }
                                return sum;
                            }, 0);
                        }
                    } else {
                        // Default calculation for other charts
                        totalValue = jsonData.total_obligated || 
                                    jsonData.total || 
                                    (jsonData.summary?.total_all_obligations) ||
                                    (fiscalYearData ? Object.values(fiscalYearData).reduce((sum, val) => sum + val, 0) : 0);
                    }

                    // Generate table data based on column type
                    let tableContent = '';
                    
                    if (column.key === 'obligations' && jsonData.fiscal_year_obligations) {
                        const fyData = jsonData.fiscal_year_obligations;
                        const fyColors = ['#f47920', '#3a6ea5', '#144673', '#22c55e', '#ef4444'];
                        const sortedFYData = Object.entries(fyData).sort((a, b) => b[1] - a[1]);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem; width: 40px;"></th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Fiscal Year</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Obligations</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedFYData.map(([year, amount], idx) => {
                                    const percentage = totalValue > 0 ? (amount / totalValue * 100).toFixed(1) : 0;
                                    return `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px; text-align: center;">
                                                <div style="width: 12px; height: 12px; background: ${fyColors[idx % fyColors.length]}; border-radius: 3px; margin: auto;"></div>
                                            </td>
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">${year}</td>
                                            <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">${formatCurrencyShort(amount)}</td>
                                            <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">${percentage}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                                <tr style="border-top: 2px solid #144673; background: #f8f9fa; font-weight: bold;">
                                    <td style="padding: 8px; text-align: center;"></td>
                                    <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">TOTAL</td>
                                    <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">${formatCurrencyShort(totalValue)}</td>
                                    <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">100.0%</td>
                                </tr>
                            </tbody>
                        `;
                    } else if (column.key === 'sumTier' && jsonData.tier_summaries) {
                        const tierColors = {
                            'BIC': '#f47920',      // Orange
                            'TIER 2': '#144673',   // Navy blue  
                            'TIER 0': '#3a6ea5',   // Light blue
                            'TIER 1': '#22c55e'    // Green
                        };
                        
                        // Dynamically detect fiscal years from the data
                        const fiscalYears = detectFiscalYears(jsonData);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem; width: 40px;"></th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem; width: 120px;">Tier</th>
                                    ${fiscalYears.map(year => `
                                        <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">${year}</th>
                                    `).join('')}
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(jsonData.tier_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0)).map(([tier, data]) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; text-align: center;">
                                            <div style="width: 12px; height: 12px; background: ${tierColors[tier] || '#6b7280'}; border-radius: 3px; margin: auto;"></div>
                                        </td>
                                        <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: left; font-size: 0.8rem;">${tier}</td>
                                        ${fiscalYears.map(year => `
                                            <td style="padding: 6px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${formatCurrencyShort(data.fiscal_years?.[year] || 0)}</td>
                                        `).join('')}
                                        <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem; font-size: 0.8rem;">${formatCurrencyShort(data.total)}</td>
                                    </tr>
                                `).join('')}
                                ${(() => {
                                    // Calculate totals for each fiscal year and grand total
                                    let yearTotals = {};
                                    let grandTotal = 0;
                                    Object.entries(jsonData.tier_summaries).forEach(([tier, data]) => {
                                        fiscalYears.forEach(year => {
                                            yearTotals[year] = (yearTotals[year] || 0) + (data.fiscal_years?.[year] || 0);
                                        });
                                        grandTotal += data.total || 0;
                                    });
                                    return `
                                        <tr style="border-top: 2px solid #144673; background: #f8f9fa; font-weight: bold;">
                                            <td style="padding: 8px; text-align: center;"></td>
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: left;">TOTAL</td>
                                            ${fiscalYears.map(year => `
                                                <td style="padding: 6px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${formatCurrencyShort(yearTotals[year] || 0)}</td>
                                            `).join('')}
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem;">${formatCurrencyShort(grandTotal)}</td>
                                        </tr>
                                    `;
                                })()}
                            </tbody>
                        `;
                    } else if (column.key === 'sumType' && jsonData.sum_type_summaries) {
                        // Define specific colors using exact names from data
                        const sumTypeColors = {
                            'Governmentwide Management': '#144673',        // Navy blue (tallest)
                            'Agency Managed & IDIQ': '#f47920',           // Orange
                            'Open Market': '#3a6ea5'                      // Light blue
                        };
                        const sortedSumTypes = Object.entries(jsonData.sum_type_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0));
                        
                        const sumTypeYears = detectFiscalYears(jsonData);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem; width: 40px;"></th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); font-size: 0.8rem; min-width: 200px;">SUM Type</th>
                                    ${sumTypeYears.map(year => `<th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">${year}</th>`).join('')}
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedSumTypes.map(([sumType, data]) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; text-align: center;">
                                            <div style="width: 12px; height: 12px; background: ${sumTypeColors[sumType] || '#f47920'}; border-radius: 3px; margin: auto;"></div>
                                        </td>
                                        <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: left;">${sumType}</td>
                                        ${sumTypeYears.map(year => `<td style="padding: 8px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(data.fiscal_years?.[year] || 0)}</td>`).join('')}
                                        <td style="padding: 8px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(data.total)}</td>
                                    </tr>
                                `).join('')}
                                ${(() => {
                                    // Calculate totals for each fiscal year and grand total
                                    let yearTotals = {};
                                    let grandTotal = 0;
                                    sortedSumTypes.forEach(([sumType, data]) => {
                                        sumTypeYears.forEach(year => {
                                            yearTotals[year] = (yearTotals[year] || 0) + (data.fiscal_years?.[year] || 0);
                                        });
                                        grandTotal += data.total || 0;
                                    });
                                    return `
                                        <tr style="border-top: 2px solid #144673; background: #f8f9fa; font-weight: bold;">
                                            <td style="padding: 8px; text-align: center;"></td>
                                            <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); text-align: left; font-size: 0.8rem;">TOTAL</td>
                                            ${sumTypeYears.map(year => `<td style="padding: 8px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(yearTotals[year] || 0)}</td>`).join('')}
                                            <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(grandTotal)}</td>
                                        </tr>
                                    `;
                                })()}
                            </tbody>
                        `;
                    } else if (column.key === 'smallBusiness' && jsonData.business_size_summaries) {
                        // Define specific colors: SMALL BUSINESS=orange, OTHER THAN SMALL BUSINESS=navy, Not Specified=light blue
                        const businessSizeColors = {
                            'SMALL BUSINESS': '#f47920',                  // Orange  
                            'OTHER THAN SMALL BUSINESS': '#144673',       // Navy blue
                            'Not Specified': '#3a6ea5'                   // Light blue
                        };
                        const sortedSizes = Object.entries(jsonData.business_size_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0));
                        
                        const smallBusinessYears = detectFiscalYears(jsonData);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem; width: 40px;"></th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); font-size: 0.8rem; min-width: 200px;">Business Size</th>
                                    ${smallBusinessYears.map(year => `<th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">${year}</th>`).join('')}
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedSizes.map(([size, data]) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; text-align: center;">
                                            <div style="width: 12px; height: 12px; background: ${businessSizeColors[size] || '#f47920'}; border-radius: 3px; margin: auto;"></div>
                                        </td>
                                        <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: left;">${size}</td>
                                        ${smallBusinessYears.map(year => `<td style="padding: 8px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(data.fiscal_years?.[year] || 0)}</td>`).join('')}
                                        <td style="padding: 8px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(data.total)}</td>
                                    </tr>
                                `).join('')}
                                ${(() => {
                                    // Calculate totals for each fiscal year and grand total
                                    let yearTotals = {};
                                    let grandTotal = 0;
                                    sortedSizes.forEach(([size, data]) => {
                                        smallBusinessYears.forEach(year => {
                                            yearTotals[year] = (yearTotals[year] || 0) + (data.fiscal_years?.[year] || 0);
                                        });
                                        grandTotal += data.total || 0;
                                    });
                                    return `
                                        <tr style="border-top: 2px solid #144673; background: #f8f9fa; font-weight: bold;">
                                            <td style="padding: 8px; text-align: center;"></td>
                                            <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: left;">TOTAL</td>
                                            ${smallBusinessYears.map(year => `<td style="padding: 8px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(yearTotals[year] || 0)}</td>`).join('')}
                                            <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(grandTotal)}</td>
                                        </tr>
                                    `;
                                })()}
                            </tbody>
                        `;
                    } else if (column.key === 'contractVehicle' && jsonData.top_contract_summaries) {
                        const colors = ['#f47920', '#1e40af', '#dc2626', '#059669', '#7c3aed', '#ea580c', '#0891b2', '#be185d'];
                        const sortedVehicles = Object.entries(jsonData.top_contract_summaries)
                            .sort((a, b) => (b[1].total || 0) - (a[1].total || 0))
                            .slice(0, 8);
                        
                        const contractVehicleYears = detectFiscalYears(jsonData);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;"></th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Vehicle</th>
                                    ${contractVehicleYears.map(year => `<th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">${year}</th>`).join('')}
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedVehicles.map(([vehicle, data], idx) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; text-align: center;">
                                            <div style="width: 12px; height: 12px; background: ${colors[idx % colors.length]}; border-radius: 3px; margin: auto;"></div>
                                        </td>
                                        <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 120px;">${vehicle}</td>
                                        ${contractVehicleYears.map(year => `<td style="padding: 8px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(data.fiscal_years?.[year] || 0)}</td>`).join('')}
                                        <td style="padding: 8px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(data.total)}</td>
                                    </tr>
                                `).join('')}
                                ${(() => {
                                    // Calculate totals for each fiscal year and grand total
                                    let yearTotals = {};
                                    let grandTotal = 0;
                                    sortedVehicles.forEach(([vehicle, data]) => {
                                        contractVehicleYears.forEach(year => {
                                            yearTotals[year] = (yearTotals[year] || 0) + (data.fiscal_years?.[year] || 0);
                                        });
                                        grandTotal += data.total || 0;
                                    });
                                    return `
                                        <tr style="border-top: 2px solid #144673; background: #f8f9fa; font-weight: bold;">
                                            <td style="padding: 8px; text-align: center;"></td>
                                            <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 120px;">TOTAL</td>
                                            ${contractVehicleYears.map(year => `<td style="padding: 8px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(yearTotals[year] || 0)}</td>`).join('')}
                                            <td style="padding: 8px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.75rem;">${formatCurrencyShort(grandTotal)}</td>
                                        </tr>
                                    `;
                                })()}
                            </tbody>
                        `;
                    } else if (column.key === 'fundingDepartment' && jsonData.top_10_department_summaries) {
                        const departmentColors = ['#f47920', '#3a6ea5', '#144673', '#22c55e', '#ef4444', '#9333ea', '#6b7280', '#f97316', '#059669', '#dc2626'];
                        
                        const fundingDeptYears = detectFiscalYears(jsonData);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;"></th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Department</th>
                                    ${fundingDeptYears.map(year => `<th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">${year}</th>`).join('')}
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(jsonData.top_10_department_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0)).map(([dept, data], idx) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; text-align: center;">
                                            <div style="width: 12px; height: 12px; background: ${departmentColors[idx % departmentColors.length]}; border-radius: 3px; margin: auto;"></div>
                                        </td>
                                        <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 150px;">${dept}</td>
                                        ${fundingDeptYears.map(year => `<td style="padding: 6px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${formatCurrencyShort(data.fiscal_years?.[year] || 0)}</td>`).join('')}
                                        <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem;">${formatCurrencyShort(data.total)}</td>
                                    </tr>
                                `).join('')}
                                ${(() => {
                                    // Calculate totals for each fiscal year and grand total
                                    let yearTotals = {};
                                    let grandTotal = 0;
                                    const deptEntries = Object.entries(jsonData.top_10_department_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0));
                                    deptEntries.forEach(([dept, data]) => {
                                        fundingDeptYears.forEach(year => {
                                            yearTotals[year] = (yearTotals[year] || 0) + (data.fiscal_years?.[year] || 0);
                                        });
                                        grandTotal += data.total || 0;
                                    });
                                    return `
                                        <tr style="border-top: 2px solid #144673; background: #f8f9fa; font-weight: bold;">
                                            <td style="padding: 8px; text-align: center;"></td>
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 150px;">TOTAL</td>
                                            ${fundingDeptYears.map(year => `<td style="padding: 6px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${formatCurrencyShort(yearTotals[year] || 0)}</td>`).join('')}
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem;">${formatCurrencyShort(grandTotal)}</td>
                                        </tr>
                                    `;
                                })()}
                            </tbody>
                        `;
                    } else if (column.key === 'reseller' && jsonData.top_15_reseller_summaries) {
                        const resellerColors = ['#f47920', '#3a6ea5', '#144673', '#22c55e', '#ef4444', '#9333ea', '#6b7280', '#f97316', '#059669', '#dc2626', '#8b5cf6', '#06b6d4', '#84cc16', '#f59e0b', '#ec4899'];
                        
                        const resellerYears = detectFiscalYears(jsonData);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;"></th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Reseller</th>
                                    ${resellerYears.map(year => `<th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">${year}</th>`).join('')}
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(jsonData.top_15_reseller_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0)).map(([reseller, data], idx) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; text-align: center;">
                                            <div style="width: 12px; height: 12px; background: ${resellerColors[idx % resellerColors.length]}; border-radius: 3px; margin: auto;"></div>
                                        </td>
                                        <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 150px;">${reseller}</td>
                                        ${resellerYears.map(year => `<td style="padding: 6px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${formatCurrencyShort(data.fiscal_years?.[year] || 0)}</td>`).join('')}
                                        <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem;">${formatCurrencyShort(data.total)}</td>
                                    </tr>
                                `).join('')}
                                ${(() => {
                                    // Calculate totals for each fiscal year and grand total
                                    let yearTotals = {};
                                    let grandTotal = 0;
                                    const resellerEntries = Object.entries(jsonData.top_15_reseller_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0));
                                    resellerEntries.forEach(([reseller, data]) => {
                                        resellerYears.forEach(year => {
                                            yearTotals[year] = (yearTotals[year] || 0) + (data.fiscal_years?.[year] || 0);
                                        });
                                        grandTotal += data.total || 0;
                                    });
                                    return `
                                        <tr style="border-top: 2px solid #144673; background: #f8f9fa; font-weight: bold;">
                                            <td style="padding: 8px; text-align: center;"></td>
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 150px;">TOTAL</td>
                                            ${resellerYears.map(year => `<td style="padding: 6px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${formatCurrencyShort(yearTotals[year] || 0)}</td>`).join('')}
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem;">${formatCurrencyShort(grandTotal)}</td>
                                        </tr>
                                    `;
                                })()}
                            </tbody>
                        `;
                    } else if (column.key === 'fundingAgency' && jsonData.top_10_agency_summaries) {
                        const agencyColors = ['#f47920', '#3a6ea5', '#144673', '#22c55e', '#ef4444', '#9333ea', '#6b7280', '#f97316', '#059669', '#dc2626'];
                        
                        const fundingAgencyYears = detectFiscalYears(jsonData);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;"></th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Agency</th>
                                    ${fundingAgencyYears.map(year => `<th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">${year}</th>`).join('')}
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(jsonData.top_10_agency_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0)).map(([agency, data], idx) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; text-align: center;">
                                            <div style="width: 12px; height: 12px; background: ${agencyColors[idx % agencyColors.length]}; border-radius: 3px; margin: auto;"></div>
                                        </td>
                                        <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 150px;">${agency}</td>
                                        ${fundingAgencyYears.map(year => `<td style="padding: 6px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${formatCurrencyShort(data.fiscal_years?.[year] || 0)}</td>`).join('')}
                                        <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem;">${formatCurrencyShort(data.total)}</td>
                                    </tr>
                                `).join('')}
                                ${(() => {
                                    // Calculate totals for each fiscal year and grand total
                                    let yearTotals = {};
                                    let grandTotal = 0;
                                    const agencyEntries = Object.entries(jsonData.top_10_agency_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0));
                                    agencyEntries.forEach(([agency, data]) => {
                                        fundingAgencyYears.forEach(year => {
                                            yearTotals[year] = (yearTotals[year] || 0) + (data.fiscal_years?.[year] || 0);
                                        });
                                        grandTotal += data.total || 0;
                                    });
                                    return `
                                        <tr style="border-top: 2px solid #144673; background: #f8f9fa; font-weight: bold;">
                                            <td style="padding: 8px; text-align: center;"></td>
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 150px;">TOTAL</td>
                                            ${fundingAgencyYears.map(year => `<td style="padding: 6px; font-weight: 700; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${formatCurrencyShort(yearTotals[year] || 0)}</td>`).join('')}
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem;">${formatCurrencyShort(grandTotal)}</td>
                                        </tr>
                                    `;
                                })()}
                            </tbody>
                        `;
                    } else if (column.key === 'topRefPiid' && jsonData.top_10_reference_piids) {
                        const colors = ['#f47920', '#1e40af', '#dc2626', '#059669', '#7c3aed', '#ea580c', '#0891b2', '#be185d'];
                        const sortedRefPiids = jsonData.top_10_reference_piids
                            .sort((a, b) => (b.dollars_obligated || 0) - (a.dollars_obligated || 0))
                            .slice(0, 8);
                        
                        const refPiidYears = detectFiscalYears(jsonData);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;"></th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Reference PIID</th>
                                    ${refPiidYears.map(year => `<th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">${year}</th>`).join('')}
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Agencies</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedRefPiids.map((piid, idx) => `
                                    <tr style="border-bottom: 1px solid #f0f0f0;">
                                        <td style="padding: 8px; text-align: center;">
                                            <div style="width: 12px; height: 12px; background: ${colors[idx % colors.length]}; border-radius: 3px; margin: auto;"></div>
                                        </td>
                                        <td style="padding: 8px; text-align: left; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem;">${piid.reference_piid}</td>
                                        ${refPiidYears.map(year => `<td style="padding: 8px; text-align: right; font-size: 0.75rem;">${formatCurrencyShort(piid.fiscal_year_breakdown?.[year]?.obligations || 0)}</td>`).join('')}
                                        <td style="padding: 8px; text-align: right; font-weight: 600; color: var(--orange); font-size: 0.75rem;">${formatCurrencyShort(piid.dollars_obligated || 0)}</td>
                                        <td style="padding: 8px; text-align: center; font-size: 0.75rem;">${piid.agencies_using || 0}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        `;
                    } else if (column.key === 'topPiid' && jsonData.top_10_piids) {
                        const colors = ['#f47920', '#1e40af', '#dc2626', '#059669', '#7c3aed', '#ea580c', '#0891b2', '#be185d'];
                        const sortedPiids = jsonData.top_10_piids
                            .sort((a, b) => (b.dollars_obligated || 0) - (a.dollars_obligated || 0))
                            .slice(0, 8);
                        
                        const piidYears = detectFiscalYears(jsonData);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;"></th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">PIID</th>
                                    ${piidYears.map(year => `<th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">${year}</th>`).join('')}
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Agencies</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedPiids.map((piid, idx) => `
                                    <tr style="border-bottom: 1px solid #f0f0f0;">
                                        <td style="padding: 8px; text-align: center;">
                                            <div style="width: 12px; height: 12px; background: ${colors[idx % colors.length]}; border-radius: 3px; margin: auto;"></div>
                                        </td>
                                        <td style="padding: 8px; text-align: left; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem;">${piid.piid}</td>
                                        ${piidYears.map(year => `<td style="padding: 8px; text-align: right; font-size: 0.75rem;">${formatCurrencyShort(piid.fiscal_year_breakdown?.[year]?.obligations || 0)}</td>`).join('')}
                                        <td style="padding: 8px; text-align: right; font-weight: 600; color: var(--orange); font-size: 0.75rem;">${formatCurrencyShort(piid.dollars_obligated || 0)}</td>
                                        <td style="padding: 8px; text-align: center; font-size: 0.75rem;">${piid.agencies_using || 0}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        `;
                    } else if (column.key === 'oneGovTier' && jsonData.fiscal_year_tiers) {
                        const tierColors = ['#f47920', '#3a6ea5', '#144673', '#22c55e', '#ef4444'];
                        const sortedTiers = Object.entries(jsonData.fiscal_year_tiers).sort((a, b) => b[1].amount - a[1].amount);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem; width: 40px;"></th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Fiscal Year</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Tier</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Amount</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Obligations</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedTiers.map(([year, data], idx) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; text-align: center;">
                                            <div style="width: 12px; height: 12px; background: ${tierColors[idx % tierColors.length]}; border-radius: 3px; margin: auto;"></div>
                                        </td>
                                        <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">${year}</td>
                                        <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">${data.tier}</td>
                                        <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">${formatCurrencyShort(data.amount)}</td>
                                        <td style="padding: 6px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${formatCurrencyShort(data.amount)}</td>
                                    </tr>
                                `).join('')}
                                <tr style="border-top: 2px solid #144673; background: #f8f9fa; font-weight: bold;">
                                    <td style="padding: 8px; text-align: center;"></td>
                                    <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">TOTAL</td>
                                    <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">-</td>
                                    <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">${formatCurrencyShort(sortedTiers.reduce((sum, [_, data]) => sum + data.amount, 0))}</td>
                                    <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-align: center;">100.0%</td>
                                </tr>
                            </tbody>
                        `;
                    } else if (column.key === 'activeContracts' && jsonData) {
                        const contractColors = ['#f47920', '#3a6ea5', '#144673', '#22c55e', '#ef4444', '#9333ea', '#6b7280', '#f97316'];
                        const sortedContracts = Object.entries(jsonData).sort((a, b) => b[1] - a[1]).slice(0, 10);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;"></th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Contract</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total Value</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedContracts.map(([contract, value], idx) => {
                                    const percentage = totalValue > 0 ? (value / totalValue * 100).toFixed(1) : 0;
                                    return `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px; text-align: center;">
                                                <div style="width: 12px; height: 12px; background: ${contractColors[idx % contractColors.length]}; border-radius: 3px; margin: auto;"></div>
                                            </td>
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 200px;">${contract}</td>
                                            <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem;">${formatCurrencyShort(value)}</td>
                                            <td style="padding: 6px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${percentage}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        `;
                    } else if (column.key === 'discountOfferings' && jsonData) {
                        const offeringColors = ['#f47920', '#3a6ea5', '#144673', '#22c55e', '#ef4444', '#9333ea', '#6b7280', '#f97316'];
                        const sortedOfferings = Object.entries(jsonData).sort((a, b) => b[1] - a[1]).slice(0, 10);
                        
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;"></th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Offering</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Total Value</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedOfferings.map(([offering, value], idx) => {
                                    const percentage = totalValue > 0 ? (value / totalValue * 100).toFixed(1) : 0;
                                    return `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 8px; text-align: center;">
                                                <div style="width: 12px; height: 12px; background: ${offeringColors[idx % offeringColors.length]}; border-radius: 3px; margin: auto;"></div>
                                            </td>
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; min-width: 200px;">${offering}</td>
                                            <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem;">${formatCurrencyShort(value)}</td>
                                            <td style="padding: 6px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${percentage}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        `;
                    } else {
                        // Generic table for other data types
                        const summaryData = jsonData.summary || {};
                        tableContent = `
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Attribute</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--blue); white-space: nowrap; font-size: 0.8rem;">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem;">Total Value</td>
                                    <td style="padding: 12px; font-weight: 600; color: var(--dark-blue); font-size: 0.8rem;">${formatCurrencyShort(totalValue)}</td>
                                </tr>
                                ${Object.entries(summaryData).slice(0, 8).map(([key, value]) => {
                                    if (key.includes('total') && typeof value === 'number') return '';
                                    return `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 12px; font-weight: 700; color: var(--dark-blue); font-size: 0.8rem;">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                                            <td style="padding: 6px; font-weight: 600; color: var(--dark-blue); text-align: center; font-size: 0.8rem;">${value?.toString() || 'N/A'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        `;
                    }

                    
                    // Check if this is an integrated funnel chart that doesn't need separate table
                    const isIntegratedFunnelChart = ['aiProduct', 'aiCategories', 'topBicProducts', 'bicOem', 'fundingAgency', 'topPiid', 'topRefPiid'].includes(column.key);
                    
                    if (isIntegratedFunnelChart) {
                        // Full-width layout for integrated funnel charts
                        slides.push(`
                            <div style="min-width: 100%; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); padding: 32px;">
                                ${(() => {
                                    // Generate integrated funnel charts with tables
                                    if (column.key === 'aiProduct') {
                                        if (jsonData.fiscal_year_summaries) {
                                            // Build structure with fiscal year breakdown for each product
                                            const productData = {};
                                            const fiscalYears = detectFiscalYears(jsonData);
                                            
                                            // First, collect all unique products across all years
                                            const allProducts = new Set();
                                            Object.values(jsonData.fiscal_year_summaries).forEach(yearData => {
                                                if (yearData.top_10_products) {
                                                    yearData.top_10_products.forEach(prod => {
                                                        if (prod.product) allProducts.add(prod.product);
                                                    });
                                                }
                                            });
                                            
                                            // Build fiscal year structure for each product
                                            allProducts.forEach(productName => {
                                                productData[productName] = {
                                                    fiscal_years: {},
                                                    total: 0
                                                };
                                                
                                                fiscalYears.forEach(year => {
                                                    const yearData = jsonData.fiscal_year_summaries[year];
                                                    const productInYear = yearData?.top_10_products?.find(p => p.product === productName);
                                                    const obligations = productInYear?.obligations || 0;
                                                    
                                                    productData[productName].fiscal_years[year] = obligations;
                                                    productData[productName].total += obligations;
                                                });
                                            });
                                            
                                            return generateFunnelChart(productData, column.title, false, true, true);
                                        } else {
                                            return '<div style="text-align: center; padding: 40px; color: #666;">No AI Product data available</div>';
                                        }
                                    } else if (column.key === 'aiCategories') {
                                        if (jsonData.fiscal_year_summaries) {
                                            // Build structure with fiscal year breakdown for each category
                                            const categoryData = {};
                                            const fiscalYears = detectFiscalYears(jsonData);
                                            
                                            // First, collect all unique categories across all years
                                            const allCategories = new Set();
                                            Object.values(jsonData.fiscal_year_summaries).forEach(yearData => {
                                                if (yearData.top_10_categories) {
                                                    yearData.top_10_categories.forEach(cat => {
                                                        if (cat.category) allCategories.add(cat.category);
                                                    });
                                                }
                                            });
                                            
                                            // Build fiscal year structure for each category
                                            allCategories.forEach(categoryName => {
                                                categoryData[categoryName] = {
                                                    fiscal_years: {},
                                                    total: 0
                                                };
                                                
                                                fiscalYears.forEach(year => {
                                                    const yearData = jsonData.fiscal_year_summaries[year];
                                                    const categoryInYear = yearData?.top_10_categories?.find(c => c.category === categoryName);
                                                    const obligations = categoryInYear?.obligations || 0;
                                                    
                                                    categoryData[categoryName].fiscal_years[year] = obligations;
                                                    categoryData[categoryName].total += obligations;
                                                });
                                            });
                                            
                                            return generateFunnelChart(categoryData, column.title, false, true, true);
                                        } else {
                                            return '<div style="text-align: center; padding: 40px; color: #666;">No AI Category data available</div>';
                                        }
                                    } else if (column.key === 'topBicProducts') {
                                        console.log(' DEBUG topBicProducts jsonData:', jsonData);
                                        console.log(' DEBUG topBicProducts top_25_products:', jsonData.top_25_products);
                                        if (jsonData.top_25_products) {
                                            return generateFunnelChart(jsonData.top_25_products, column.title, true, true, true);
                                        } else {
                                            return '<div style="text-align: center; padding: 40px; color: #666;">No BIC Product data available</div>';
                                        }
                                    } else if (column.key === 'bicOem') {
                                        console.log(' DEBUG bicOem jsonData:', jsonData);
                                        console.log(' DEBUG bicOem top_15_manufacturers:', jsonData.top_15_manufacturers);
                                        if (jsonData.top_15_manufacturers) {
                                            return generateFunnelChart(jsonData.top_15_manufacturers, column.title, true, true, true);
                                        } else {
                                            return '<div style="text-align: center; padding: 40px; color: #666;">No BIC OEM data available</div>';
                                        }
                                    } else if (column.key === 'fundingAgency') {
                                        if (jsonData.top_10_agency_summaries) {
                                            return generateFunnelChart(jsonData.top_10_agency_summaries, column.title, false, true, true);
                                        } else {
                                            return '<div style="text-align: center; padding: 40px; color: #666;">No Funding Agency data available</div>';
                                        }
                                    } else if (column.key === 'topRefPiid') {
                                        console.log(' DEBUG topRefPiid data:', jsonData);
                                        if (jsonData.top_10_reference_piids) {
                                            return generateFunnelChart(jsonData.top_10_reference_piids, column.title, true, true, true);
                                        } else {
                                            return '<div style="text-align: center; padding: 40px; color: #666;">No Reference PIID data available</div>';
                                        }
                                    } else if (column.key === 'topPiid') {
                                        console.log(' DEBUG topPiid data:', jsonData);
                                        if (jsonData.top_10_piids) {
                                            return generateFunnelChart(jsonData.top_10_piids, column.title, true, true, true);
                                        } else {
                                            return '<div style="text-align: center; padding: 40px; color: #666;">No PIID data available</div>';
                                        }
                                    }
                                    return '<div style="text-align: center; padding: 40px; color: #666;">Chart data not found</div>';
                                })()}
                            </div>
                        `);
                    } else {
                        // Standard two-column layout for regular charts
                        slides.push(`
                            <div style="min-width: 100%; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); padding: 32px; display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                                <div>
                                    <h3 style="color: var(--blue); margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                        ${column.icon} ${column.title}
                                    </h3>
                                    ${(() => {
                                        // Generate appropriate BAR CHART based on column type
                                        if (column.key === 'obligations' && jsonData.fiscal_year_obligations) {
                                            // Get sorted order to match table colors exactly
                                            const fyData = jsonData.fiscal_year_obligations;
                                            const fyColors = ['#f47920', '#3a6ea5', '#144673', '#22c55e', '#ef4444'];
                                            const sortedFYData = Object.entries(fyData).sort((a, b) => b[1] - a[1]);
                                            const orderedFYColors = sortedFYData.map((_, idx) => fyColors[idx % fyColors.length]);
                                            return generateSimpleBarChartWithColors(fyData, '', orderedFYColors);
                                        } else if (column.key === 'smallBusiness' && jsonData.business_size_summaries) {
                                            // Get sorted order to match table colors exactly  
                                            const sortedSizes = Object.entries(jsonData.business_size_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0));
                                            const businessSizeColors = {
                                                'SMALL BUSINESS': '#f47920',                  // Orange  
                                                'OTHER THAN SMALL BUSINESS': '#144673',       // Navy blue
                                                'Not Specified': '#3a6ea5'                   // Light blue
                                            };
                                            const orderedColors = sortedSizes.map(([sizeName]) => businessSizeColors[sizeName] || '#f47920');
                                            return generateGroupedBarChart(jsonData.business_size_summaries, '', orderedColors, true);
                                        } else if (column.key === 'sumTier' && jsonData.tier_summaries) {
                                            return generateGroupedBarChart(jsonData.tier_summaries, '', ['#f47920', '#144673', '#3a6ea5', '#22c55e'], true);
                                        } else if (column.key === 'sumType' && jsonData.sum_type_summaries) {
                                            // Get sorted order to match table colors exactly
                                            const sortedSumTypes = Object.entries(jsonData.sum_type_summaries).sort((a, b) => (b[1].total || 0) - (a[1].total || 0));
                                            const sumTypeColors = {
                                                'Governmentwide Management': '#144673',        // Navy blue (tallest)
                                                'Agency Managed & IDIQ': '#f47920',           // Orange
                                                'Open Market': '#3a6ea5'                      // Light blue
                                            };
                                            const orderedSumTypeColors = sortedSumTypes.map(([typeName]) => sumTypeColors[typeName] || '#f47920');
                                            return generateGroupedBarChart(jsonData.sum_type_summaries, '', orderedSumTypeColors, true);
                                        } else if (column.key === 'contractVehicle') {
                                            console.log(` CONTRACT VEHICLE SLIDE: "${entity.name}" (${entity.type}):`, jsonData);
                                            console.log(` CONTRACT VEHICLE: Has top_contract_summaries:`, !!jsonData.top_contract_summaries);
                                            console.log(` CONTRACT VEHICLE: Available keys:`, Object.keys(jsonData));
                                            
                                            if (jsonData.top_contract_summaries) {
                                                console.log(` GENERATING Contract Vehicle slide for ${entity.name}`);
                                                return generateFunnelChart(jsonData.top_contract_summaries, column.title, false);
                                            } else {
                                                console.log(` NO top_contract_summaries for ${entity.name}, checking for alternatives...`);
                                                // Check for alternative structures
                                                const contractKeys = Object.keys(jsonData).filter(key => 
                                                    !['summary', 'processed_date', 'source_file'].includes(key)
                                                );
                                                if (contractKeys.length > 0) {
                                                    console.log(` Using alternative contract data for ${entity.name}:`, contractKeys);
                                                    return generateFunnelChart(jsonData, column.title, false);
                                                } else {
                                                    console.log(` No usable contract vehicle data for ${entity.name}`);
                                                    return '<div style="text-align: center; padding: 40px; color: #666;">No Contract Vehicle data available</div>';
                                                }
                                            }
                                        } else if (column.key === 'fundingDepartment' && jsonData.top_10_department_summaries) {
                                            return generateGroupedBarChart(jsonData.top_10_department_summaries, '');
                                        } else if (column.key === 'discount' && jsonData.discount_categories) {
                                            return generateGroupedBarChart(jsonData.discount_categories, '');
                                        } else if (column.key === 'reseller' && jsonData.top_15_reseller_summaries) {
                                            return generateGroupedBarChart(jsonData.top_15_reseller_summaries, '');
                                        } else if (column.key === 'activeContracts' && jsonData) {
                                            return generateGroupedBarChart(jsonData, '');
                                        } else if (column.key === 'discountOfferings' && jsonData) {
                                            return generateGroupedBarChart(jsonData, '');
                                        } else if (column.key === 'oneGovTier' && jsonData.fiscal_year_tiers) {
                                            // Special handling for OneGov Tier - show tier changes over time with colors matching table
                                            const tierData = {};
                                            Object.entries(jsonData.fiscal_year_tiers).forEach(([year, data]) => {
                                                tierData[year] = data.amount;
                                            });
                                            const tierColors = ['#f47920', '#3a6ea5', '#144673', '#22c55e', '#ef4444'];
                                            return generateSimpleBarChartWithColors(tierData, '', tierColors);
                                        } else if (fiscalYearData) {
                                            // Fallback to simple bar chart for any data with fiscal years
                                            return generateSimpleBarChart(fiscalYearData, '');
                                        } else {
                                            // No fiscal year data - show summary
                                            return `
                                                <div style="text-align: center; margin-bottom: 20px;">
                                                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--orange); margin-bottom: 8px;">
                                                        ${formatCurrencyShort(totalValue)}
                                                    </div>
                                                    <div style="font-size: 0.9rem; color: var(--blue);">
                                                        Total Value
                                                    </div>
                                                </div>
                                                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                                                    <div style="font-size: 4rem; margin-bottom: 16px;">${column.icon}</div>
                                                    <div style="color: var(--blue); font-weight: 600; margin-bottom: 8px;">Point-in-Time Data</div>
                                                    <div style="color: #666; font-size: 0.8rem;">Detailed breakdown available in table view</div>
                                                </div>
                                            `;
                                        }
                                    })()}
                                </div>
                                
                                <div>
                                    <h3 style="color: var(--blue); margin-bottom: 20px;"> ${column.title} Details</h3>
                                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                                        <table style="min-width: 800px; width: 100%; border-collapse: collapse;">
                                            ${tableContent}
                                        </table>
                                        <div style="padding: 8px; text-align: center; font-size: 0.8rem; color: var(--blue); background: #f8f9fa; border-top: 1px solid #e5e7eb;">
                                            ${tableContent.includes('<tbody>') ? 'Scroll down to view more data' : 'All data shown'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    }

                } catch (error) {
                    console.warn(`Error generating slide for ${column.key}:`, error);
                }
            });
            
            console.log(` DETAIL CAROUSEL DEBUG: Generated ${slides.length} slides total`);
            console.log(` DETAIL CAROUSEL DEBUG: Slides HTML length:`, slides.join('').length, 'characters');
            
            return slides.join('');
        };
        
        // Carousel functionality for entity detail
        let currentDetailSlide = 0;
        let totalDetailSlides = 0;
        
        const initDetailCarousel = () => {
            const slides = document.querySelectorAll('#detail-carousel-track > div');
            totalDetailSlides = slides.length;
            currentDetailSlide = 0;
            
            console.log(` DETAIL CAROUSEL DEBUG: initDetailCarousel found ${totalDetailSlides} slides in DOM`);
            slides.forEach((slide, index) => {
                console.log(` DETAIL CAROUSEL DEBUG: Slide ${index + 1} HTML length:`, slide.innerHTML.length);
            });
            
            // Create indicators
            const indicators = document.getElementById('detail-indicators');
            indicators.innerHTML = '';
            for (let i = 0; i < totalDetailSlides; i++) {
                const indicator = document.createElement('div');
                indicator.style.cssText = `
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background: ${i === 0 ? 'var(--orange)' : '#ccc'};
                    cursor: pointer;
                    transition: background 0.3s ease;
                `;
                indicator.onclick = () => goToDetailSlide(i);
                indicators.appendChild(indicator);
            }
            
            updateDetailSlide();
        };
        
        const updateDetailSlide = () => {
            const track = document.getElementById('detail-carousel-track');
            const indicators = document.querySelectorAll('#detail-indicators > div');
            
            if (track) {
                track.style.transform = `translateX(-${currentDetailSlide * 100}%)`;
            }
            
            indicators.forEach((indicator, index) => {
                indicator.style.background = index === currentDetailSlide ? 'var(--orange)' : '#ccc';
            });
        };
        
        const nextDetailSlide = () => {
            currentDetailSlide = (currentDetailSlide + 1) % totalDetailSlides;
            updateDetailSlide();
        };
        
        const prevDetailSlide = () => {
            currentDetailSlide = (currentDetailSlide - 1 + totalDetailSlides) % totalDetailSlides;
            updateDetailSlide();
        };
        
        const goToDetailSlide = (index) => {
            currentDetailSlide = index;
            updateDetailSlide();
        };
        
        // Make functions globally available
        window.nextDetailSlide = nextDetailSlide;
        window.prevDetailSlide = prevDetailSlide;

        // Report Builder View Component
        const ReportBuilderView = () => {
            console.log('FRONTEND: ReportBuilderView component mounted');
            const [selections, setSelections] = React.useState({});
            const [currentFilter, setCurrentFilter] = React.useState('all');
            const [flippedCards, setFlippedCards] = React.useState({});
            const [showModal, setShowModal] = React.useState(false);
            const [exportDestination, setExportDestination] = React.useState('sheets');
            const [isExporting, setIsExporting] = React.useState(false);
            
            // New states for backend data
            const [cardData, setCardData] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [entityNameFilter, setEntityNameFilter] = React.useState('');
            const [parentDeptFilter, setParentDeptFilter] = React.useState('');
            const [availableEntities, setAvailableEntities] = React.useState([]);
            const [availableParents, setAvailableParents] = React.useState([]);
            
            // Column-first approach state variables
            const [selectedEntityType, setSelectedEntityType] = React.useState(null);
            const [selectedColumn, setSelectedColumn] = React.useState('obligations');
            const [topN, setTopN] = React.useState(10); // Default to Top 10
            const [availableColumns, setAvailableColumns] = React.useState([]);
            
            // Entity name filtering state variables
            const [selectedEntities, setSelectedEntities] = React.useState([]);
            const [availableEntityNames, setAvailableEntityNames] = React.useState([]);
            
            const getDefaultCardData = () => [
                {
                    id: 'obligations',
                    title: 'Five-Year Obligations Trend',
                    category: 'financial',
                    chartType: 'line',
                    chartData: {
                        labels: ['FY22', 'FY23', 'FY24', 'FY25', 'FY26'],
                        datasets: [{
                            label: 'Obligations ($M)',
                            data: [286, 358, 598, 258, 185],
                            borderColor: '#144673',
                            backgroundColor: 'rgba(20, 70, 115, 0.1)',
                            tension: 0.4
                        }]
                    },
                    tableData: {
                        headers: ['Fiscal Year', 'Obligations', 'YoY Change', '% Change'],
                        rows: [
                            ['FY22', '$286M', '--', '--'],
                            ['FY23', '$358M', '+$72M', '+25.2%'],
                            ['FY24', '$598M', '+$240M', '+67.0%'],
                            ['FY25', '$258M', '-$340M', '-56.9%'],
                            ['FY26*', '$185M', '-$73M', '-28.3%']
                        ]
                    }
                },
                {
                    id: 'tier-dist',
                    title: 'Government Tier Distribution',
                    category: 'financial',
                    chartType: 'bar',
                    chartData: {
                        labels: ['BIC', 'Tier 2', 'Tier 1', 'Tier 0'],
                        datasets: [{
                            label: 'Total ($M)',
                            data: [831, 527, 75, 65],
                            backgroundColor: ['#144673', '#3a6ea5', '#f47920', '#ff6b35']
                        }]
                    },
                    tableData: {
                        headers: ['Tier', 'FY22', 'FY23', 'FY24', 'FY25', 'Total', '%'],
                        rows: [
                            ['BIC', '$155M', '$211M', '$298M', '$168M', '$831M', '55.5%'],
                            ['Tier 2', '$56M', '$116M', '$279M', '$76M', '$527M', '35.2%'],
                            ['Tier 1', '$51M', '$11M', '$13M', '$357K', '$75M', '5.0%'],
                            ['Tier 0', '$24M', '$20M', '$8M', '$14M', '$65M', '4.3%']
                        ]
                    }
                },
                {
                    id: 'resellers',
                    title: 'Top 10 Resellers Performance',
                    category: 'vendors',
                    chartType: 'doughnut',
                    chartData: {
                        labels: ['Four Points', 'AWS Direct', 'Strategic', 'New Tech', 'ThunderCat', 'Other'],
                        datasets: [{
                            data: [612, 390, 121, 46, 45, 285],
                            backgroundColor: ['#0a2240', '#144673', '#3a6ea5', '#f47920', '#ff6b35', '#e5e7eb']
                        }]
                    },
                    tableData: {
                        headers: ['Rank', 'Reseller Name', 'Total', '% of Total'],
                        rows: [
                            ['1', 'Four Points Technology', '$612M', '40.8%'],
                            ['2', 'Amazon Web Services', '$390M', '26.0%'],
                            ['3', 'Strategic Communications', '$121M', '8.1%'],
                            ['4', 'New Tech Solutions', '$46M', '3.0%'],
                            ['5', 'ThunderCat Technology', '$45M', '3.0%']
                        ]
                    }
                }
            ];

            // Load data from backend on component mount
            React.useEffect(() => {
                console.log('FRONTEND: useEffect triggered, about to load data');
                loadReportData();
                loadFilterOptions();
            }, []);
            
            // Load filter options when entity type changes
            React.useEffect(() => {
                if (selectedEntityType) {
                    loadFilterOptions(selectedEntityType);
                    loadEntityNames(selectedEntityType);
                    loadAvailableColumns(selectedEntityType);
                    // Clear filters when entity type changes
                    setParentDeptFilter('');
                    setSelectedEntities([]);
                }
            }, [selectedEntityType]);
            
            // Reload data when selection or filters change
            React.useEffect(() => {
                if (selectedEntityType) {
                    if (parentDeptFilter) {
                        loadFilteredData();
                    } else {
                        loadReportData();
                    }
                }
            }, [selectedEntityType, selectedColumn, topN, parentDeptFilter, selectedEntities]);
            
            const loadReportData = async () => {
                if (!selectedEntityType) {
                    setCardData([]);
                    setLoading(false);
                    return;
                }
                
                try {
                    setLoading(true);
                    console.log('FRONTEND: Loading column-first data for:', selectedEntityType, selectedColumn, topN);
                    
                    google.script.run
                        .withSuccessHandler((data) => {
                            console.log(' FRONTEND: Loaded column report data:', data);
                            console.log(' FRONTEND: Data type:', typeof data);
                            console.log(' FRONTEND: Data length:', data?.length);
                            console.log(' FRONTEND: First card debug info:', data?.[0]?.debugInfo);
                            console.log(' FRONTEND: All cards debug:', data?.map(c => c.debugInfo));
                            setCardData(data || getDefaultCardData());
                            setLoading(false);
                        })
                        .withFailureHandler((error) => {
                            console.error('FRONTEND: Error loading column report data:', error);
                            setCardData(getDefaultCardData());
                            setLoading(false);
                        })
                        .generateColumnReports(selectedEntityType, selectedColumn, topN, selectedEntities);
                } catch (error) {
                    console.error('Error in loadReportData:', error);
                    setCardData(getDefaultCardData());
                    setLoading(false);
                }
            };
            
            const loadFilterOptions = async (entityType = null) => {
                try {
                    console.log('FRONTEND: Loading filter options for entity type:', entityType);
                    google.script.run
                        .withSuccessHandler((data) => {
                            console.log('FRONTEND: Loaded filter options:', data);
                            if (data) {
                                setAvailableEntities(data.entities || []);
                                setAvailableParents(data.parents || []);
                            }
                        })
                        .withFailureHandler((error) => {
                            console.error('Error loading filter options:', error);
                        })
                        .getReportBuilderFilters(entityType);
                } catch (error) {
                    console.error('Error in loadFilterOptions:', error);
                }
            };
            
            const loadAvailableColumns = async (entityType) => {
                try {
                    console.log(' FRONTEND: Loading available columns for entity type:', entityType);
                    google.script.run
                        .withSuccessHandler((columns) => {
                            console.log(' FRONTEND: Loaded available columns:', columns);
                            setAvailableColumns(columns || []);
                            // Reset to 'obligations' if current selection not in new columns
                            if (columns && columns.length > 0 && !columns.find(col => col.id === selectedColumn)) {
                                const defaultCol = columns.find(col => col.id === 'obligations') || columns[0];
                                setSelectedColumn(defaultCol.id);
                            }
                        })
                        .withFailureHandler((error) => {
                            console.error(' FRONTEND: Error loading available columns:', error);
                            // Fallback to default columns
                            setAvailableColumns([
                                { id: 'obligations', name: 'Obligations' },
                                { id: 'contracts', name: 'Contracts' }
                            ]);
                        })
                        .getAvailableColumns(entityType);
                } catch (error) {
                    console.error('Error in loadAvailableColumns:', error);
                    setAvailableColumns([{ id: 'obligations', name: 'Obligations' }]);
                }
            };
            
            const loadEntityNames = async (entityType) => {
                try {
                    console.log('FRONTEND: Loading entity names for:', entityType);
                    google.script.run
                        .withSuccessHandler((data) => {
                            console.log('FRONTEND: Loaded entity names:', data?.length || 0, 'entities');
                            setAvailableEntityNames(data || []);
                        })
                        .withFailureHandler((error) => {
                            console.error('Error loading entity names:', error);
                            setAvailableEntityNames([]);
                        })
                        .getEntityNames(entityType);
                } catch (error) {
                    console.error('Error in loadEntityNames:', error);
                    setAvailableEntityNames([]);
                }
            };
            
            const loadFilteredData = async () => {
                if (!selectedEntityType) {
                    setCardData([]);
                    setLoading(false);
                    return;
                }
                
                try {
                    setLoading(true);
                    console.log('FRONTEND: Loading filtered column data for:', selectedEntityType, selectedColumn, 'with parent filter:', parentDeptFilter);
                    
                    google.script.run
                        .withSuccessHandler((data) => {
                            console.log('FRONTEND: Loaded filtered column data:', data);
                            setCardData(data || []);
                            setLoading(false);
                        })
                        .withFailureHandler((error) => {
                            console.error('FRONTEND: Error loading filtered column data:', error);
                            setCardData([]);
                            setLoading(false);
                        })
                        .getFilteredReportBuilderData(entityNameFilter, parentDeptFilter);
                } catch (error) {
                    console.error('Error in loadFilteredData:', error);
                    setCardData([]);
                    setLoading(false);
                }
            };
            
            const toggleFlip = (cardId) => {
                setFlippedCards(prev => ({
                    ...prev,
                    [cardId]: !prev[cardId]
                }));
            };
            
            const toggleSelection = (cardId, side) => {
                setSelections(prev => {
                    const current = prev[cardId] || { chart: false, table: false };
                    return {
                        ...prev,
                        [cardId]: {
                            ...current,
                            [side]: !current[side]
                        }
                    };
                });
            };
            
            const getSelectionState = (cardId) => {
                const sel = selections[cardId];
                if (!sel) return 'unselected';
                if (sel.chart && sel.table) return 'both';
                if (sel.chart) return 'chart';
                if (sel.table) return 'table';
                return 'unselected';
            };
            
            const getSelectionCount = () => {
                return Object.values(selections).reduce((count, sel) => {
                    if (sel.chart) count++;
                    if (sel.table) count++;
                    return count;
                }, 0);
            };
            
            const resetSelections = () => {
                setSelections({});
                setFlippedCards({});
            };

            return (
                <div>
                    {/* Modern Control Panel */}
                    <div style={{
                        background: 'white',
                        borderBottom: '2px solid #e5e7eb',
                        boxShadow: '0 4px 6px rgba(0,0,0,0.05)',
                        position: 'sticky',
                        top: '0',
                        zIndex: 100
                    }}>
                        <div style={{
                            maxWidth: '1600px',
                            margin: '0 auto',
                            padding: '20px 24px'
                        }}>
                            {/* Row 1: Entity Type Buttons */}
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '16px',
                                marginBottom: '16px'
                            }}>
                                <div style={{fontSize: '1.1rem', fontWeight: '700', color: '#1f2937'}}>Report Builder</div>
                                <div style={{display: 'flex', gap: '8px'}}>
                                    {['agency', 'oem', 'vendor'].map(type => (
                                        <button 
                                            key={type}
                                            onClick={() => setSelectedEntityType(type)}
                                            style={{
                                                padding: '10px 20px',
                                                borderRadius: '20px',
                                                border: 'none',
                                                background: selectedEntityType === type ? '#144673' : '#f3f4f6',
                                                color: selectedEntityType === type ? 'white' : '#374151',
                                                fontSize: '0.875rem',
                                                fontWeight: '600',
                                                cursor: 'pointer',
                                                transition: 'all 0.2s ease'
                                            }}
                                        >
                                            {type.charAt(0).toUpperCase() + type.slice(1)}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Row 2: Column Selector, Top N, Filters, Generate */}
                            {selectedEntityType && (
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '12px',
                                    flexWrap: 'wrap'
                                }}>
                                    <select 
                                        value={selectedColumn}
                                        onChange={(e) => setSelectedColumn(e.target.value)}
                                        style={{
                                            padding: '8px 16px',
                                            borderRadius: '6px',
                                            fontSize: '0.875rem',
                                            border: '1px solid #d1d5db',
                                            background: 'white',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        {availableColumns.length > 0 ? (
                                            availableColumns.map((column) => (
                                                <option key={column.id} value={column.id}>
                                                    {column.name}
                                                </option>
                                            ))
                                        ) : (
                                            <>
                                                <option value="obligations">Obligations</option>
                                                <option value="smallBusiness">Small Business</option>
                                                <option value="sumTier">SUM Tier</option>
                                                <option value="contractVehicle">Contract Vehicle</option>
                                                {selectedEntityType === 'oem' && (
                                                    <>
                                                        <option value="aiProduct">AI Product</option>
                                                        <option value="reseller">Reseller</option>
                                                    </>
                                                )}
                                                {selectedEntityType === 'vendor' && (
                                                    <>
                                                        <option value="fiscalYear">Fiscal Year Analysis</option>
                                                        <option value="reseller">Reseller</option>
                                                        <option value="setAside">Set Aside Program</option>
                                                    </>
                                                )}
                                                {selectedEntityType === 'agency' && (
                                                    <>
                                                        <option value="fiscalYear">Fiscal Year Analysis</option>
                                                        <option value="contracting">Contracting Office</option>
                                                        <option value="funding">Funding Office</option>
                                                    </>
                                                )}
                                            </>
                                        )}
                                    </select>

                                    <div style={{display: 'flex', gap: '4px'}}>
                                        {[5, 10, 15].map(n => (
                                            <button 
                                                key={n}
                                                onClick={() => setTopN(n)}
                                                style={{
                                                    padding: '6px 12px',
                                                    borderRadius: '4px',
                                                    border: '1px solid #d1d5db',
                                                    background: topN === n ? '#144673' : 'white',
                                                    color: topN === n ? 'white' : '#374151',
                                                    fontSize: '0.8rem',
                                                    fontWeight: '600',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                Top {n}
                                            </button>
                                        ))}
                                    </div>

                                    <select 
                                        value={selectedEntities.length === 0 ? '' : selectedEntities[0]}
                                        onChange={(e) => {
                                            if (e.target.value === '') {
                                                setSelectedEntities([]);
                                            } else {
                                                setSelectedEntities([e.target.value]);
                                            }
                                        }}
                                        style={{
                                            padding: '8px 16px',
                                            borderRadius: '6px',
                                            fontSize: '0.875rem',
                                            border: '1px solid #d1d5db',
                                            background: 'white',
                                            cursor: 'pointer',
                                            minWidth: '150px'
                                        }}
                                    >
                                        <option value="">
                                            {selectedEntityType === 'agency' ? `All Agencies` : 
                                             selectedEntityType === 'oem' ? `All OEMs` : 
                                             selectedEntityType === 'vendor' ? `All Vendors` : 'All Entities'}
                                        </option>
                                        {availableEntityNames.map(entity => (
                                            <option key={entity.value} value={entity.value}>
                                                {entity.label}
                                            </option>
                                        ))}
                                    </select>

                                    <select 
                                        value={parentDeptFilter}
                                        onChange={(e) => setParentDeptFilter(e.target.value)}
                                        style={{
                                            padding: '8px 16px',
                                            borderRadius: '6px',
                                            fontSize: '0.875rem',
                                            border: '1px solid #d1d5db',
                                            background: 'white',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        <option value="">{selectedEntityType === 'agency' ? 'All Departments' : 'All Parents'}</option>
                                        {availableParents.map(parent => (
                                            <option key={parent} value={parent}>{parent}</option>
                                        ))}
                                    </select>

                                    <button 
                                        onClick={loadReportData}
                                        style={{
                                            padding: '8px 16px',
                                            borderRadius: '6px',
                                            fontSize: '0.875rem',
                                            background: 'linear-gradient(135deg, #f47920, #ff6b35)',
                                            color: 'white',
                                            border: 'none',
                                            fontWeight: '600',
                                            boxShadow: '0 2px 8px rgba(244, 121, 32, 0.3)',
                                            cursor: 'pointer'
                                        }}
                                        disabled={loading}
                                    >
                                        {loading ? 'Loading...' : 'Generate'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Cards Grid */}
                    <div style={{maxWidth: '1600px', margin: '0 auto', padding: '24px'}}>
                        {!selectedEntityType ? (
                            <div style={{textAlign: 'center', padding: '60px', background: 'white', borderRadius: '8px', boxShadow: '0 2px 8px rgba(0,0,0,0.12)'}}>
                                <h3 style={{color: '#1f2937', marginBottom: '12px', fontSize: '1.3rem'}}>Select Entity Type to Begin</h3>
                                <p style={{color: '#6b7280', fontSize: '1rem'}}>Choose Agency, OEM, or Vendor above to generate column-specific reports with only 4 focused cards instead of 28+</p>
                            </div>
                        ) : loading ? (
                            <div style={{textAlign: 'center', padding: '50px'}}>
                                <div style={{
                                    width: '50px', 
                                    height: '50px',
                                    border: '3px solid #e5e7eb',
                                    borderTop: '3px solid #f47920',
                                    borderRadius: '50%',
                                    animation: 'spin 1s linear infinite',
                                    margin: '0 auto 20px'
                                }}></div>
                                <p style={{color: '#6b7280'}}>Loading {selectedColumn} data for {selectedEntityType}...</p>
                            </div>
                        ) : cardData.length === 0 ? (
                            <div style={{textAlign: 'center', padding: '50px', background: 'white', borderRadius: '8px', boxShadow: '0 2px 8px rgba(0,0,0,0.12)'}}>
                                <h3 style={{color: '#1f2937', marginBottom: '12px'}}>No Data Available</h3>
                                <p style={{color: '#6b7280'}}>No {selectedColumn} data found for {selectedEntityType}. Try selecting a different column or entity type.</p>
                            </div>
                        ) : (
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(380px, 1fr))',
                                gap: '24px'
                            }}>
                                {cardData.map((card, index) => {
                                    console.log(`CARD ${index} FULL DATA:`, JSON.stringify(card, null, 2));
                                    return (
                                        <ReportBuilderCard
                                            key={card.id}
                                            card={card}
                                            isFlipped={flippedCards[card.id]}
                                            selection={selections[card.id]}
                                            selectionState={getSelectionState(card.id)}
                                            onFlip={() => toggleFlip(card.id)}
                                            onSelect={(side) => toggleSelection(card.id, side)}
                                        />
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Report Builder Card Component
        const ReportBuilderCard = ({ card, isFlipped, selection, selectionState, onFlip, onSelect }) => {
            console.log("CARD DATA:", card.title, card);
            const getCardClass = () => {
                switch(selectionState) {
                    case 'chart':
                    case 'table':
                        return {
                            border: '2px solid #93c5fd',
                            boxShadow: '0 0 0 3px rgba(147, 197, 253, 0.2)'
                        };
                    case 'both':
                        return {
                            border: '3px solid var(--blue)',
                            boxShadow: '0 0 0 4px rgba(20, 70, 115, 0.3)'
                        };
                    default:
                        return {
                            border: '1px solid #e5e7eb'
                        };
                }
            };
            
            const getBadgeStyle = () => {
                switch(selectionState) {
                    case 'chart':
                    case 'table':
                        return {
                            background: 'linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%)'
                        };
                    case 'both':
                        return {
                            background: 'linear-gradient(135deg, var(--blue) 0%, var(--dark-blue) 100%)'
                        };
                    default:
                        return { display: 'none' };
                }
            };
            
            const getBadgeText = () => {
                switch(selectionState) {
                    case 'chart':
                        return 'Chart Selected';
                    case 'table':
                        return 'Table Selected';
                    case 'both':
                        return 'Both Selected';
                    default:
                        return '';
                }
            };
            
            return (
                <div style={{
                    perspective: '1000px',
                    height: '380px'
                }}>
                    <div style={{
                        position: 'relative',
                        width: '100%',
                        height: '100%',
                        transition: 'transform 0.6s',
                        transformStyle: 'preserve-3d',
                        transform: isFlipped ? 'rotateY(180deg)' : 'rotateY(0deg)'
                    }}>
                        {/* Front - Chart */}
                        <div style={{
                            position: 'absolute',
                            width: '100%',
                            height: '100%',
                            backfaceVisibility: 'hidden',
                            borderRadius: '8px',
                            background: 'white',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.12)',
                            overflow: 'hidden',
                            ...getCardClass()
                        }}>
                            {selectionState !== 'unselected' && (
                                <div style={{
                                    position: 'absolute',
                                    top: '12px',
                                    left: '12px',
                                    zIndex: 10,
                                    padding: '6px 12px',
                                    borderRadius: '6px',
                                    fontSize: '11px',
                                    fontWeight: '700',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    color: 'white',
                                    boxShadow: '0 2px 6px rgba(0,0,0,0.15)',
                                    ...getBadgeStyle()
                                }}>
                                    {getBadgeText()}
                                </div>
                            )}
                            <div style={{
                                position: 'absolute',
                                top: '12px',
                                right: '12px',
                                zIndex: 10,
                                background: 'white',
                                padding: '6px 10px',
                                borderRadius: '6px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}>
                                <div 
                                    onClick={() => onSelect('chart')}
                                    style={{
                                        width: '20px',
                                        height: '20px',
                                        border: '2px solid #d1d5db',
                                        borderRadius: '4px',
                                        cursor: 'pointer',
                                        position: 'relative',
                                        transition: 'all 0.2s',
                                        background: selection?.chart ? 'var(--blue)' : 'white',
                                        borderColor: selection?.chart ? 'var(--blue)' : '#d1d5db'
                                    }}
                                >
                                    {selection?.chart && (
                                        <div style={{
                                            position: 'absolute',
                                            top: '50%',
                                            left: '50%',
                                            transform: 'translate(-50%, -50%)',
                                            color: 'white',
                                            fontWeight: 'bold',
                                            fontSize: '14px'
                                        }}></div>
                                    )}
                                </div>
                                <span style={{fontSize: '0.75rem', color: '#6b7280'}}>Chart</span>
                            </div>
                            <div style={{padding: '16px', borderBottom: '1px solid #e5e7eb'}}>
                                <div style={{fontSize: '1rem', fontWeight: '600', color: 'var(--dark-blue)'}}>
                                    {card.title}
                                </div>
                            </div>
                            <div style={{padding: '16px', height: 'calc(100% - 100px)', display: 'flex', flexDirection: 'column', justifyContent: 'center'}}>
                                {/* Render based on card type */}
                                {card.cardType === 'kpi_numbers' ? (
                                    // KPI Numbers Display
                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                                        {card.kpiData && Object.entries(card.kpiData).map(([key, data]) => (
                                            <div key={key} style={{
                                                padding: '10px',
                                                background: '#f9fafb',
                                                borderRadius: '6px',
                                                textAlign: 'center'
                                            }}>
                                                <div style={{fontSize: '0.75rem', color: '#6b7280', marginBottom: '4px'}}>
                                                    {data.label}
                                                </div>
                                                <div style={{fontSize: '1.1rem', fontWeight: '700', color: '#144673'}}>
                                                    {data.value || data.amount || data.raw}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : card.cardType === 'funnel' ? (
                                    // Funnel Chart Display
                                    <div style={{padding: '8px'}}>
                                        {card.funnelData && card.funnelData.map((item, idx) => (
                                            <div key={idx} style={{
                                                margin: '4px 0',
                                                position: 'relative'
                                            }}>
                                                <div style={{
                                                    width: `${item.percentage}%`,
                                                    height: '28px',
                                                    background: item.color || `rgba(20, 70, 115, ${1 - idx * 0.15})`,
                                                    borderRadius: '4px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    paddingLeft: '8px',
                                                    color: 'white',
                                                    fontSize: '0.75rem',
                                                    fontWeight: '600'
                                                }}>
                                                    {item.label}: {item.displayValue}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : card.chartType === 'horizontalBar' || (card.chartType === 'bar' && card.chartOptions?.indexAxis === 'y') ? (
                                    // Horizontal Bar Chart
                                    <div style={{padding: '8px'}}>
                                        {card.chartData?.datasets?.[0]?.data && card.chartData.labels.slice(0, 8).map((label, idx) => {
                                            const value = card.chartData.datasets[0].data[idx];
                                            const maxValue = Math.max(...card.chartData.datasets[0].data);
                                            const width = (value / maxValue) * 100;
                                            return (
                                                <div key={idx} style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    margin: '6px 0'
                                                }}>
                                                    <div style={{
                                                        width: '120px',
                                                        fontSize: '0.7rem',
                                                        color: '#374151',
                                                        overflow: 'hidden',
                                                        textOverflow: 'ellipsis',
                                                        whiteSpace: 'nowrap'
                                                    }}>
                                                        {label.length > 20 ? label.substring(0, 20) + '...' : label}
                                                    </div>
                                                    <div style={{
                                                        flex: 1,
                                                        position: 'relative',
                                                        height: '20px',
                                                        background: '#f3f4f6',
                                                        borderRadius: '4px',
                                                        overflow: 'hidden'
                                                    }}>
                                                        <div style={{
                                                            width: `${width}%`,
                                                            height: '100%',
                                                            background: card.chartData.datasets[0].backgroundColor?.[idx] || 
                                                                       card.chartData.datasets[0].backgroundColor || 
                                                                       '#144673',
                                                            borderRadius: '4px',
                                                            transition: 'width 0.3s ease'
                                                        }}></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : card.chartType === 'pie' || card.chartType === 'doughnut' ? (
                                    // Pie/Doughnut Chart with Visual Pie
                                    <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '16px', padding: '8px'}}>
                                        {/* Visual Pie Chart */}
                                        {card.chartData?.datasets?.[0]?.data && (
                                            <div style={{
                                                width: '100px',
                                                height: '100px',
                                                borderRadius: '50%',
                                                position: 'relative',
                                                overflow: 'hidden'
                                            }}>
                                                {(() => {
                                                    const data = card.chartData.datasets[0].data;
                                                    const total = data.reduce((sum, val) => sum + val, 0);
                                                    let currentAngle = 0;
                                                    
                                                    return data.map((value, idx) => {
                                                        const percentage = (value / total) * 100;
                                                        const angle = (value / total) * 360;
                                                        const startAngle = currentAngle;
                                                        currentAngle += angle;
                                                        
                                                        // Create pie slice using conic-gradient
                                                        const color = card.chartData.datasets[0].backgroundColor[idx] || '#144673';
                                                        
                                                        if (idx === 0) {
                                                            // First slice uses conic-gradient for all slices
                                                            const gradientStops = [];
                                                            let tempAngle = 0;
                                                            
                                                            data.forEach((val, i) => {
                                                                const sliceAngle = (val / total) * 360;
                                                                const sliceColor = card.chartData.datasets[0].backgroundColor[i] || '#144673';
                                                                gradientStops.push(`${sliceColor} ${tempAngle}deg ${tempAngle + sliceAngle}deg`);
                                                                tempAngle += sliceAngle;
                                                            });
                                                            
                                                            return (
                                                                <div
                                                                    key={idx}
                                                                    style={{
                                                                        position: 'absolute',
                                                                        top: 0,
                                                                        left: 0,
                                                                        width: '100%',
                                                                        height: '100%',
                                                                        borderRadius: '50%',
                                                                        background: `conic-gradient(from 0deg, ${gradientStops.join(', ')})`,
                                                                        border: '2px solid #ffffff'
                                                                    }}
                                                                />
                                                            );
                                                        }
                                                        return null;
                                                    });
                                                })()}
                                                
                                                {/* Center circle for doughnut effect */}
                                                {card.chartType === 'doughnut' && (
                                                    <div style={{
                                                        position: 'absolute',
                                                        top: '25%',
                                                        left: '25%',
                                                        width: '50%',
                                                        height: '50%',
                                                        borderRadius: '50%',
                                                        background: '#ffffff',
                                                        border: '2px solid #f3f4f6'
                                                    }} />
                                                )}
                                            </div>
                                        )}
                                        
                                        {/* Legend */}
                                        <div style={{textAlign: 'left', flex: 1}}>
                                            <div style={{fontSize: '0.8rem', color: '#6b7280', marginBottom: '8px', fontWeight: '600'}}>
                                                {card.title?.includes('Fiscal Year') ? 'Fiscal Years' : 'Distribution'}
                                            </div>
                                            {card.chartData?.labels?.map((label, idx) => {
                                                const data = card.chartData.datasets[0].data;
                                                const total = data.reduce((sum, val) => sum + val, 0);
                                                const value = data[idx];
                                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                                
                                                return (
                                                    <div key={idx} style={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '8px',
                                                        margin: '3px 0',
                                                        fontSize: '0.7rem'
                                                    }}>
                                                        <div style={{
                                                            width: '12px',
                                                            height: '12px',
                                                            background: card.chartData.datasets[0].backgroundColor[idx],
                                                            borderRadius: '2px',
                                                            border: '1px solid #ffffff'
                                                        }}></div>
                                                        <span style={{flex: 1}}>
                                                            {label.startsWith('FY') ? label : (label.length > 15 ? label.substring(0, 15) + '...' : label)}
                                                        </span>
                                                        <span style={{fontWeight: '600', color: '#374151'}}>
                                                            {percentage}%
                                                        </span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ) : card.chartType === 'bar' && card.chartOptions?.scales?.x?.stacked ? (
                                    // Stacked Bar Chart
                                    <div style={{padding: '8px'}}>
                                        <div style={{fontSize: '0.9rem', color: '#6b7280', marginBottom: '8px', textAlign: 'center'}}>
                                            Year over Year Comparison
                                        </div>
                                        {card.chartData?.labels && card.chartData?.datasets && (
                                            <div style={{display: 'flex', flexDirection: 'column', gap: '4px'}}>
                                                {card.chartData.labels.slice(0, 4).map((year, yearIdx) => (
                                                    <div key={year} style={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '8px'
                                                    }}>
                                                        <div style={{
                                                            width: '50px',
                                                            fontSize: '0.75rem',
                                                            color: '#374151',
                                                            fontWeight: '600'
                                                        }}>
                                                            {year}
                                                        </div>
                                                        <div style={{
                                                            flex: 1,
                                                            height: '20px',
                                                            background: '#f3f4f6',
                                                            borderRadius: '4px',
                                                            overflow: 'hidden',
                                                            position: 'relative'
                                                        }}>
                                                            {card.chartData.datasets.map((dataset, datasetIdx) => {
                                                                const value = dataset.data[yearIdx] || 0;
                                                                const maxValue = Math.max(...card.chartData.datasets.flatMap(d => d.data));
                                                                const width = (value / maxValue) * 100;
                                                                return (
                                                                    <div
                                                                        key={datasetIdx}
                                                                        style={{
                                                                            position: 'absolute',
                                                                            left: `${datasetIdx * 15}%`,
                                                                            width: `${Math.max(width * 0.8, 2)}%`,
                                                                            height: '100%',
                                                                            background: dataset.backgroundColor || '#144673',
                                                                            borderRadius: '2px'
                                                                        }}
                                                                    />
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ) : card.chartType === 'line' || card.chartType === 'area' ? (
                                    // Line/Area Chart with visual trend
                                    <div style={{padding: '8px'}}>
                                        <div style={{fontSize: '0.9rem', color: '#6b7280', marginBottom: '8px', textAlign: 'center'}}>
                                            {card.title?.includes('Historical') ? 'Historical Trend' : 'Trend Analysis'}
                                        </div>
                                        
                                        {/* Visual trend line */}
                                        {card.chartData?.datasets?.[0]?.data && (
                                            <div style={{
                                                height: '120px',
                                                position: 'relative',
                                                margin: '8px 0',
                                                border: '1px solid #e5e7eb',
                                                borderRadius: '4px',
                                                background: '#f9fafb'
                                            }}>
                                                <svg width="100%" height="100%" style={{position: 'absolute'}} viewBox="0 0 100 120">
                                                    <polyline
                                                        points={card.chartData.datasets[0].data.map((value, idx) => {
                                                            const dataLength = card.chartData.datasets[0].data.length;
                                                            const x = dataLength > 1 ? (idx / (dataLength - 1)) * 100 : 50;
                                                            const maxVal = Math.max(...card.chartData.datasets[0].data);
                                                            const minVal = Math.min(...card.chartData.datasets[0].data);
                                                            const range = maxVal - minVal;
                                                            const y = range > 0 ? 100 - ((value - minVal) / range) * 80 : 60;
                                                            return `${x},${y}`;
                                                        }).join(' ')}
                                                        fill="none"
                                                        stroke="#144673"
                                                        strokeWidth="1.5"
                                                        strokeLinecap="round"
                                                        strokeLinejoin="round"
                                                    />
                                                    {/* Data points */}
                                                    {card.chartData.datasets[0].data.map((value, idx) => {
                                                        const dataLength = card.chartData.datasets[0].data.length;
                                                        const x = dataLength > 1 ? (idx / (dataLength - 1)) * 100 : 50;
                                                        const maxVal = Math.max(...card.chartData.datasets[0].data);
                                                        const minVal = Math.min(...card.chartData.datasets[0].data);
                                                        const range = maxVal - minVal;
                                                        const y = range > 0 ? 100 - ((value - minVal) / range) * 80 : 60;
                                                        return (
                                                            <circle
                                                                key={idx}
                                                                cx={x}
                                                                cy={y}
                                                                r="2"
                                                                fill="#144673"
                                                            />
                                                        );
                                                    })}
                                                </svg>
                                            </div>
                                        )}
                                        
                                        {/* Summary stats */}
                                        {card.summary && (
                                            <div style={{
                                                display: 'grid',
                                                gridTemplateColumns: '1fr 1fr',
                                                gap: '8px',
                                                fontSize: '0.7rem'
                                            }}>
                                                <div style={{
                                                    padding: '6px',
                                                    background: '#f0f9ff',
                                                    borderRadius: '4px',
                                                    textAlign: 'center'
                                                }}>
                                                    <div style={{color: '#0369a1', fontWeight: '600'}}>
                                                        {card.summary.totalGrowth || 'N/A'}
                                                    </div>
                                                    <div style={{color: '#64748b'}}>Total Growth</div>
                                                </div>
                                                <div style={{
                                                    padding: '6px',
                                                    background: '#fef3c7',
                                                    borderRadius: '4px',
                                                    textAlign: 'center'
                                                }}>
                                                    <div style={{color: '#d97706', fontWeight: '600'}}>
                                                        {card.summary.avgAnnualGrowth || 'N/A'}
                                                    </div>
                                                    <div style={{color: '#64748b'}}>Avg Annual</div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {card.chartData?.labels && (
                                            <div style={{fontSize: '0.7rem', color: '#6b7280', marginTop: '8px', textAlign: 'center'}}>
                                                {card.chartData.labels[0]} - {card.chartData.labels[card.chartData.labels.length - 1]}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    // Default chart placeholder
                                    <div style={{textAlign: 'center', color: '#666', fontSize: '1.1rem'}}>
                                         {card.chartType || 'Chart'} View
                                    </div>
                                )}
                            </div>
                            <div 
                                onClick={onFlip}
                                style={{
                                    position: 'absolute',
                                    bottom: '0',
                                    left: '0',
                                    right: '0',
                                    padding: '12px',
                                    background: '#f8f9fa',
                                    borderTop: '1px solid #e5e7eb',
                                    cursor: 'pointer',
                                    textAlign: 'center',
                                    transition: 'all 0.2s',
                                    fontSize: '0.75rem',
                                    color: '#6b7280',
                                    fontWeight: '600'
                                }}
                            >
                                 Click to see table view
                            </div>
                        </div>
                        
                        {/* Back - Table */}
                        <div style={{
                            position: 'absolute',
                            width: '100%',
                            height: '100%',
                            backfaceVisibility: 'hidden',
                            borderRadius: '8px',
                            background: 'white',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.12)',
                            overflow: 'hidden',
                            transform: 'rotateY(180deg)',
                            ...getCardClass()
                        }}>
                            {selectionState !== 'unselected' && (
                                <div style={{
                                    position: 'absolute',
                                    top: '12px',
                                    left: '12px',
                                    zIndex: 10,
                                    padding: '6px 12px',
                                    borderRadius: '6px',
                                    fontSize: '11px',
                                    fontWeight: '700',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    color: 'white',
                                    boxShadow: '0 2px 6px rgba(0,0,0,0.15)',
                                    ...getBadgeStyle()
                                }}>
                                    {getBadgeText()}
                                </div>
                            )}
                            <div style={{
                                position: 'absolute',
                                top: '12px',
                                right: '12px',
                                zIndex: 10,
                                background: 'white',
                                padding: '6px 10px',
                                borderRadius: '6px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}>
                                <div 
                                    onClick={() => onSelect('table')}
                                    style={{
                                        width: '20px',
                                        height: '20px',
                                        border: '2px solid #d1d5db',
                                        borderRadius: '4px',
                                        cursor: 'pointer',
                                        position: 'relative',
                                        transition: 'all 0.2s',
                                        background: selection?.table ? 'var(--blue)' : 'white',
                                        borderColor: selection?.table ? 'var(--blue)' : '#d1d5db'
                                    }}
                                >
                                    {selection?.table && (
                                        <div style={{
                                            position: 'absolute',
                                            top: '50%',
                                            left: '50%',
                                            transform: 'translate(-50%, -50%)',
                                            color: 'white',
                                            fontWeight: 'bold',
                                            fontSize: '14px'
                                        }}></div>
                                    )}
                                </div>
                                <span style={{fontSize: '0.75rem', color: '#6b7280'}}>Table</span>
                            </div>
                            <div style={{padding: '16px', borderBottom: '1px solid #e5e7eb'}}>
                                <div style={{fontSize: '1rem', fontWeight: '600', color: 'var(--dark-blue)'}}>
                                    {card.title}
                                </div>
                            </div>
                            <div style={{padding: '16px', height: 'calc(100% - 100px)', display: 'flex', flexDirection: 'column', justifyContent: 'center'}}>
                                <div style={{height: '100%', overflowY: 'auto'}}>
                                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '0.85rem'}}>
                                        <thead>
                                            <tr>
                                                {card.tableData?.headers.map((header, idx) => (
                                                    <th key={idx} style={{
                                                        background: '#f8f9fa',
                                                        padding: '8px',
                                                        textAlign: 'left',
                                                        fontWeight: '600',
                                                        borderBottom: '2px solid #e5e7eb',
                                                        color: 'var(--dark-blue)',
                                                        position: 'sticky',
                                                        top: 0
                                                    }}>{header}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {card.tableData?.rows.map((row, idx) => (
                                                <tr key={idx}>
                                                    {row.map((cell, cellIdx) => (
                                                        <td key={cellIdx} style={{
                                                            padding: '8px',
                                                            borderBottom: '1px solid #e5e7eb'
                                                        }}>{cell}</td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div 
                                onClick={onFlip}
                                style={{
                                    position: 'absolute',
                                    bottom: '0',
                                    left: '0',
                                    right: '0',
                                    padding: '12px',
                                    background: '#f8f9fa',
                                    borderTop: '1px solid #e5e7eb',
                                    cursor: 'pointer',
                                    textAlign: 'center',
                                    transition: 'all 0.2s',
                                    fontSize: '0.75rem',
                                    color: '#6b7280',
                                    fontWeight: '600'
                                }}
                            >
                                 Click to see chart view
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Reports View Component
        const ReportsView = () => {
            return (
                <div style={{ padding: '20px', textAlign: 'center' }}>
                    <h1 style={{ color: 'var(--blue)', marginBottom: '20px' }}>Reports</h1>
                    <p style={{ fontSize: '1.1rem', color: '#666', marginBottom: '30px' }}>
                        Comprehensive tabular view of all FIT Market data with sorting and filtering.
                    </p>
                    <div style={{ 
                        background: 'white', 
                        padding: '40px', 
                        borderRadius: '8px', 
                        boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                        maxWidth: '600px',
                        margin: '0 auto'
                    }}>
                        <h3 style={{ color: 'var(--blue)', marginBottom: '20px' }}>Coming Soon</h3>
                        <p style={{ lineHeight: '1.6', color: '#666' }}>
                            The Reports section will provide:
                        </p>
                        <ul style={{ textAlign: 'left', marginTop: '20px', color: '#666' }}>
                            <li>Sortable columns for all data fields</li>
                            <li>Advanced search and filtering</li>
                            <li>Pagination for large datasets</li>
                            <li>Export to CSV and Google Sheets</li>
                        </ul>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [entities, setEntities] = useState([]);
            const [entityType, setEntityType] = useState('OEMs');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedTier, setSelectedTier] = useState('All Tiers');
            const [columnBFilter, setColumnBFilter] = useState('All');
            const [columnCFilter, setColumnCFilter] = useState('All');
            const [oneGovFilter, setOneGovFilter] = useState('All');

            const loadEntities = useCallback(async (type) => {
                setLoading(true);
                setError(null);
                setEntityType(type);
                
                // Reset filters when switching entity types
                setSelectedTier('All Tiers');
                setColumnBFilter('All');
                setColumnCFilter('All');
                setOneGovFilter('All');
                
                const functionMap = {
                    'OEMs': 'getOEMs',
                    'Vendors': 'getVendors',
                    'Agencies': 'getAgencies'
                };

                try {
                    const data = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            [functionMap[type]]();
                    });

                    if (data?.error) {
                        setError(data.error);
                    } else {
                        const entityData = data || [];
                        setEntities(entityData);
                        currentEntities = entityData; // Store for detail view
                    }
                } catch (err) {
                    setError(err.toString());
                } finally {
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                loadEntities('OEMs');
            }, [loadEntities]);

            // Filter entities by tier, sheet type, and parent company/department
            const filteredEntities = useMemo(() => {
                let filtered = entities;
                
                // Filter by tier
                if (selectedTier !== 'All Tiers') {
                    if (selectedTier === 'Below Tier 4') {
                        filtered = filtered.filter(entity => {
                            const tier = entity.tier;
                            return tier && (tier.includes('5') || tier.includes('6') || tier.includes('7') || tier.includes('8') || tier.includes('9') || tier.includes('10') || tier.includes('Unranked') || tier.includes('No Tier') || (!tier.includes('1') && !tier.includes('2') && !tier.includes('3') && !tier.includes('4') && tier !== 'N/A'));
                        });
                    } else {
                        filtered = filtered.filter(entity => entity.tier === selectedTier);
                    }
                }
                
                // Filter by Column B (entity name)
                if (columnBFilter !== 'All') {
                    filtered = filtered.filter(entity => entity.name === columnBFilter);
                }
                
                // Filter by Column C (parent company for OEM/Vendor, department for Agency)
                if (columnCFilter !== 'All') {
                    filtered = filtered.filter(entity => {
                        // For agencies, use department; for OEMs/Vendors, use parentCompany
                        const filterField = entityType === 'Agencies' ? entity.department : entity.parentCompany;
                        return filterField === columnCFilter;
                    });
                }
                
                // Filter by OneGov status
                if (oneGovFilter !== 'All') {
                    
                    if (oneGovFilter === 'OneGov') {
                        filtered = filtered.filter(entity => {
                            const hasOneGov = entity.isOneGov === true;
                            if (hasOneGov) {
                            }
                            return hasOneGov;
                        });
                    } else if (oneGovFilter === 'Non-OneGov') {
                        filtered = filtered.filter(entity => entity.isOneGov !== true);
                    }
                }
                
                return filtered;
            }, [entities, selectedTier, columnBFilter, columnCFilter, oneGovFilter, entityType]);

            // Combined Horizontal Filter Component
            const CombinedFilters = () => {
                // Get unique Column B values (entity names)
                const getColumnBValues = () => {
                    const values = new Set();
                    entities.forEach(entity => {
                        if (entity.name && entity.name.trim() !== '') {
                            values.add(entity.name);
                        }
                    });
                    return Array.from(values).sort();
                };

                // Get unique Column C values (parent company/department)
                const getColumnCValues = () => {
                    const values = new Set();
                    entities.forEach(entity => {
                        const value = entityType === 'Agencies' ? entity.department : entity.parentCompany;
                        if (value && value !== 'N/A' && value.trim() !== '') {
                            values.add(value);
                        }
                    });
                    return Array.from(values).sort();
                };

                const tiers = ['All Tiers', 'Tier 1', 'Tier 2', 'Tier 3', 'Tier 4', 'Below Tier 4'];
                const columnBValues = getColumnBValues();
                const columnCValues = getColumnCValues();
                const columnCLabel = entityType === 'Agencies' ? 'Department' : 'Parent Company';
                
                return (
                    <div style={{
                        display: 'flex', 
                        justifyContent: 'center', 
                        alignItems: 'center',
                        gap: '12px', 
                        margin: '20px 0',
                        padding: '0 24px',
                        flexWrap: 'wrap'
                    }}>
                        {/* Tier Filters */}
                        {tiers.map(tier => (
                            <button 
                                key={tier}
                                onClick={() => setSelectedTier(tier)}
                                style={{
                                    background: selectedTier === tier ? 'var(--orange)' : 'rgba(255,255,255,0.9)',
                                    color: selectedTier === tier ? 'white' : 'var(--blue)',
                                    border: selectedTier === tier ? '1px solid var(--orange)' : '1px solid rgba(20, 70, 115, 0.2)',
                                    borderRadius: '8px',
                                    padding: '8px 16px',
                                    fontSize: '0.85rem',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease',
                                    boxShadow: selectedTier === tier ? '0 4px 12px rgba(244, 121, 32, 0.3)' : '0 2px 4px rgba(0,0,0,0.1)',
                                    minWidth: tier === 'Below Tier 4' ? '100px' : '75px'
                                }}
                            >
                                {tier}
                            </button>
                        ))}

                        <div style={{ width: '1px', height: '30px', background: 'rgba(20, 70, 115, 0.2)', margin: '0 8px' }}></div>

                        {/* Column B Filter */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                            <span style={{ fontSize: '0.75rem', color: 'var(--blue)', fontWeight: '600' }}>
                                Name:
                            </span>
                            <select 
                                value={columnBFilter}
                                onChange={(e) => setColumnBFilter(e.target.value)}
                                style={{
                                    background: 'rgba(255,255,255,0.9)',
                                    color: 'var(--blue)',
                                    border: '1px solid rgba(20, 70, 115, 0.2)',
                                    borderRadius: '4px',
                                    padding: '4px 6px',
                                    fontSize: '0.75rem',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    minWidth: '120px',
                                    maxWidth: '140px'
                                }}
                            >
                                <option value="All">All</option>
                                {columnBValues.map(value => (
                                    <option key={value} value={value}>{value.length > 25 ? value.substring(0, 25) + '...' : value}</option>
                                ))}
                            </select>
                        </div>

                        {/* Column C Filter */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                            <span style={{ fontSize: '0.75rem', color: 'var(--blue)', fontWeight: '600' }}>
                                {columnCLabel}:
                            </span>
                            <select 
                                value={columnCFilter}
                                onChange={(e) => setColumnCFilter(e.target.value)}
                                style={{
                                    background: 'rgba(255,255,255,0.9)',
                                    color: 'var(--blue)',
                                    border: '1px solid rgba(20, 70, 115, 0.2)',
                                    borderRadius: '4px',
                                    padding: '4px 6px',
                                    fontSize: '0.75rem',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    minWidth: '120px',
                                    maxWidth: '140px'
                                }}
                            >
                                <option value="All">All</option>
                                {columnCValues.map(value => (
                                    <option key={value} value={value}>{value.length > 25 ? value.substring(0, 25) + '...' : value}</option>
                                ))}
                            </select>
                        </div>
                        
                        <div style={{ width: '1px', height: '30px', background: 'rgba(20, 70, 115, 0.2)', margin: '0 8px' }}></div>
                        
                        {/* OneGov Filter with inline legend */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                            <span style={{ fontSize: '0.75rem', color: 'var(--blue)', fontWeight: '600' }}>
                                OneGov:
                            </span>
                            <select 
                                value={oneGovFilter}
                                onChange={(e) => setOneGovFilter(e.target.value)}
                                style={{
                                    background: 'rgba(255,255,255,0.9)',
                                    color: 'var(--blue)',
                                    border: '1px solid rgba(20, 70, 115, 0.2)',
                                    borderRadius: '4px',
                                    padding: '4px 6px',
                                    fontSize: '0.75rem',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    minWidth: '100px'
                                }}
                            >
                                <option value="All">All</option>
                                <option value="OneGov">OneGov Only</option>
                                <option value="Non-OneGov">Non-OneGov</option>
                            </select>
                            <div style={{
                                width: '12px',
                                height: '12px',
                                border: '1.5px solid orange',
                                borderRadius: '2px',
                                boxShadow: '0 0 4px orange',
                                marginLeft: '6px'
                            }}></div>
                        </div>
                    </div>
                );
            };

            return (
                <div>
                    {/* Navigation - exact match */}
                    <nav className="navbar">
                        <div className="nav-container">
                            <div className="nav-brand">
                                <div className="logo">F</div>
                                <div className="brand-text">
                                    <span className="brand-name">OneGov FIT Market</span>
                                    <span className="brand-tagline">Built by ITVMO</span>
                                </div>
                            </div>
                            
                            <div className="nav-items">
                                {['OEMs', 'Vendors', 'Agencies', 'ReportBuilder', 'Reports'].map(type => (
                                    <button 
                                        key={type}
                                        className={`nav-item ${entityType === type ? 'active' : ''}`} 
                                        onClick={() => {
                                            if (type === 'ReportBuilder' || type === 'Reports') {
                                                setEntityType(type);
                                                setEntities([]);
                                                setLoading(false);
                                            } else {
                                                loadEntities(type);
                                            }
                                        }}
                                        disabled={loading && type !== 'ReportBuilder' && type !== 'Reports'}
                                    >
                                        {type === 'OEMs' ? 'OEM' : 
                                         type === 'Vendors' ? 'Vendor' : 
                                         type === 'Agencies' ? 'Agency' :
                                         type === 'ReportBuilder' ? 'Report Builder' :
                                         'Reports'}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    {/* Main Content - exact match */}
                    <main className="main-content">
                        {entityType === 'ReportBuilder' && <ReportBuilderView />}
                        {entityType === 'Reports' && <ReportsView />}
                        
                        {entityType !== 'ReportBuilder' && entityType !== 'Reports' && (
                            <>
                                {loading && <div className="loading">Loading {entityType}...</div>}
                                {error && <div className="error">Error: {error}</div>}
                                
                                {!loading && !error && entities.length > 0 && (
                                    <>
                                        <KPICarousel entities={filteredEntities} entityType={entityType} />
                                        <CombinedFilters />
                                        {filteredEntities.length !== entities.length && (
                                            <div style={{
                                                textAlign: 'center',
                                                margin: '10px 0 20px 0',
                                                color: 'var(--blue)',
                                                fontSize: '0.9rem',
                                                fontWeight: '500'
                                            }}>
                                                Showing {filteredEntities.length} of {entities.length} {entityType} 
                                                {selectedTier !== 'All Tiers' && ` (${selectedTier})`}
                                            </div>
                                        )}
                                        <EntityGrid entities={filteredEntities} entityType={entityType} />
                                    </>
                                )}

                                {!loading && !error && entities.length === 0 && (
                                    <div className="loading">No {entityType} found</div>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        };

        // Render with React 18 syntax
        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>
