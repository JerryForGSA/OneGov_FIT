<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OneGov FIT Market - Report Table</title>
    
    <!-- React 18 CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --dark-blue: #0a2240;
            --blue: #144673;
            --light-blue: #3a6ea5;
            --orange: #f47920;
            --bg-light: #f4f6f7;
            --text-light: #ffffff;
            --text-dark: #333333;
            --shadow: 0 2px 8px rgba(0,0,0,0.12);
            --border-radius: 8px;
            --green: #22c55e;
            --red: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-dark);
            min-height: 100vh;
            font-size: 14px;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blue) 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--orange) 0%, #ff6b35 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(244, 121, 32, 0.3);
            color: white;
        }
        
        .header-title h1 {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }
        
        .header-subtitle {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        /* Control Panel */
        .control-panel {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .control-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .control-left, .control-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .control-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        select, button, input {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        input {
            cursor: text;
        }
        
        select:focus, button:focus, input:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(244, 121, 32, 0.1);
        }
        
        .btn-export {
            background: linear-gradient(135deg, var(--orange), #ff6b35);
            color: white;
            border: none;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(244, 121, 32, 0.3);
        }
        
        .btn-export:hover {
            box-shadow: 0 4px 12px rgba(244, 121, 32, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* Table Styles */
        .report-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            overflow: hidden;
        }
        
        .table-header {
            padding: 16px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-blue);
        }
        
        .table-stats {
            font-size: 0.85rem;
            color: #6b7280;
        }
        
        .table-wrapper {
            max-height: 70vh;
            overflow: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            color: var(--dark-blue);
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }
        
        .data-table th:hover {
            background: #e5e7eb;
        }
        
        .data-table th.sortable::after {
            content: ' â†•';
            color: #9ca3af;
            margin-left: 4px;
        }
        
        .data-table th.sort-asc::after {
            content: ' â†‘';
            color: var(--blue);
        }
        
        .data-table th.sort-desc::after {
            content: ' â†“';
            color: var(--blue);
        }
        
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tr:nth-child(even) {
            background: rgba(248, 249, 250, 0.5);
        }
        
        .data-table tr:nth-child(even):hover {
            background: #f8f9fa;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--blue);
            font-size: 1.1rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(20, 70, 115, 0.3);
            border-radius: 50%;
            border-top-color: var(--blue);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background: #f8f9fa;
            border-top: 1px solid #e5e7eb;
        }
        
        .pagination button {
            min-width: 36px;
            height: 36px;
            padding: 0;
            border: 1px solid #d1d5db;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f3f4f6;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .current-page {
            background: var(--blue);
            color: white;
            border-color: var(--blue);
        }
        
        .pagination-info {
            margin: 0 16px;
            font-size: 0.85rem;
            color: #6b7280;
        }
        
        /* Filters */
        .filters-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--blue);
            white-space: nowrap;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .control-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-left, .control-right {
                justify-content: center;
            }
            
            .filters-row {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // Report Table Component
        function ReportTable() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(100);
            const [sortField, setSortField] = useState('');
            const [sortDirection, setSortDirection] = useState('asc');
            const [filterText, setFilterText] = useState('');
            const [categoryFilter, setCategoryFilter] = useState('all');
            const [exportFormat, setExportFormat] = useState('sheets');
            
            useEffect(() => {
                loadReportData();
            }, []);
            
            const loadReportData = async () => {
                try {
                    setLoading(true);
                    setError('');
                    
                    google.script.run
                        .withSuccessHandler((result) => {
                            console.log('Loaded report table data:', result);
                            setData(result || generateDefaultData());
                            setLoading(false);
                        })
                        .withFailureHandler((err) => {
                            console.error('Error loading report data:', err);
                            setError(err.toString());
                            setData(generateDefaultData());
                            setLoading(false);
                        })
                        .getReportTableData();
                } catch (err) {
                    console.error('Error in loadReportData:', err);
                    setError(err.toString());
                    setData(generateDefaultData());
                    setLoading(false);
                }
            };
            
            // Generate default data for fallback
            const generateDefaultData = () => {
                return [
                    { id: 1, name: 'Four Points Technology', category: 'Vendor', type: 'Reseller', total: 612000000, fy24: 240000000, fy25: 372000000, tier: 'BIC', small_business: 'Yes' },
                    { id: 2, name: 'Amazon Web Services', category: 'Vendor', type: 'Reseller', total: 390000000, fy24: 200000000, fy25: 190000000, tier: 'BIC', small_business: 'No' },
                    { id: 3, name: 'Microsoft Corporation', category: 'OEM', type: 'Manufacturer', total: 285000000, fy24: 140000000, fy25: 145000000, tier: 'BIC', small_business: 'No' },
                    { id: 4, name: 'U.S. Customs and Border Protection', category: 'Agency', type: 'Federal Agency', total: 158000000, fy24: 74000000, fy25: 84000000, tier: 'N/A', small_business: 'N/A' },
                    { id: 5, name: 'Dept of the Navy', category: 'Agency', type: 'Federal Agency', total: 139000000, fy24: 76000000, fy25: 63000000, tier: 'N/A', small_business: 'N/A' },
                    { id: 6, name: 'ServiceNow Inc', category: 'OEM', type: 'Software', total: 125000000, fy24: 60000000, fy25: 65000000, tier: 'BIC', small_business: 'No' },
                    { id: 7, name: 'Strategic Communications', category: 'Vendor', type: 'Reseller', total: 121000000, fy24: 55000000, fy25: 66000000, tier: 'Tier 2', small_business: 'Yes' },
                    { id: 8, name: 'Veterans Affairs', category: 'Agency', type: 'Federal Agency', total: 120000000, fy24: 22000000, fy25: 98000000, tier: 'N/A', small_business: 'N/A' },
                    { id: 9, name: 'Defense Health Agency', category: 'Agency', type: 'Federal Agency', total: 117000000, fy24: 45000000, fy25: 72000000, tier: 'N/A', small_business: 'N/A' },
                    { id: 10, name: 'Salesforce Inc', category: 'OEM', type: 'Software', total: 95000000, fy24: 40000000, fy25: 55000000, tier: 'BIC', small_business: 'No' }
                ];
            };
            
            // Filter and sort data
            const filteredAndSortedData = useMemo(() => {
                let filtered = data;
                
                // Apply text filter
                if (filterText) {
                    filtered = filtered.filter(item =>
                        item.name.toLowerCase().includes(filterText.toLowerCase()) ||
                        item.category.toLowerCase().includes(filterText.toLowerCase()) ||
                        item.type.toLowerCase().includes(filterText.toLowerCase())
                    );
                }
                
                // Apply category filter
                if (categoryFilter !== 'all') {
                    filtered = filtered.filter(item => 
                        item.category.toLowerCase() === categoryFilter.toLowerCase()
                    );
                }
                
                // Apply sorting
                if (sortField) {
                    filtered.sort((a, b) => {
                        let aVal = a[sortField];
                        let bVal = b[sortField];
                        
                        // Handle numeric values
                        if (typeof aVal === 'number' && typeof bVal === 'number') {
                            return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                        }
                        
                        // Handle string values
                        aVal = aVal?.toString().toLowerCase() || '';
                        bVal = bVal?.toString().toLowerCase() || '';
                        
                        if (sortDirection === 'asc') {
                            return aVal.localeCompare(bVal);
                        } else {
                            return bVal.localeCompare(aVal);
                        }
                    });
                }
                
                return filtered;
            }, [data, filterText, categoryFilter, sortField, sortDirection]);
            
            // Pagination
            const totalPages = Math.ceil(filteredAndSortedData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedData = filteredAndSortedData.slice(startIndex, startIndex + itemsPerPage);
            
            // Handle sorting
            const handleSort = (field) => {
                if (sortField === field) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortField(field);
                    setSortDirection('asc');
                }
            };
            
            // Get sort class
            const getSortClass = (field) => {
                if (sortField === field) {
                    return sortDirection === 'asc' ? 'sort-asc' : 'sort-desc';
                }
                return 'sortable';
            };
            
            // Format currency
            const formatCurrency = (value) => {
                if (!value) return '$0';
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            };
            
            // Handle export
            const handleExport = async () => {
                try {
                    const exportData = filteredAndSortedData.map(item => ({
                        Name: item.name,
                        Category: item.category,
                        Type: item.type,
                        'Total Obligations': formatCurrency(item.total),
                        'FY24 Obligations': formatCurrency(item.fy24),
                        'FY25 Obligations': formatCurrency(item.fy25),
                        'Tier': item.tier,
                        'Small Business': item.small_business
                    }));
                    
                    google.script.run
                        .withSuccessHandler((result) => {
                            alert(`Report exported successfully to ${exportFormat}!`);
                        })
                        .withFailureHandler((error) => {
                            alert('Export failed: ' + error.toString());
                        })
                        .exportReportTable(exportData, exportFormat);
                } catch (error) {
                    alert('Export error: ' + error.toString());
                }
            };
            
            return (
                <div>
                    {/* Header */}
                    <div className="header">
                        <div className="header-content">
                            <div className="header-left">
                                <div className="logo">1G</div>
                                <div>
                                    <h1 className="header-title">OneGov FIT Market</h1>
                                    <div className="header-subtitle">Report Table</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Control Panel */}
                    <div className="control-panel">
                        <div className="control-content">
                            <div className="control-left">
                                <div className="control-title">ðŸ“‹ Report Table</div>
                                <div className="filters-row">
                                    <div className="filter-group">
                                        <span className="filter-label">Search:</span>
                                        <input
                                            type="text"
                                            placeholder="Filter by name, category, type..."
                                            value={filterText}
                                            onChange={(e) => setFilterText(e.target.value)}
                                            style={{minWidth: '250px'}}
                                        />
                                    </div>
                                    <div className="filter-group">
                                        <span className="filter-label">Category:</span>
                                        <select
                                            value={categoryFilter}
                                            onChange={(e) => setCategoryFilter(e.target.value)}
                                        >
                                            <option value="all">All Categories</option>
                                            <option value="vendor">Vendors</option>
                                            <option value="oem">OEMs</option>
                                            <option value="agency">Agencies</option>
                                        </select>
                                    </div>
                                    <div className="filter-group">
                                        <span className="filter-label">Per Page:</span>
                                        <select
                                            value={itemsPerPage}
                                            onChange={(e) => {
                                                setItemsPerPage(Number(e.target.value));
                                                setCurrentPage(1);
                                            }}
                                        >
                                            <option value={50}>50</option>
                                            <option value={100}>100</option>
                                            <option value={200}>200</option>
                                            <option value={500}>500</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div className="control-right">
                                <select
                                    value={exportFormat}
                                    onChange={(e) => setExportFormat(e.target.value)}
                                >
                                    <option value="sheets">ðŸ“Š Google Sheets</option>
                                    <option value="csv">ðŸ“„ CSV Download</option>
                                </select>
                                <button 
                                    className="btn-export"
                                    onClick={handleExport}
                                    disabled={filteredAndSortedData.length === 0}
                                >
                                    Export ({filteredAndSortedData.length} rows)
                                </button>
                                <button 
                                    className="btn-secondary"
                                    onClick={loadReportData}
                                    disabled={loading}
                                >
                                    ðŸ”„ Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {/* Main Content */}
                    <div className="container">
                        {loading ? (
                            <div className="loading">
                                <div className="loading-spinner"></div>
                                <div>Loading report data...</div>
                            </div>
                        ) : error ? (
                            <div className="report-table-container">
                                <div className="table-header">
                                    <div className="table-title">Error Loading Data</div>
                                </div>
                                <div style={{padding: '20px', textAlign: 'center', color: 'red'}}>
                                    {error}
                                </div>
                            </div>
                        ) : (
                            <div className="report-table-container">
                                <div className="table-header">
                                    <div className="table-title">FIT Market Data Report</div>
                                    <div className="table-stats">
                                        Showing {startIndex + 1}-{Math.min(startIndex + itemsPerPage, filteredAndSortedData.length)} of {filteredAndSortedData.length} rows
                                        {filteredAndSortedData.length !== data.length && ` (filtered from ${data.length} total)`}
                                    </div>
                                </div>
                                
                                <div className="table-wrapper">
                                    <table className="data-table">
                                        <thead>
                                            <tr>
                                                <th 
                                                    className={getSortClass('name')}
                                                    onClick={() => handleSort('name')}
                                                >
                                                    Name
                                                </th>
                                                <th 
                                                    className={getSortClass('category')}
                                                    onClick={() => handleSort('category')}
                                                >
                                                    Category
                                                </th>
                                                <th 
                                                    className={getSortClass('type')}
                                                    onClick={() => handleSort('type')}
                                                >
                                                    Type
                                                </th>
                                                <th 
                                                    className={getSortClass('total')}
                                                    onClick={() => handleSort('total')}
                                                >
                                                    Total Obligations
                                                </th>
                                                <th 
                                                    className={getSortClass('fy24')}
                                                    onClick={() => handleSort('fy24')}
                                                >
                                                    FY24
                                                </th>
                                                <th 
                                                    className={getSortClass('fy25')}
                                                    onClick={() => handleSort('fy25')}
                                                >
                                                    FY25
                                                </th>
                                                <th 
                                                    className={getSortClass('tier')}
                                                    onClick={() => handleSort('tier')}
                                                >
                                                    Tier
                                                </th>
                                                <th 
                                                    className={getSortClass('small_business')}
                                                    onClick={() => handleSort('small_business')}
                                                >
                                                    Small Business
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {paginatedData.map((item) => (
                                                <tr key={item.id}>
                                                    <td style={{fontWeight: 600}}>{item.name}</td>
                                                    <td>
                                                        <span style={{
                                                            background: item.category === 'Vendor' ? '#eff6ff' : 
                                                                       item.category === 'OEM' ? '#f0fdf4' : '#fef3f2',
                                                            color: item.category === 'Vendor' ? '#1e40af' : 
                                                                   item.category === 'OEM' ? '#166534' : '#dc2626',
                                                            padding: '2px 8px',
                                                            borderRadius: '4px',
                                                            fontSize: '0.8rem',
                                                            fontWeight: 600
                                                        }}>
                                                            {item.category}
                                                        </span>
                                                    </td>
                                                    <td>{item.type}</td>
                                                    <td style={{fontWeight: 600, color: 'var(--blue)'}}>
                                                        {formatCurrency(item.total)}
                                                    </td>
                                                    <td>{formatCurrency(item.fy24)}</td>
                                                    <td>{formatCurrency(item.fy25)}</td>
                                                    <td>
                                                        <span style={{
                                                            background: item.tier === 'BIC' ? '#144673' : 
                                                                       item.tier === 'Tier 2' ? '#3a6ea5' : '#f3f4f6',
                                                            color: item.tier === 'BIC' || item.tier === 'Tier 2' ? 'white' : '#374151',
                                                            padding: '2px 6px',
                                                            borderRadius: '3px',
                                                            fontSize: '0.75rem',
                                                            fontWeight: 600
                                                        }}>
                                                            {item.tier}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        {item.small_business === 'Yes' ? (
                                                            <span style={{color: 'var(--green)', fontWeight: 600}}>âœ“ Yes</span>
                                                        ) : item.small_business === 'No' ? (
                                                            <span style={{color: '#6b7280'}}>âœ— No</span>
                                                        ) : (
                                                            <span style={{color: '#9ca3af'}}>N/A</span>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                
                                {/* Pagination */}
                                {totalPages > 1 && (
                                    <div className="pagination">
                                        <button 
                                            onClick={() => setCurrentPage(1)}
                                            disabled={currentPage === 1}
                                        >
                                            âŸª
                                        </button>
                                        <button 
                                            onClick={() => setCurrentPage(currentPage - 1)}
                                            disabled={currentPage === 1}
                                        >
                                            âŸ¨
                                        </button>
                                        
                                        {[...Array(Math.min(5, totalPages))].map((_, i) => {
                                            let pageNum;
                                            if (totalPages <= 5) {
                                                pageNum = i + 1;
                                            } else if (currentPage <= 3) {
                                                pageNum = i + 1;
                                            } else if (currentPage >= totalPages - 2) {
                                                pageNum = totalPages - 4 + i;
                                            } else {
                                                pageNum = currentPage - 2 + i;
                                            }
                                            
                                            return (
                                                <button
                                                    key={pageNum}
                                                    className={pageNum === currentPage ? 'current-page' : ''}
                                                    onClick={() => setCurrentPage(pageNum)}
                                                >
                                                    {pageNum}
                                                </button>
                                            );
                                        })}
                                        
                                        <button 
                                            onClick={() => setCurrentPage(currentPage + 1)}
                                            disabled={currentPage === totalPages}
                                        >
                                            âŸ©
                                        </button>
                                        <button 
                                            onClick={() => setCurrentPage(totalPages)}
                                            disabled={currentPage === totalPages}
                                        >
                                            âŸ«
                                        </button>
                                        
                                        <div className="pagination-info">
                                            Page {currentPage} of {totalPages}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        // Render the app
        ReactDOM.render(<ReportTable />, document.getElementById('root'));
    </script>
</body>
</html>