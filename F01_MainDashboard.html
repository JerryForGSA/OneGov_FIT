<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OneGov FIT Market - Main Dashboard</title>
    
    <!-- React 18 CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --dark-blue: #0a2240;
            --blue: #144673;
            --light-blue: #3a6ea5;
            --orange: #f47920;
            --bg-light: #f4f6f7;
            --text-light: #ffffff;
            --text-dark: #333333;
            --shadow: 0 2px 8px rgba(0,0,0,0.12);
            --border-radius: 8px;
            --green: #22c55e;
            --red: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-dark);
            min-height: 100vh;
            font-size: 16px;
        }
        
        /* Navigation Styles */
        .navbar {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--blue) 100%);
            color: var(--text-light);
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav-menu {
            display: flex;
            gap: 2rem;
            list-style: none;
        }
        
        .nav-menu a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
        }
        
        .nav-menu a:hover, .nav-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--orange);
        }
        
        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .page-header {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .page-title {
            font-size: 2.5rem;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .page-subtitle {
            color: var(--blue);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        
        /* Control Panel */
        .control-panel {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .control-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-label {
            font-weight: 600;
            color: var(--dark-blue);
            font-size: 0.9rem;
        }
        
        .control-input {
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--orange);
            color: white;
        }
        
        .btn-primary:hover {
            background: #e06d1c;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--blue);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--dark-blue);
        }
        
        /* Entity Grid */
        .entities-container {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .entities-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--bg-light);
        }
        
        .entities-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-blue);
        }
        
        .entities-count {
            color: var(--blue);
            font-weight: 600;
        }
        
        .entities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        /* Entity Card */
        .entity-card {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .entity-card:hover {
            border-color: var(--orange);
            box-shadow: var(--shadow);
            transform: translateY(-4px);
        }
        
        .entity-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
        }
        
        .entity-type {
            background: var(--blue);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
        }
        
        .entity-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--orange);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--blue);
            text-transform: uppercase;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--blue);
        }
        
        .error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .entities-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .entities-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-menu {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                üèõÔ∏è OneGov FIT Market
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active">üè† Dashboard</a></li>
                <li><a href="#" onclick="openReportBuilder()">üìä Report Builder</a></li>
                <li><a href="#">üìã Analytics</a></li>
                <li><a href="#">‚öôÔ∏è Settings</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">OneGov FIT Market Dashboard</h1>
            <p class="page-subtitle">Government Technology Marketplace Analytics & Intelligence Platform</p>
        </div>

        <div id="dashboardApp"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Global entities storage
        let currentEntities = [];
        
        // Main Dashboard Component
        const DashboardApp = () => {
            const [entities, setEntities] = useState([]);
            const [filteredEntities, setFilteredEntities] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [filters, setFilters] = useState({
                type: '',
                search: '',
                minObligation: '',
                maxObligation: ''
            });

            // Load initial data
            useEffect(() => {
                loadEntities();
            }, []);

            // Apply filters when they change
            useEffect(() => {
                applyFilters();
            }, [entities, filters]);

            const loadEntities = async () => {
                setLoading(true);
                setError('');
                try {
                    const data = await callGoogleScript('getAllEntities');
                    if (data && Array.isArray(data)) {
                        setEntities(data);
                        currentEntities = data;
                    } else {
                        setError('No entity data available');
                    }
                } catch (err) {
                    console.error('Error loading entities:', err);
                    setError('Failed to load entity data: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const applyFilters = () => {
                let filtered = [...entities];

                // Type filter
                if (filters.type) {
                    filtered = filtered.filter(entity => 
                        entity.type && entity.type.toLowerCase().includes(filters.type.toLowerCase())
                    );
                }

                // Search filter
                if (filters.search) {
                    filtered = filtered.filter(entity =>
                        entity.name && entity.name.toLowerCase().includes(filters.search.toLowerCase())
                    );
                }

                // Obligation range filters
                if (filters.minObligation) {
                    const min = parseFloat(filters.minObligation);
                    filtered = filtered.filter(entity => 
                        entity.totalObligations && entity.totalObligations >= min
                    );
                }

                if (filters.maxObligation) {
                    const max = parseFloat(filters.maxObligation);
                    filtered = filtered.filter(entity => 
                        entity.totalObligations && entity.totalObligations <= max
                    );
                }

                setFilteredEntities(filtered);
            };

            const updateFilter = (key, value) => {
                setFilters(prev => ({ ...prev, [key]: value }));
            };

            const openEntityDetail = (entityIndex) => {
                const entity = filteredEntities[entityIndex];
                if (!entity) return;

                // Import and use the entity detail modal
                showEntityDetail(entity, entityIndex);
            };

            return (
                <>
                    {/* Control Panel */}
                    <div className="control-panel">
                        <div className="control-row">
                            <div className="control-group">
                                <label className="control-label">Entity Type</label>
                                <select 
                                    className="control-input"
                                    value={filters.type}
                                    onChange={(e) => updateFilter('type', e.target.value)}
                                >
                                    <option value="">All Types</option>
                                    <option value="agency">Agency</option>
                                    <option value="oem">OEM</option>
                                    <option value="vendor">Vendor</option>
                                </select>
                            </div>

                            <div className="control-group">
                                <label className="control-label">Search</label>
                                <input 
                                    type="text"
                                    className="control-input"
                                    placeholder="Search entities..."
                                    value={filters.search}
                                    onChange={(e) => updateFilter('search', e.target.value)}
                                />
                            </div>

                            <div className="control-group">
                                <label className="control-label">Min Obligation ($M)</label>
                                <input 
                                    type="number"
                                    className="control-input"
                                    placeholder="0"
                                    value={filters.minObligation}
                                    onChange={(e) => updateFilter('minObligation', e.target.value)}
                                />
                            </div>

                            <div className="control-group">
                                <label className="control-label">Max Obligation ($M)</label>
                                <input 
                                    type="number"
                                    className="control-input"
                                    placeholder="1000"
                                    value={filters.maxObligation}
                                    onChange={(e) => updateFilter('maxObligation', e.target.value)}
                                />
                            </div>

                            <button className="btn btn-primary" onClick={loadEntities}>
                                üîÑ Refresh Data
                            </button>
                        </div>
                    </div>

                    {/* Entities Section */}
                    <div className="entities-container">
                        <div className="entities-header">
                            <h2 className="entities-title">Government Technology Entities</h2>
                            <div className="entities-count">
                                Showing {filteredEntities.length} of {entities.length} entities
                            </div>
                        </div>

                        {loading && (
                            <div className="loading">
                                ‚è≥ Loading entities...
                            </div>
                        )}

                        {error && (
                            <div className="error">
                                {error}
                            </div>
                        )}

                        {!loading && !error && (
                            <div className="entities-grid">
                                {filteredEntities.map((entity, index) => (
                                    <div 
                                        key={entity.name || index}
                                        className="entity-card"
                                        onClick={() => openEntityDetail(index)}
                                    >
                                        <div className="entity-name">{entity.name || 'Unknown Entity'}</div>
                                        <div className="entity-type">
                                            {entity.type?.toUpperCase() || 'ENTITY'}
                                        </div>
                                        
                                        <div className="entity-stats">
                                            <div className="stat">
                                                <div className="stat-value">
                                                    {formatCurrencyShort(entity.totalObligations || 0)}
                                                </div>
                                                <div className="stat-label">Total Obligations</div>
                                            </div>
                                            <div className="stat">
                                                <div className="stat-value">
                                                    {entity.contractCount || 0}
                                                </div>
                                                <div className="stat-label">Contracts</div>
                                            </div>
                                        </div>
                                        
                                        {entity.tier && (
                                            <div style={{ 
                                                marginTop: '0.5rem', 
                                                padding: '0.25rem 0.5rem', 
                                                background: 'var(--green)', 
                                                color: 'white', 
                                                borderRadius: '4px', 
                                                fontSize: '0.8rem', 
                                                textAlign: 'center',
                                                fontWeight: '600'
                                            }}>
                                                {entity.tier}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {!loading && !error && filteredEntities.length === 0 && (
                            <div className="loading">
                                No entities found matching your criteria
                            </div>
                        )}
                    </div>
                </>
            );
        };

        // Utility function for API calls
        const callGoogleScript = (functionName, ...params) => {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    [functionName](...params);
            });
        };

        // Open report builder function
        const openReportBuilder = () => {
            try {
                google.script.run
                    .withSuccessHandler((url) => {
                        if (url) {
                            window.location.href = url;
                        } else {
                            console.error('Failed to get Report Builder URL');
                            alert('Unable to open Report Builder. Please try again.');
                        }
                    })
                    .withFailureHandler((error) => {
                        console.error('Error opening Report Builder:', error);
                        alert('Error opening Report Builder: ' + error.message);
                    })
                    .getReportBuilderUrl();
            } catch (error) {
                console.error('Error in openReportBuilder:', error);
                alert('Error opening Report Builder. Please try again.');
            }
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('dashboardApp'));
        root.render(<DashboardApp />);
    </script>

    <!-- Include shared utilities and entity detail modal -->
    <script src="B01_sharedUtils.js"></script>
    <script src="B02_dataProcessors.js"></script>
    <script src="B03_chartHelpers.js"></script>
    <script src="B04_entityDetailBackend.js"></script>
    <script src="B11_ProcurementTables.js"></script>
    <script src="F02_EntityDetail.html"></script>
</body>
</html>